/**
 * Genera información del build para mostrar en el footer
 * Se ejecuta automáticamente antes de cada build (prebuild script)
 */

const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

// Obtener información del git
let gitCommit = 'unknown';
let gitBranch = 'unknown';

try {
  gitCommit = execSync('git rev-parse --short HEAD').toString().trim();
  gitBranch = execSync('git rev-parse --abbrev-ref HEAD').toString().trim();
} catch (e) {
  console.warn('No se pudo obtener información de git:', e.message);
}

// Obtener versión del package.json
const packageJson = require('../package.json');
const version = packageJson.version;

// Fecha y hora del build en formato legible (timezone de México)
const buildDate = new Date().toLocaleString('es-MX', {
  timeZone: 'America/Mexico_City',
  year: 'numeric',
  month: '2-digit',
  day: '2-digit',
  hour: '2-digit',
  minute: '2-digit',
  second: '2-digit',
  hour12: false
});

// También formato ISO para comparación
const buildTimestamp = new Date().toISOString();

// Contenido del archivo .env.local (se sobrescribe en cada build)
const envContent = `# Auto-generated by prebuild script - DO NOT EDIT MANUALLY
# Generated at: ${buildDate}

REACT_APP_VERSION=${version}
REACT_APP_BUILD_DATE=${buildDate}
REACT_APP_BUILD_TIMESTAMP=${buildTimestamp}
REACT_APP_GIT_COMMIT=${gitCommit}
REACT_APP_GIT_BRANCH=${gitBranch}
`;

// Escribir archivo
const envPath = path.join(__dirname, '..', '.env.local');
fs.writeFileSync(envPath, envContent);

console.log('✅ Build info generated:');
console.log(`   Version: ${version}`);
console.log(`   Build Date: ${buildDate}`);
console.log(`   Git Commit: ${gitCommit}`);
console.log(`   Git Branch: ${gitBranch}`);
