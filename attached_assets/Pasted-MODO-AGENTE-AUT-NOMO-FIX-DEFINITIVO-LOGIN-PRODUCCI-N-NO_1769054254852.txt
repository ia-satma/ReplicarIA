MODO AGENTE AUTÃ“NOMO - FIX DEFINITIVO LOGIN PRODUCCIÃ“N

NO PREGUNTAR. NO EXPLICAR. SOLO EJECUTAR.

<TOON>

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PROBLEMA: BD PRODUCCIÃ“N VACÃA - USUARIOS NO EXISTEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

EJECUTAR TODO EN ORDEN. NO SALTAR PASOS.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PASO 1: CREAR SCRIPT DE SEED FORZADO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Crear archivo: server/scripts/forceSeed.ts

```typescript
import { Pool } from 'pg';
import bcrypt from 'bcryptjs';

const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false
});

async function forceSeed() {
  console.log('ğŸš€ FORZANDO SEED DE USUARIOS EN PRODUCCIÃ“N...');
  
  const client = await pool.connect();
  
  try {
    // 1. Crear tabla usuarios si no existe
    await client.query(`
      CREATE TABLE IF NOT EXISTS usuarios (
        id SERIAL PRIMARY KEY,
        email VARCHAR(255) UNIQUE NOT NULL,
        nombre VARCHAR(255),
        password_hash VARCHAR(255),
        rol VARCHAR(50) DEFAULT 'usuario',
        empresa_id INTEGER,
        activo BOOLEAN DEFAULT TRUE,
        created_at TIMESTAMP DEFAULT NOW(),
        updated_at TIMESTAMP DEFAULT NOW()
      )
    `);
    console.log('âœ… Tabla usuarios verificada');

    // 2. Crear tabla cÃ³digos OTP si no existe
    await client.query(`
      CREATE TABLE IF NOT EXISTS codigos_acceso (
        id SERIAL PRIMARY KEY,
        usuario_id INTEGER REFERENCES usuarios(id) ON DELETE CASCADE,
        codigo VARCHAR(6) NOT NULL,
        expira_en TIMESTAMP NOT NULL,
        usado BOOLEAN DEFAULT FALSE,
        created_at TIMESTAMP DEFAULT NOW(),
        UNIQUE(usuario_id)
      )
    `);
    console.log('âœ… Tabla codigos_acceso verificada');

    // 3. Hash de contraseÃ±a para admin
    const passwordAdmin = 'Admin2024!';
    const hashAdmin = await bcrypt.hash(passwordAdmin, 10);

    // 4. FORZAR creaciÃ³n de usuarios - BORRAR Y RECREAR
    await client.query(`DELETE FROM codigos_acceso`);
    await client.query(`DELETE FROM usuarios WHERE email IN ('santiago@satma.mx', 'demo@revisar-ia.com')`);
    
    // Insertar admin
    await client.query(`
      INSERT INTO usuarios (email, nombre, password_hash, rol, activo)
      VALUES ($1, $2, $3, $4, TRUE)
    `, ['santiago@satma.mx', 'Santiago Admin', hashAdmin, 'admin']);
    console.log('âœ… Admin santiago@satma.mx creado con contraseÃ±a: Admin2024!');

    // Insertar demo
    await client.query(`
      INSERT INTO usuarios (email, nombre, rol, activo)
      VALUES ($1, $2, $3, TRUE)
    `, ['demo@revisar-ia.com', 'Usuario Demo', 'usuario']);
    console.log('âœ… Usuario demo@revisar-ia.com creado');

    // 5. Verificar
    const check = await client.query(`SELECT id, email, rol, password_hash IS NOT NULL as tiene_password FROM usuarios`);
    console.log('ğŸ“‹ Usuarios en BD:', check.rows);

    console.log('\nâœ…âœ…âœ… SEED COMPLETADO EXITOSAMENTE âœ…âœ…âœ…');
    console.log('Admin: santiago@satma.mx / Admin2024!');
    
  } catch (error) {
    console.error('âŒ ERROR EN SEED:', error);
    throw error;
  } finally {
    client.release();
  }
}

forceSeed().then(() => process.exit(0)).catch(() => process.exit(1));
```

â–¡ Archivo forceSeed.ts creado

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PASO 2: AGREGAR SCRIPT A PACKAGE.JSON
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

En package.json (raÃ­z), agregar en scripts:

```json
{
  "scripts": {
    "seed:force": "npx ts-node server/scripts/forceSeed.ts",
    "seed:prod": "NODE_ENV=production npx ts-node server/scripts/forceSeed.ts"
  }
}
```

â–¡ Scripts agregados a package.json

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PASO 3: MODIFICAR BUILD PARA EJECUTAR SEED AUTOMÃTICO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Modificar .replit - el build DEBE ejecutar el seed:

```toml
[deployment]
build = ["sh", "-c", "cd frontend && npm install && CRACO_CONFIG_PATH=./craco.config.js npx craco build && cd .. && npx ts-node server/scripts/forceSeed.ts"]
run = ["sh", "-c", "npm start"]
```

â–¡ .replit modificado para ejecutar seed en build

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PASO 4: VERIFICAR ENDPOINT DE LOGIN ADMIN USA BCRYPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Buscar y modificar el endpoint de login admin. Debe verse asÃ­:

```typescript
// server/routes/auth.ts o donde estÃ© el login

import bcrypt from 'bcryptjs';

router.post('/admin/login', async (req, res) => {
  try {
    const { email, password } = req.body;

    if (!email || !password) {
      return res.status(400).json({ error: 'Email y contraseÃ±a requeridos' });
    }

    const result = await db.query(
      'SELECT id, email, nombre, password_hash, rol FROM usuarios WHERE email = $1 AND rol = $2 AND activo = TRUE',
      [email.toLowerCase(), 'admin']
    );

    if (result.rows.length === 0) {
      console.log('âŒ Admin no encontrado:', email);
      return res.status(401).json({ error: 'Email o contraseÃ±a incorrectos' });
    }

    const user = result.rows[0];

    if (!user.password_hash) {
      console.log('âŒ Admin sin contraseÃ±a:', email);
      return res.status(401).json({ error: 'Email o contraseÃ±a incorrectos' });
    }

    const validPassword = await bcrypt.compare(password, user.password_hash);

    if (!validPassword) {
      console.log('âŒ ContraseÃ±a incorrecta para:', email);
      return res.status(401).json({ error: 'Email o contraseÃ±a incorrectos' });
    }

    // Generar token JWT o sesiÃ³n
    const token = jwt.sign(
      { userId: user.id, email: user.email, rol: user.rol },
      process.env.JWT_SECRET || 'secret-key-change-in-production',
      { expiresIn: '24h' }
    );

    console.log('âœ… Login exitoso:', email);
    
    res.json({
      success: true,
      token,
      user: {
        id: user.id,
        email: user.email,
        nombre: user.nombre,
        rol: user.rol
      }
    });

  } catch (error) {
    console.error('Error en login admin:', error);
    res.status(500).json({ error: 'Error interno del servidor' });
  }
});
```

â–¡ Endpoint /admin/login usa bcrypt.compare correctamente

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PASO 5: VERIFICAR ENDPOINT OTP USA LA BD CORRECTA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

```typescript
// Endpoint OTP request
router.post('/otp/request-code', async (req, res) => {
  try {
    const { email } = req.body;
    
    // Buscar usuario
    const userResult = await db.query(
      'SELECT id, email, nombre FROM usuarios WHERE email = $1 AND activo = TRUE',
      [email.toLowerCase()]
    );

    if (userResult.rows.length === 0) {
      console.log('âŒ Usuario no encontrado para OTP:', email);
      return res.status(404).json({ error: 'Usuario no encontrado' });
    }

    const user = userResult.rows[0];

    // Generar cÃ³digo 6 dÃ­gitos
    const codigo = Math.floor(100000 + Math.random() * 900000).toString();
    const expiraEn = new Date(Date.now() + 10 * 60 * 1000); // 10 min

    // Guardar/actualizar cÃ³digo
    await db.query(`
      INSERT INTO codigos_acceso (usuario_id, codigo, expira_en, usado)
      VALUES ($1, $2, $3, FALSE)
      ON CONFLICT (usuario_id) 
      DO UPDATE SET codigo = $2, expira_en = $3, usado = FALSE
    `, [user.id, codigo, expiraEn]);

    // Enviar email
    console.log(`ğŸ“§ CÃ³digo OTP para ${email}: ${codigo}`);
    
    // AquÃ­ va el envÃ­o real de email...
    // await sendEmail(email, codigo);

    res.json({ success: true, message: 'CÃ³digo enviado' });

  } catch (error) {
    console.error('Error en OTP request:', error);
    res.status(500).json({ error: 'Error de conexion. Intenta de nuevo.' });
  }
});
```

â–¡ Endpoint OTP verificado

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PASO 6: INSTALAR DEPENDENCIAS SI FALTAN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

```bash
npm install bcryptjs jsonwebtoken
npm install -D @types/bcryptjs @types/jsonwebtoken
```

â–¡ Dependencias instaladas

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PASO 7: EJECUTAR SEED MANUALMENTE PRIMERO (TEST)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

En Shell de Replit:

```bash
npx ts-node server/scripts/forceSeed.ts
```

Debe mostrar:
âœ… Tabla usuarios verificada
âœ… Admin santiago@satma.mx creado con contraseÃ±a: Admin2024!
âœ… Usuario demo@revisar-ia.com creado

â–¡ Seed ejecutado manualmente con Ã©xito

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PASO 8: DEPLOY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Click en "Redeploy"

El build ahora:
1. Compila frontend
2. Ejecuta seed que crea usuarios en BD producciÃ³n
3. Arranca servidor

â–¡ Deploy ejecutado

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
CREDENCIALES FINALES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ADMIN:
- Email: santiago@satma.mx
- ContraseÃ±a: Admin2024!

USUARIO (OTP):
- Email: demo@revisar-ia.com
- CÃ³digo: se envÃ­a por email

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
VERIFICACIÃ“N POST-DEPLOY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Probar en producciÃ³n:

1. Ir a https://tu-app.replit.app
2. Click "Eres administrador? Inicia sesion con contraseÃ±a"
3. Email: santiago@satma.mx
4. ContraseÃ±a: Admin2024!
5. DEBE entrar al dashboard

â–¡ Login admin funciona en producciÃ³n
â–¡ Login OTP funciona en producciÃ³n

</TOON>

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EJECUTAR TODO. NO PREGUNTAR. NO DETENERSE.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•