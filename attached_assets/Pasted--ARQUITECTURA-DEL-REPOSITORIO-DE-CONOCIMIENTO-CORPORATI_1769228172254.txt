# ARQUITECTURA DEL REPOSITORIO DE CONOCIMIENTO CORPORATIVO - REVISAR.IA

## Sistema de GestiÃ³n del Conocimiento con Agentes de Ingesta, ClasificaciÃ³n y RAG

---

## RESUMEN EJECUTIVO

RediseÃ±o completo de la secciÃ³n "Repositorio" de Revisar.IA: de interfaz chat inoperativa a sistema tipo "disco duro corporativo" con jerarquÃ­a de carpetas, agentes especializados de ingesta/clasificaciÃ³n, sincronizaciÃ³n automÃ¡tica a bases de conocimiento por agente (pcloud), e integraciÃ³n RAG para retrieval semÃ¡ntico. El sistema permite subir documentos empresariales (polÃ­ticas, manuales, planeaciÃ³n estratÃ©gica) que alimentan automÃ¡ticamente a todos los agentes de la plataforma con contexto relevante y trazable.

---

## DIAGRAMA ARQUITECTÃ“NICO

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            REVISAR.IA - KNOWLEDGE MANAGEMENT SYSTEM                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚   USUARIOS       â”‚
                                    â”‚  (Admin/Upload)  â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    CAPA DE INTERFAZ                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  File Explorer UI   â”‚  â”‚   Drag & Drop Zone  â”‚  â”‚   API REST /api/knowledge/*     â”‚  â”‚
â”‚  â”‚  (Tipo Google Drive)â”‚  â”‚   (Bulk Upload)     â”‚  â”‚   POST /ingest, GET /browse     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              CAPA DE ORQUESTACIÃ“N DE AGENTES                             â”‚
â”‚                                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚  ğŸ¤– AGENTE DE     â”‚â”€â”€â”€â–¶â”‚  ğŸ¤– AGENTE DE     â”‚â”€â”€â”€â–¶â”‚  ğŸ¤– AGENTE DE     â”‚                â”‚
â”‚  â”‚     INGESTA       â”‚    â”‚   CLASIFICACIÃ“N   â”‚    â”‚   PCLOUD SYNC     â”‚                â”‚
â”‚  â”‚                   â”‚    â”‚                   â”‚    â”‚                   â”‚                â”‚
â”‚  â”‚ - Detecta archivosâ”‚    â”‚ - Asigna categorÃ­aâ”‚    â”‚ - Distribuye a KB â”‚                â”‚
â”‚  â”‚ - OCR/ExtracciÃ³n  â”‚    â”‚ - Asigna permisos â”‚    â”‚   de cada agente  â”‚                â”‚
â”‚  â”‚ - Normaliza       â”‚    â”‚ - Tags automÃ¡ticosâ”‚    â”‚ - Sincroniza refs â”‚                â”‚
â”‚  â”‚ - Valida formato  â”‚    â”‚ - Nivel confid.   â”‚    â”‚ - Versiona        â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚           â”‚                        â”‚                        â”‚                           â”‚
â”‚           â”‚                        â–¼                        â”‚                           â”‚
â”‚           â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚                           â”‚
â”‚           â”‚               â”‚  ğŸ¤– SUBAGENTE     â”‚             â”‚                           â”‚
â”‚           â”‚               â”‚  REVISIÃ“N HUMANA  â”‚             â”‚                           â”‚
â”‚           â”‚               â”‚  (Fallback Queue) â”‚             â”‚                           â”‚
â”‚           â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚                           â”‚
â”‚           â”‚                                                 â”‚                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                                                 â”‚
            â–¼                                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                 CAPA DE ALMACENAMIENTO                                   â”‚
â”‚                                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                        ğŸ“ REPOSITORIO PRINCIPAL                                  â”‚    â”‚
â”‚  â”‚                        (Disco Duro Corporativo)                                  â”‚    â”‚
â”‚  â”‚                                                                                  â”‚    â”‚
â”‚  â”‚   /empresa                                                                       â”‚    â”‚
â”‚  â”‚   â”œâ”€â”€ /informacion_general                                                       â”‚    â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ /acta_constitutiva                                                     â”‚    â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ /organigrama                                                           â”‚    â”‚
â”‚  â”‚   â”‚   â””â”€â”€ /directorio                                                            â”‚    â”‚
â”‚  â”‚   â”œâ”€â”€ /planeacion_estrategica                                                    â”‚    â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ /plan_anual_{aÃ±o}                                                      â”‚    â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ /objetivos_kpis                                                        â”‚    â”‚
â”‚  â”‚   â”‚   â””â”€â”€ /proyectos_especiales                                                  â”‚    â”‚
â”‚  â”‚   â”œâ”€â”€ /politicas_y_manuales                                                      â”‚    â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ /politicas_fiscales                                                    â”‚    â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ /manuales_operativos                                                   â”‚    â”‚
â”‚  â”‚   â”‚   â””â”€â”€ /procedimientos                                                        â”‚    â”‚
â”‚  â”‚   â”œâ”€â”€ /fiscal                                                                    â”‚    â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ /declaraciones                                                         â”‚    â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ /dictamenes                                                            â”‚    â”‚
â”‚  â”‚   â”‚   â””â”€â”€ /criterios_sat                                                         â”‚    â”‚
â”‚  â”‚   â”œâ”€â”€ /legal                                                                     â”‚    â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ /contratos_modelo                                                      â”‚    â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ /jurisprudencia                                                        â”‚    â”‚
â”‚  â”‚   â”‚   â””â”€â”€ /normatividad                                                          â”‚    â”‚
â”‚  â”‚   â”œâ”€â”€ /financiero                                                                â”‚    â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ /estados_financieros                                                   â”‚    â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ /presupuestos                                                          â”‚    â”‚
â”‚  â”‚   â”‚   â””â”€â”€ /reportes                                                              â”‚    â”‚
â”‚  â”‚   â””â”€â”€ /proveedores                                                               â”‚    â”‚
â”‚  â”‚       â”œâ”€â”€ /catalogo_proveedores                                                  â”‚    â”‚
â”‚  â”‚       â”œâ”€â”€ /contratos_vigentes                                                    â”‚    â”‚
â”‚  â”‚       â””â”€â”€ /evaluaciones                                                          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                        â˜ï¸ PCLOUD POR AGENTE (KB EspecÃ­fica)                      â”‚    â”‚
â”‚  â”‚                                                                                  â”‚    â”‚
â”‚  â”‚   /pcloud                                                                        â”‚    â”‚
â”‚  â”‚   â”œâ”€â”€ /A1_sponsor          â†’ PlaneaciÃ³n, objetivos, governance                   â”‚    â”‚
â”‚  â”‚   â”œâ”€â”€ /A2_pmo              â†’ Procedimientos, cronogramas, recursos               â”‚    â”‚
â”‚  â”‚   â”œâ”€â”€ /A3_fiscal           â†’ Normatividad fiscal, criterios SAT, LISR            â”‚    â”‚
â”‚  â”‚   â”œâ”€â”€ /A4_legal            â†’ Contratos, jurisprudencia, normativas               â”‚    â”‚
â”‚  â”‚   â”œâ”€â”€ /A5_finanzas         â†’ Estados financieros, presupuestos, mÃ©tricas         â”‚    â”‚
â”‚  â”‚   â”œâ”€â”€ /A6_proveedor        â†’ CatÃ¡logo proveedores, evaluaciones, EFOS            â”‚    â”‚
â”‚  â”‚   â””â”€â”€ /A7_defense_file     â†’ Templates, evidencias modelo, casos previos         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                   CAPA DE INDEXACIÃ“N                                     â”‚
â”‚                                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   ğŸ” VECTOR DATABASE    â”‚  â”‚   ğŸ“Š METADATA INDEX     â”‚  â”‚   ğŸ“ FULL-TEXT SEARCH   â”‚  â”‚
â”‚  â”‚      (Pinecone/Milvus)  â”‚  â”‚     (PostgreSQL JSONB)  â”‚  â”‚     (pg_trgm + tsvector)â”‚  â”‚
â”‚  â”‚                         â”‚  â”‚                         â”‚  â”‚                         â”‚  â”‚
â”‚  â”‚  - Embeddings 1536d     â”‚  â”‚  - Filtros estructuradosâ”‚  â”‚  - BÃºsqueda por texto   â”‚  â”‚
â”‚  â”‚  - Chunks de 512 tokens â”‚  â”‚  - Queries complejas    â”‚  â”‚  - Autocompletado       â”‚  â”‚
â”‚  â”‚  - Similarity search    â”‚  â”‚  - AuditorÃ­a            â”‚  â”‚  - Highlighting         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                             â”‚                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
                                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                   CAPA RAG (RETRIEVAL)                                   â”‚
â”‚                                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                           ğŸ¤– AGENTE RAG                                            â”‚  â”‚
â”‚  â”‚                                                                                    â”‚  â”‚
â”‚  â”‚   Query â†’ Embedding â†’ Vector Search â†’ Re-ranking â†’ Context Assembly â†’ LLM Call    â”‚  â”‚
â”‚  â”‚                                                                                    â”‚  â”‚
â”‚  â”‚   1. Recibe query del agente solicitante (A1-A7)                                   â”‚  â”‚
â”‚  â”‚   2. Genera embedding con text-embedding-3-small                                   â”‚  â”‚
â”‚  â”‚   3. Busca top-k chunks relevantes en Vector DB                                    â”‚  â”‚
â”‚  â”‚   4. Aplica re-ranking con cross-encoder                                           â”‚  â”‚
â”‚  â”‚   5. Ensambla contexto con metadatos y fuentes                                     â”‚  â”‚
â”‚  â”‚   6. Retorna contexto augmentado + citations                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## LISTA DE COMPONENTES Y RESPONSABILIDADES

| Componente | Tipo | PropÃ³sito | Owner | Responsable Operativo | Entradas | Salidas | SLA |
|------------|------|-----------|-------|----------------------|----------|---------|-----|
| **File Explorer UI** | Frontend | Interfaz visual tipo Google Drive para navegar, subir y gestionar archivos | Equipo Frontend | Desarrollador Frontend | Acciones del usuario | Requests a API | 99.5% uptime |
| **API Knowledge** | Backend | Endpoints REST para operaciones CRUD sobre repositorio | Equipo Backend | Ingeniero Backend | HTTP Requests | JSON Responses | < 200ms p95 |
| **Agente de Ingesta** | Agente IA | Detectar, extraer texto, normalizar y validar documentos nuevos | Equipo de Datos | Ingeniero de Datos | Archivos crudos | Documentos normalizados | < 30s por documento |
| **Agente de ClasificaciÃ³n** | Agente IA | Asignar categorÃ­a, tags, nivel de confidencialidad y permisos | Equipo de Datos | Especialista de Dominio | Documentos normalizados | Documentos clasificados | 95% precisiÃ³n |
| **Agente Pcloud Sync** | Agente IA | Distribuir referencias a KB de cada agente segÃºn relevancia | Equipo de Datos | Ingeniero de Datos | Documentos clasificados | Referencias en pcloud | < 5s sync |
| **Subagente RevisiÃ³n Humana** | Subagente | Cola de documentos que requieren clasificaciÃ³n manual | Equipo Ops | Analista de Calidad | Docs con baja confianza | Docs validados | < 24h resoluciÃ³n |
| **Subagente ResÃºmenes** | Subagente | Generar resÃºmenes automÃ¡ticos de documentos largos | Equipo de Datos | Ingeniero ML | Documentos > 10 pÃ¡ginas | ResÃºmenes + highlights | < 60s |
| **Vector Database** | Infraestructura | Almacenar y buscar embeddings para RAG | Equipo Infra | SRE | Embeddings 1536d | Similarity results | < 100ms query |
| **Metadata Index** | Infraestructura | Ãndice estructurado para filtros y auditorÃ­a | Equipo Infra | DBA | Metadatos JSON | Query results | < 50ms query |
| **Agente RAG** | Agente IA | Retrieval semÃ¡ntico con re-ranking para augmentar prompts | Equipo ML | Ingeniero ML | Queries de agentes | Contexto + citations | < 2s e2e |
| **Storage (S3/MinIO)** | Infraestructura | Almacenamiento de archivos binarios | Equipo Infra | SRE | Archivos | URLs firmadas | 99.99% durability |

---

## ESPECIFICACIÃ“N TÃ‰CNICA

### 1. Estructura del Repositorio y ConvenciÃ³n de Nombres

```
/knowledge
â”œâ”€â”€ /empresa_{empresa_id}
â”‚   â”œâ”€â”€ /informacion_general
â”‚   â”‚   â”œâ”€â”€ /acta_constitutiva
â”‚   â”‚   â”‚   â””â”€â”€ acta_constitutiva_empresa_v1.pdf
â”‚   â”‚   â”œâ”€â”€ /organigrama
â”‚   â”‚   â”‚   â””â”€â”€ organigrama_2024_v2.pdf
â”‚   â”‚   â””â”€â”€ /directorio
â”‚   â”‚       â””â”€â”€ directorio_corporativo_2024.xlsx
â”‚   â”‚
â”‚   â”œâ”€â”€ /planeacion_estrategica
â”‚   â”‚   â”œâ”€â”€ /plan_anual_2024
â”‚   â”‚   â”‚   â”œâ”€â”€ plan_estrategico_2024_v1.pptx
â”‚   â”‚   â”‚   â””â”€â”€ objetivos_q1_q4_2024.xlsx
â”‚   â”‚   â””â”€â”€ /objetivos_kpis
â”‚   â”‚       â””â”€â”€ kpis_por_area_2024.xlsx
â”‚   â”‚
â”‚   â”œâ”€â”€ /politicas_y_manuales
â”‚   â”‚   â”œâ”€â”€ /politicas_fiscales
â”‚   â”‚   â”‚   â”œâ”€â”€ politica_deduccion_intangibles_v3.docx
â”‚   â”‚   â”‚   â””â”€â”€ criterios_internos_sat_2024.pdf
â”‚   â”‚   â”œâ”€â”€ /manuales_operativos
â”‚   â”‚   â”‚   â””â”€â”€ manual_proceso_auditoria_v2.docx
â”‚   â”‚   â””â”€â”€ /procedimientos
â”‚   â”‚       â””â”€â”€ procedimiento_alta_proveedores.docx
â”‚   â”‚
â”‚   â”œâ”€â”€ /fiscal
â”‚   â”‚   â”œâ”€â”€ /declaraciones
â”‚   â”‚   â”‚   â””â”€â”€ declaracion_anual_2023.pdf
â”‚   â”‚   â”œâ”€â”€ /dictamenes
â”‚   â”‚   â”‚   â””â”€â”€ dictamen_fiscal_2023.pdf
â”‚   â”‚   â””â”€â”€ /criterios_sat
â”‚   â”‚       â””â”€â”€ criterios_no_vinculativos_2024.pdf
â”‚   â”‚
â”‚   â”œâ”€â”€ /legal
â”‚   â”‚   â”œâ”€â”€ /contratos_modelo
â”‚   â”‚   â”‚   â””â”€â”€ contrato_servicios_intangibles_template.docx
â”‚   â”‚   â”œâ”€â”€ /jurisprudencia
â”‚   â”‚   â”‚   â””â”€â”€ tesis_aisladas_intangibles_2020_2024.pdf
â”‚   â”‚   â””â”€â”€ /normatividad
â”‚   â”‚       â””â”€â”€ cff_2024_actualizado.pdf
â”‚   â”‚
â”‚   â”œâ”€â”€ /financiero
â”‚   â”‚   â”œâ”€â”€ /estados_financieros
â”‚   â”‚   â”‚   â””â”€â”€ edo_financiero_dic_2023.xlsx
â”‚   â”‚   â””â”€â”€ /presupuestos
â”‚   â”‚       â””â”€â”€ presupuesto_2024.xlsx
â”‚   â”‚
â”‚   â””â”€â”€ /proveedores
â”‚       â”œâ”€â”€ /catalogo_proveedores
â”‚       â”‚   â””â”€â”€ catalogo_proveedores_activos.xlsx
â”‚       â””â”€â”€ /evaluaciones
â”‚           â””â”€â”€ evaluacion_proveedor_xyz_2024.pdf
â”‚
â””â”€â”€ /pcloud
    â”œâ”€â”€ /A1_sponsor
    â”‚   â”œâ”€â”€ _manifest.json
    â”‚   â””â”€â”€ refs/
    â”‚       â”œâ”€â”€ ref_plan_estrategico_2024.json
    â”‚       â””â”€â”€ ref_objetivos_kpis.json
    â”‚
    â”œâ”€â”€ /A3_fiscal
    â”‚   â”œâ”€â”€ _manifest.json
    â”‚   â””â”€â”€ refs/
    â”‚       â”œâ”€â”€ ref_politica_deduccion_intangibles.json
    â”‚       â”œâ”€â”€ ref_criterios_sat_2024.json
    â”‚       â””â”€â”€ ref_cff_2024.json
    â”‚
    â”œâ”€â”€ /A4_legal
    â”‚   â”œâ”€â”€ _manifest.json
    â”‚   â””â”€â”€ refs/
    â”‚       â”œâ”€â”€ ref_contratos_modelo.json
    â”‚       â””â”€â”€ ref_jurisprudencia_intangibles.json
    â”‚
    â”œâ”€â”€ /A5_finanzas
    â”‚   â”œâ”€â”€ _manifest.json
    â”‚   â””â”€â”€ refs/
    â”‚       â””â”€â”€ ref_estados_financieros.json
    â”‚
    â””â”€â”€ /A6_proveedor
        â”œâ”€â”€ _manifest.json
        â””â”€â”€ refs/
            â”œâ”€â”€ ref_catalogo_proveedores.json
            â””â”€â”€ ref_evaluaciones.json
```

**ConvenciÃ³n de nombres:**
```
{tipo_documento}_{descriptor}_{fecha|version}.{extension}

Ejemplos:
- politica_deduccion_intangibles_v3.docx
- contrato_servicios_proveedor_abc_20240115.pdf
- estado_financiero_dic_2023_auditado.xlsx
- manual_auditoria_fiscal_v2.1.docx
```

---

### 2. Esquema de Metadatos

```json
{
  "$schema": "https://revisar.ia/schemas/document-metadata-v1.json",
  "id": "doc_7f3a9b2c-4e5d-4a1b-8c9d-0e1f2a3b4c5d",
  "titulo": "PolÃ­tica de DeducciÃ³n de Intangibles",
  "titulo_normalizado": "politica_deduccion_intangibles",
  "tipo_documento": "politica",
  "categoria_principal": "politicas_y_manuales",
  "subcategoria": "politicas_fiscales",
  "formato": "docx",
  "tamaÃ±o_bytes": 245760,
  "idioma": "es",
  "origen": {
    "tipo": "upload_manual",
    "usuario_id": "usr_abc123",
    "fecha_upload": "2024-01-15T10:30:00Z",
    "ip_origen": "192.168.1.100"
  },
  "propietario_organico": {
    "area": "Fiscal",
    "responsable": "Juan PÃ©rez",
    "email": "juan.perez@empresa.com"
  },
  "tags": [
    "deduccion",
    "intangibles",
    "art_27_lisr",
    "politica_interna",
    "fiscal"
  ],
  "entidades_extraidas": [
    {"tipo": "ley", "valor": "LISR Art. 27"},
    {"tipo": "ley", "valor": "CFF Art. 5-A"},
    {"tipo": "concepto", "valor": "razÃ³n de negocios"},
    {"tipo": "concepto", "valor": "beneficio econÃ³mico"}
  ],
  "nivel_confidencialidad": "interno",
  "clasificacion_acceso": {
    "roles_permitidos": ["admin", "fiscal", "legal"],
    "agentes_permitidos": ["A1", "A3", "A4", "A7"]
  },
  "fechas": {
    "creacion": "2024-01-10T00:00:00Z",
    "modificacion": "2024-01-15T10:30:00Z",
    "revision_proxima": "2025-01-10T00:00:00Z",
    "expiracion": null,
    "ttl_dias": 365
  },
  "versionado": {
    "version_actual": "3.0",
    "versiones_anteriores": [
      {"version": "2.0", "fecha": "2023-06-01", "archivo_id": "doc_old_v2"},
      {"version": "1.0", "fecha": "2022-01-15", "archivo_id": "doc_old_v1"}
    ],
    "politica_retencion": "1_year"
  },
  "integridad": {
    "checksum_sha256": "a3f2b8c9d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1",
    "verificado": true,
    "fecha_verificacion": "2024-01-15T10:31:00Z"
  },
  "rutas": {
    "repositorio": "/knowledge/empresa_123/politicas_y_manuales/politicas_fiscales/politica_deduccion_intangibles_v3.docx",
    "storage_url": "s3://revisar-ia-docs/empresa_123/politicas/doc_7f3a9b2c.docx",
    "storage_url_firmada": null
  },
  "indexacion": {
    "vector_id": "vec_7f3a9b2c-4e5d-4a1b-8c9d-0e1f2a3b4c5d",
    "chunks_count": 12,
    "embedding_model": "text-embedding-3-small",
    "fecha_indexacion": "2024-01-15T10:32:00Z",
    "requiere_reindexado": false
  },
  "pcloud_refs": [
    {"agente": "A3_fiscal", "relevancia": 0.95, "ref_id": "ref_abc123"},
    {"agente": "A4_legal", "relevancia": 0.80, "ref_id": "ref_def456"},
    {"agente": "A7_defense_file", "relevancia": 0.75, "ref_id": "ref_ghi789"}
  ],
  "procesamiento": {
    "status": "completed",
    "pipeline_version": "1.2.0",
    "ocr_aplicado": false,
    "texto_extraido": true,
    "paginas": 15,
    "palabras": 4250,
    "resumen_generado": true,
    "resumen_id": "sum_abc123"
  },
  "auditoria": {
    "creado_por": "sistema",
    "ultima_modificacion_por": "usr_abc123",
    "accesos_count": 45,
    "ultimo_acceso": "2024-01-20T14:22:00Z"
  },
  "flags": {
    "requires_review": false,
    "is_template": false,
    "is_archived": false,
    "is_sensitive": false
  }
}
```

---

### 3. Endpoints API

#### POST /api/knowledge/ingest
Subir y procesar un nuevo documento.

**Request:**
```json
{
  "archivo": "<base64_encoded_file>",
  "nombre_archivo": "politica_deduccion_intangibles_v3.docx",
  "metadata_inicial": {
    "tipo_documento": "politica",
    "categoria_sugerida": "politicas_fiscales",
    "propietario_organico": {
      "area": "Fiscal",
      "responsable": "Juan PÃ©rez"
    },
    "nivel_confidencialidad": "interno",
    "tags_sugeridos": ["deduccion", "intangibles"]
  },
  "opciones": {
    "forzar_ocr": false,
    "generar_resumen": true,
    "clasificacion_automatica": true,
    "notificar_completado": true
  }
}
```

**Response (202 Accepted):**
```json
{
  "success": true,
  "job_id": "job_ingest_abc123",
  "document_id": "doc_7f3a9b2c-4e5d-4a1b-8c9d-0e1f2a3b4c5d",
  "status": "processing",
  "estimated_completion_seconds": 30,
  "tracking_url": "/api/knowledge/jobs/job_ingest_abc123"
}
```

---

#### POST /api/knowledge/reindex
Forzar re-indexaciÃ³n de un documento o conjunto de documentos.

**Request:**
```json
{
  "scope": "document",
  "document_ids": ["doc_7f3a9b2c-4e5d-4a1b-8c9d-0e1f2a3b4c5d"],
  "opciones": {
    "regenerar_embeddings": true,
    "recalcular_relevancia_pcloud": true,
    "actualizar_resumen": false
  }
}
```

**Response (202 Accepted):**
```json
{
  "success": true,
  "job_id": "job_reindex_def456",
  "documents_queued": 1,
  "estimated_completion_seconds": 15,
  "tracking_url": "/api/knowledge/jobs/job_reindex_def456"
}
```

---

#### POST /api/knowledge/query_rag
Realizar consulta semÃ¡ntica con RAG.

**Request:**
```json
{
  "query": "Â¿CuÃ¡les son los requisitos para deducir intangibles segÃºn la polÃ­tica interna?",
  "contexto": {
    "agente_solicitante": "A3_fiscal",
    "proyecto_id": "proj_xyz789",
    "empresa_id": "empresa_123"
  },
  "opciones": {
    "top_k": 5,
    "min_similarity": 0.7,
    "incluir_metadata": true,
    "incluir_resumen": true,
    "filtros": {
      "categorias": ["politicas_fiscales", "criterios_sat"],
      "nivel_confidencialidad_max": "interno",
      "fecha_desde": "2023-01-01"
    },
    "reranking": true
  }
}
```

**Response (200 OK):**
```json
{
  "success": true,
  "query_id": "qry_rag_ghi789",
  "results": [
    {
      "rank": 1,
      "document_id": "doc_7f3a9b2c-4e5d-4a1b-8c9d-0e1f2a3b4c5d",
      "titulo": "PolÃ­tica de DeducciÃ³n de Intangibles",
      "chunk_id": "chunk_003",
      "similarity_score": 0.92,
      "rerank_score": 0.95,
      "contenido": "Para la deducciÃ³n de intangibles, se requiere: 1) DocumentaciÃ³n que acredite la razÃ³n de negocios conforme al Art. 5-A del CFF, 2) Evidencia del beneficio econÃ³mico esperado, 3) Comprobantes fiscales vÃ¡lidos del proveedor, 4) Contrato que especifique el objeto y contraprestaciÃ³n...",
      "metadata": {
        "tipo_documento": "politica",
        "fecha_modificacion": "2024-01-15",
        "propietario": "Ãrea Fiscal",
        "pagina": 5
      },
      "citation": {
        "formato": "PolÃ­tica de DeducciÃ³n de Intangibles v3.0, SecciÃ³n 4.2, p.5",
        "url": "/knowledge/view/doc_7f3a9b2c#page=5"
      }
    },
    {
      "rank": 2,
      "document_id": "doc_criterios_sat",
      "titulo": "Criterios SAT 2024 - DeducciÃ³n de Intangibles",
      "chunk_id": "chunk_007",
      "similarity_score": 0.88,
      "rerank_score": 0.89,
      "contenido": "El SAT establece que la deducciÃ³n de pagos por concepto de regalÃ­as y asistencia tÃ©cnica requiere demostrar que el gasto es estrictamente indispensable para los fines de la actividad del contribuyente...",
      "metadata": {
        "tipo_documento": "criterio_fiscal",
        "fecha_modificacion": "2024-02-01",
        "fuente": "SAT"
      },
      "citation": {
        "formato": "Criterios SAT 2024, Criterio 27/ISR/N, p.12",
        "url": "/knowledge/view/doc_criterios_sat#page=12"
      }
    }
  ],
  "context_assembled": {
    "total_tokens": 1250,
    "sources_count": 2,
    "prompt_ready": "## Contexto del Repositorio de Conocimiento\n\n### Fuente 1: PolÃ­tica de DeducciÃ³n de Intangibles v3.0\n...\n\n### Fuente 2: Criterios SAT 2024\n..."
  },
  "metadata_query": {
    "latency_ms": 245,
    "embedding_time_ms": 45,
    "search_time_ms": 120,
    "rerank_time_ms": 80
  }
}
```

---

#### GET /api/knowledge/browse
Navegar el repositorio como sistema de archivos.

**Request:**
```
GET /api/knowledge/browse?path=/empresa_123/politicas_y_manuales&depth=2
```

**Response:**
```json
{
  "success": true,
  "path": "/empresa_123/politicas_y_manuales",
  "items": [
    {
      "tipo": "folder",
      "nombre": "politicas_fiscales",
      "ruta_completa": "/empresa_123/politicas_y_manuales/politicas_fiscales",
      "items_count": 5,
      "ultima_modificacion": "2024-01-15T10:30:00Z"
    },
    {
      "tipo": "folder",
      "nombre": "manuales_operativos",
      "ruta_completa": "/empresa_123/politicas_y_manuales/manuales_operativos",
      "items_count": 3,
      "ultima_modificacion": "2024-01-10T09:00:00Z"
    },
    {
      "tipo": "folder",
      "nombre": "procedimientos",
      "ruta_completa": "/empresa_123/politicas_y_manuales/procedimientos",
      "items_count": 8,
      "ultima_modificacion": "2024-01-12T14:00:00Z"
    }
  ],
  "breadcrumb": [
    {"nombre": "empresa_123", "ruta": "/empresa_123"},
    {"nombre": "politicas_y_manuales", "ruta": "/empresa_123/politicas_y_manuales"}
  ]
}
```

---

### 4. PseudocÃ³digo del Pipeline de Ingesta

```python
# pipeline_ingesta.py

async def pipeline_ingesta(archivo: bytes, metadata_inicial: dict, opciones: dict) -> IngestResult:
    """
    Pipeline completo de ingesta de documentos.
    Orquesta: validaciÃ³n â†’ extracciÃ³n â†’ normalizaciÃ³n â†’ clasificaciÃ³n â†’ indexaciÃ³n â†’ sync pcloud
    """
    
    job_id = generate_job_id()
    document_id = generate_document_id()
    
    try:
        # FASE 1: ValidaciÃ³n inicial
        validacion = await validar_archivo(archivo, metadata_inicial)
        if not validacion.es_valido:
            return IngestResult(status="rejected", error=validacion.error)
        
        # FASE 2: Almacenamiento temporal
        temp_path = await storage.save_temp(archivo, document_id)
        
        # FASE 3: ExtracciÃ³n de texto
        if validacion.formato in ['pdf', 'png', 'jpg', 'tiff'] and opciones.forzar_ocr:
            texto = await ocr_service.extract(temp_path)
        elif validacion.formato in ['docx', 'xlsx', 'pptx']:
            texto = await office_extractor.extract(temp_path)
        elif validacion.formato in ['md', 'txt', 'html']:
            texto = await text_extractor.extract(temp_path)
        else:
            texto = await generic_extractor.extract(temp_path)
        
        # FASE 4: NormalizaciÃ³n
        texto_normalizado = await normalizar_texto(texto)
        idioma = await detectar_idioma(texto_normalizado)
        
        # FASE 5: ExtracciÃ³n de entidades y enriquecimiento
        entidades = await extraer_entidades(texto_normalizado, tipo_doc=validacion.formato)
        tags_auto = await generar_tags(texto_normalizado, entidades)
        
        # FASE 6: ClasificaciÃ³n automÃ¡tica (Agente de ClasificaciÃ³n)
        clasificacion = await agente_clasificacion.clasificar(
            texto=texto_normalizado,
            entidades=entidades,
            metadata_inicial=metadata_inicial
        )
        
        # Si confianza < 0.8, enviar a revisiÃ³n humana
        if clasificacion.confianza < 0.8:
            await cola_revision_humana.encolar(
                document_id=document_id,
                clasificacion_sugerida=clasificacion,
                motivo="baja_confianza"
            )
            clasificacion.flags.requires_review = True
        
        # FASE 7: Determinar ruta final en repositorio
        ruta_final = construir_ruta(
            empresa_id=metadata_inicial.empresa_id,
            categoria=clasificacion.categoria_principal,
            subcategoria=clasificacion.subcategoria,
            nombre_archivo=metadata_inicial.nombre_archivo
        )
        
        # FASE 8: Mover a storage permanente
        storage_url = await storage.move_to_permanent(temp_path, ruta_final)
        
        # FASE 9: Generar embeddings y chunks
        chunks = await chunker.split(texto_normalizado, chunk_size=512, overlap=50)
        embeddings = await embedding_service.generate_batch(chunks)
        
        # FASE 10: Indexar en Vector DB
        vector_ids = await vector_db.upsert(
            document_id=document_id,
            chunks=chunks,
            embeddings=embeddings,
            metadata={
                "titulo": metadata_inicial.nombre_archivo,
                "categoria": clasificacion.categoria_principal,
                "tags": tags_auto
            }
        )
        
        # FASE 11: Generar resumen (si aplica)
        resumen = None
        if opciones.generar_resumen and len(texto_normalizado) > 2000:
            resumen = await agente_resumen.generar(texto_normalizado)
        
        # FASE 12: Construir metadata completa
        metadata_final = construir_metadata_completa(
            document_id=document_id,
            metadata_inicial=metadata_inicial,
            clasificacion=clasificacion,
            entidades=entidades,
            tags=tags_auto,
            rutas={"repositorio": ruta_final, "storage_url": storage_url},
            indexacion={"vector_ids": vector_ids, "chunks_count": len(chunks)},
            procesamiento={"resumen_id": resumen.id if resumen else None}
        )
        
        # FASE 13: Guardar metadata en PostgreSQL
        await metadata_db.insert(metadata_final)
        
        # FASE 14: Sincronizar con pclouds de agentes (Agente Pcloud Sync)
        pcloud_refs = await agente_pcloud_sync.distribuir(
            document_id=document_id,
            clasificacion=clasificacion,
            relevancia_por_agente=calcular_relevancia_agentes(clasificacion, entidades)
        )
        
        # FASE 15: Actualizar metadata con refs de pcloud
        await metadata_db.update(document_id, {"pcloud_refs": pcloud_refs})
        
        # FASE 16: Notificar completado
        if opciones.notificar_completado:
            await notificaciones.enviar(
                tipo="ingesta_completada",
                destinatario=metadata_inicial.usuario_id,
                payload={"document_id": document_id, "ruta": ruta_final}
            )
        
        return IngestResult(
            status="completed",
            document_id=document_id,
            ruta=ruta_final,
            clasificacion=clasificacion,
            pcloud_refs=pcloud_refs
        )
        
    except Exception as e:
        await log_error(job_id, e)
        await cleanup_temp(document_id)
        return IngestResult(status="failed", error=str(e))
```

---

### 5. PseudocÃ³digo del Agente de ClasificaciÃ³n

```python
# agente_clasificacion.py

class AgenteClasificacion:
    """
    Agente especializado en clasificar documentos segÃºn taxonomÃ­a de Revisar.IA.
    Utiliza LLM + reglas de negocio para asignaciÃ³n de categorÃ­a, tags y permisos.
    """
    
    TAXONOMIA = {
        "informacion_general": ["acta_constitutiva", "organigrama", "directorio"],
        "planeacion_estrategica": ["plan_anual", "objetivos_kpis", "proyectos_especiales"],
        "politicas_y_manuales": ["politicas_fiscales", "manuales_operativos", "procedimientos"],
        "fiscal": ["declaraciones", "dictamenes", "criterios_sat"],
        "legal": ["contratos_modelo", "jurisprudencia", "normatividad"],
        "financiero": ["estados_financieros", "presupuestos", "reportes"],
        "proveedores": ["catalogo_proveedores", "contratos_vigentes", "evaluaciones"]
    }
    
    AGENTES_POR_CATEGORIA = {
        "informacion_general": ["A1", "A2"],
        "planeacion_estrategica": ["A1", "A2", "A5"],
        "politicas_y_manuales": ["A1", "A3", "A4"],
        "fiscal": ["A3", "A7"],
        "legal": ["A4", "A7"],
        "financiero": ["A5", "A7"],
        "proveedores": ["A6", "A7"]
    }
    
    async def clasificar(self, texto: str, entidades: list, metadata_inicial: dict) -> Clasificacion:
        
        # Paso 1: ClasificaciÃ³n por reglas (rÃ¡pida, alta precisiÃ³n)
        clasificacion_reglas = self._clasificar_por_reglas(texto, entidades, metadata_inicial)
        
        if clasificacion_reglas.confianza >= 0.9:
            return clasificacion_reglas
        
        # Paso 2: ClasificaciÃ³n por LLM (mÃ¡s flexible)
        prompt = self._construir_prompt_clasificacion(texto, entidades)
        
        respuesta_llm = await llm.complete(
            model="claude-sonnet-4-20250514",
            system="""Eres un agente clasificador de documentos corporativos para una plataforma de auditorÃ­a fiscal.
            
            TAXONOMÃA DISPONIBLE:
            - informacion_general: acta_constitutiva, organigrama, directorio
            - planeacion_estrategica: plan_anual, objetivos_kpis, proyectos_especiales
            - politicas_y_manuales: politicas_fiscales, manuales_operativos, procedimientos
            - fiscal: declaraciones, dictamenes, criterios_sat
            - legal: contratos_modelo, jurisprudencia, normatividad
            - financiero: estados_financieros, presupuestos, reportes
            - proveedores: catalogo_proveedores, contratos_vigentes, evaluaciones
            
            Responde SOLO en JSON con el formato especificado.""",
            prompt=prompt,
            response_format={"type": "json_object"}
        )
        
        clasificacion_llm = self._parsear_respuesta_llm(respuesta_llm)
        
        # Paso 3: Combinar resultados
        clasificacion_final = self._combinar_clasificaciones(
            clasificacion_reglas, 
            clasificacion_llm
        )
        
        # Paso 4: Asignar nivel de confidencialidad
        clasificacion_final.nivel_confidencialidad = self._determinar_confidencialidad(
            categoria=clasificacion_final.categoria_principal,
            entidades=entidades
        )
        
        # Paso 5: Asignar agentes permitidos
        clasificacion_final.agentes_permitidos = self.AGENTES_POR_CATEGORIA.get(
            clasificacion_final.categoria_principal, 
            ["A1"]  # Default: solo sponsor
        )
        
        return clasificacion_final
    
    def _clasificar_por_reglas(self, texto: str, entidades: list, metadata: dict) -> Clasificacion:
        """ClasificaciÃ³n basada en keywords y patrones."""
        
        texto_lower = texto.lower()
        
        # Reglas de alta confianza
        if "acta constitutiva" in texto_lower or "escritura pÃºblica" in texto_lower:
            return Clasificacion(
                categoria_principal="informacion_general",
                subcategoria="acta_constitutiva",
                confianza=0.95
            )
        
        if any(ley in texto_lower for ley in ["lisr art", "cff art", "cÃ³digo fiscal"]):
            if "polÃ­tica" in texto_lower or "manual" in texto_lower:
                return Clasificacion(
                    categoria_principal="politicas_y_manuales",
                    subcategoria="politicas_fiscales",
                    confianza=0.90
                )
            else:
                return Clasificacion(
                    categoria_principal="fiscal",
                    subcategoria="criterios_sat",
                    confianza=0.85
                )
        
        if "estado de resultados" in texto_lower or "balance general" in texto_lower:
            return Clasificacion(
                categoria_principal="financiero",
                subcategoria="estados_financieros",
                confianza=0.92
            )
        
        if "contrato de" in texto_lower and "proveedor" in texto_lower:
            return Clasificacion(
                categoria_principal="proveedores",
                subcategoria="contratos_vigentes",
                confianza=0.88
            )
        
        # Si no hay match de alta confianza, retornar baja confianza
        return Clasificacion(
            categoria_principal=metadata.get("categoria_sugerida", "informacion_general"),
            subcategoria="otros",
            confianza=0.5
        )
    
    def _construir_prompt_clasificacion(self, texto: str, entidades: list) -> str:
        return f"""Clasifica el siguiente documento corporativo.

TEXTO DEL DOCUMENTO (primeros 3000 caracteres):
{texto[:3000]}

ENTIDADES DETECTADAS:
{json.dumps(entidades, indent=2)}

Responde en JSON:
{{
    "categoria_principal": "<una de las categorÃ­as de la taxonomÃ­a>",
    "subcategoria": "<subcategorÃ­a correspondiente>",
    "confianza": <0.0 a 1.0>,
    "tags_sugeridos": ["tag1", "tag2", ...],
    "razonamiento": "<breve explicaciÃ³n de la clasificaciÃ³n>"
}}"""
```

---

### 6. DefiniciÃ³n RAG

#### Modelo de Embeddings
```yaml
embedding_config:
  model: "text-embedding-3-small"
  provider: "openai"
  dimensions: 1536
  batch_size: 100
  rate_limit: 3000  # requests per minute
  
  # Alternativa local
  alternative:
    model: "sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2"
    dimensions: 384
    self_hosted: true
```

#### Vector Database
```yaml
vector_db_config:
  primary: "pinecone"
  pinecone:
    index_name: "revisar-ia-knowledge"
    environment: "us-east-1"
    metric: "cosine"
    pods: 1
    replicas: 1
    pod_type: "p1.x1"
    
  # Alternativa self-hosted
  alternative: "milvus"
  milvus:
    host: "milvus.revisar-ia.internal"
    port: 19530
    collection: "knowledge_embeddings"
    index_type: "IVF_FLAT"
    nlist: 1024
```

#### Estrategia de Chunking
```yaml
chunking_config:
  strategy: "semantic"
  chunk_size: 512  # tokens
  chunk_overlap: 50  # tokens
  
  # Separadores por prioridad
  separators:
    - "\n\n"    # PÃ¡rrafos
    - "\n"      # LÃ­neas
    - ". "      # Oraciones
    - " "       # Palabras
  
  # Metadatos por chunk
  include_metadata:
    - document_id
    - page_number
    - section_title
    - chunk_index
```

#### Estrategia de Re-ranking
```yaml
reranking_config:
  enabled: true
  model: "cross-encoder/ms-marco-MiniLM-L-6-v2"
  top_k_initial: 20  # Candidates from vector search
  top_k_final: 5     # After reranking
  
  # Boost por relevancia
  boosts:
    recency: 0.1      # Documentos mÃ¡s recientes
    exact_match: 0.2  # Match exacto de tÃ©rminos
    category_match: 0.15  # Misma categorÃ­a que query context
```

#### Prompt Template para RAG
```yaml
rag_prompt_template: |
  ## Contexto del Repositorio de Conocimiento
  
  A continuaciÃ³n se presenta informaciÃ³n relevante extraÃ­da del repositorio corporativo de {empresa_nombre}.
  
  {%- for source in sources %}
  
  ### Fuente {{ loop.index }}: {{ source.titulo }}
  - **CategorÃ­a:** {{ source.categoria }}
  - **Fecha:** {{ source.fecha_modificacion }}
  - **Relevancia:** {{ source.similarity_score | round(2) }}
  
  {{ source.contenido }}
  
  [Referencia: {{ source.citation }}]
  
  {%- endfor %}
  
  ---
  
  Utiliza la informaciÃ³n anterior para responder la siguiente consulta. Si la informaciÃ³n no es suficiente, indÃ­calo claramente.
  
  **Consulta:** {{ query }}
```

---

## DEFINICIÃ“N DE AGENTES Y SUBAGENTES

### Agentes Principales

| Agente | PropÃ³sito | Owner | Entradas | Salidas | Dependencias | SLA |
|--------|-----------|-------|----------|---------|--------------|-----|
| **Agente de Ingesta** | Detectar, validar, extraer texto y normalizar documentos subidos | Equipo de Datos | Archivos (PDF, DOCX, XLSX, etc.) | Documentos normalizados con texto extraÃ­do | OCR Service, Office Extractor | < 30s/doc (95th percentile) |
| **Agente de ClasificaciÃ³n** | Asignar categorÃ­a, subcategorÃ­a, tags, nivel de confidencialidad y permisos | Equipo de Datos | Documentos normalizados + entidades | ClasificaciÃ³n completa con confianza | LLM (Claude), Taxonomy Rules | 95% precisiÃ³n, < 5s/doc |
| **Agente Pcloud Sync** | Distribuir referencias a bases de conocimiento de cada agente operativo | Equipo de Datos | Documentos clasificados | Referencias en pcloud de A1-A7 | Agente de ClasificaciÃ³n | < 2s sync, 99.9% consistencia |
| **Agente RAG** | Retrieval semÃ¡ntico con re-ranking para augmentar prompts de agentes | Equipo ML | Queries de agentes A1-A7 | Contexto augmentado + citations | Vector DB, Re-ranker | < 2s e2e, recall@5 > 0.85 |

### Subagentes

| Subagente | PropÃ³sito | Trigger | Owner | Entradas | Salidas | SLA |
|-----------|-----------|---------|-------|----------|---------|-----|
| **Subagente RevisiÃ³n Humana** | Gestionar cola de documentos que requieren clasificaciÃ³n manual | confianza < 0.8 | Equipo Ops | Docs con baja confianza | ClasificaciÃ³n validada | < 24h resoluciÃ³n |
| **Subagente ResÃºmenes** | Generar resÃºmenes automÃ¡ticos de documentos extensos | doc.paginas > 10 | Equipo ML | Documentos largos | ResÃºmenes + highlights | < 60s/doc |
| **Subagente OCR** | Extraer texto de imÃ¡genes y PDFs escaneados | formato in [pdf_scan, png, jpg] | Equipo Datos | ImÃ¡genes/PDFs | Texto extraÃ­do | < 10s/pÃ¡gina, 98% precisiÃ³n |
| **Subagente Versionado** | Gestionar versiones y detectar cambios significativos | doc.version > 1 | Equipo Datos | Documento nuevo + anterior | Diff + changelog | < 5s |
| **Subagente Cumplimiento** | Verificar que documentos sensibles cumplan polÃ­ticas de retenciÃ³n | nivel_confidencialidad in [confidencial, restringido] | Legal/Compliance | Docs sensibles | ValidaciÃ³n + alertas | 100% cobertura |

---

## PLAN DE PRUEBAS

### Casos de Prueba de Flujo de InformaciÃ³n

#### CASO 1: Ingesta exitosa de PDF simple
```yaml
caso_id: TC-001
nombre: "Ingesta exitosa de PDF corporativo"
tipo: happy_path
precondiciones:
  - Usuario autenticado como admin
  - Sistema en estado operativo
  
pasos:
  1. POST /api/knowledge/ingest con archivo politica_fiscal.pdf (500KB)
  2. Esperar respuesta 202 Accepted
  3. GET /api/knowledge/jobs/{job_id} cada 2s hasta status=completed
  4. GET /api/knowledge/documents/{document_id}
  5. Verificar metadata completa
  6. GET /api/knowledge/browse?path=/empresa_123/politicas_y_manuales
  
entrada:
  archivo: "politica_deduccion_intangibles_v1.pdf"
  metadata_inicial:
    tipo_documento: "politica"
    categoria_sugerida: "politicas_fiscales"
    
resultado_esperado:
  status: "completed"
  clasificacion:
    categoria_principal: "politicas_y_manuales"
    subcategoria: "politicas_fiscales"
    confianza: "> 0.85"
  indexacion:
    chunks_count: "> 0"
    vector_id: "not null"
  pcloud_refs:
    - agente: "A3_fiscal"
    - agente: "A4_legal"
  tiempo_total: "< 30s"
```

#### CASO 2: Ingesta con OCR requerido
```yaml
caso_id: TC-002
nombre: "Ingesta de PDF escaneado con OCR"
tipo: happy_path
precondiciones:
  - PDF es imagen escaneada (no tiene texto embebido)
  
pasos:
  1. POST /api/knowledge/ingest con PDF escaneado
  2. Verificar que OCR se activa automÃ¡ticamente
  3. Esperar procesamiento (puede tomar > 30s)
  4. Verificar texto extraÃ­do correctamente
  
entrada:
  archivo: "contrato_escaneado.pdf"
  opciones:
    forzar_ocr: false  # Debe detectar automÃ¡ticamente
    
resultado_esperado:
  procesamiento:
    ocr_aplicado: true
    texto_extraido: true
  tiempo_total: "< 60s para 5 pÃ¡ginas"
```

#### CASO 3: ClasificaciÃ³n con baja confianza â†’ RevisiÃ³n humana
```yaml
caso_id: TC-003
nombre: "Documento ambiguo enviado a revisiÃ³n humana"
tipo: edge_case
precondiciones:
  - Documento con contenido mixto o poco claro
  
pasos:
  1. POST /api/knowledge/ingest con documento ambiguo
  2. Verificar clasificacion.confianza < 0.8
  3. Verificar flags.requires_review = true
  4. GET /api/knowledge/review-queue
  5. Verificar documento en cola
  
entrada:
  archivo: "documento_mixto_sin_contexto.docx"
  
resultado_esperado:
  clasificacion:
    confianza: "< 0.8"
  flags:
    requires_review: true
  cola_revision:
    documento_presente: true
    motivo: "baja_confianza"
```

#### CASO 4: Query RAG exitoso
```yaml
caso_id: TC-004
nombre: "Consulta RAG con resultados relevantes"
tipo: happy_path
precondiciones:
  - Al menos 5 documentos indexados en categorÃ­a fiscal
  
pasos:
  1. POST /api/knowledge/query_rag con query fiscal
  2. Verificar resultados ordenados por relevancia
  3. Verificar citations incluidas
  4. Verificar latencia < 2s
  
entrada:
  query: "Â¿CuÃ¡les son los requisitos del Art. 27 LISR para deducir intangibles?"
  contexto:
    agente_solicitante: "A3_fiscal"
  opciones:
    top_k: 5
    min_similarity: 0.7
    
resultado_esperado:
  results:
    count: ">= 1"
    top_result:
      similarity_score: "> 0.7"
      citation: "not null"
  metadata_query:
    latency_ms: "< 2000"
```

#### CASO 5: Re-indexaciÃ³n forzada
```yaml
caso_id: TC-005
nombre: "Re-indexaciÃ³n manual de documento"
tipo: happy_path
precondiciones:
  - Documento existente con vector_id vÃ¡lido
  
pasos:
  1. Guardar vector_id actual
  2. POST /api/knowledge/reindex con document_id
  3. Esperar job completed
  4. Verificar nuevo vector_id generado
  5. Verificar embeddings actualizados
  
entrada:
  document_ids: ["doc_abc123"]
  opciones:
    regenerar_embeddings: true
    
resultado_esperado:
  status: "completed"
  indexacion:
    vector_id: "diferente al anterior"
    fecha_indexacion: "nueva"
```

#### CASO 6: Archivo invÃ¡lido rechazado
```yaml
caso_id: TC-006
nombre: "Rechazo de archivo corrupto o no soportado"
tipo: error_handling
precondiciones:
  - Ninguna
  
pasos:
  1. POST /api/knowledge/ingest con archivo .exe
  2. Verificar respuesta 400 Bad Request
  3. POST con PDF corrupto
  4. Verificar respuesta con error descriptivo
  
entrada:
  archivo: "malware.exe"
  
resultado_esperado:
  status_code: 400
  error:
    code: "INVALID_FILE_FORMAT"
    message: "Formato de archivo no soportado: exe"
```

#### CASO 7: SincronizaciÃ³n pcloud multi-agente
```yaml
caso_id: TC-007
nombre: "DistribuciÃ³n correcta a pclouds de mÃºltiples agentes"
tipo: integration
precondiciones:
  - Documento clasificado como "fiscal" con relevancia para A3, A4, A7
  
pasos:
  1. Ingestar documento fiscal/legal
  2. Verificar refs creadas en /pcloud/A3_fiscal/refs/
  3. Verificar refs creadas en /pcloud/A4_legal/refs/
  4. Verificar refs creadas en /pcloud/A7_defense_file/refs/
  5. Verificar contenido de cada ref apunta al mismo document_id
  
entrada:
  archivo: "jurisprudencia_intangibles_2024.pdf"
  clasificacion_esperada:
    categoria: "legal"
    subcategoria: "jurisprudencia"
    
resultado_esperado:
  pcloud_refs:
    - agente: "A4_legal"
      relevancia: "> 0.9"
    - agente: "A3_fiscal"
      relevancia: "> 0.7"
    - agente: "A7_defense_file"
      relevancia: "> 0.6"
```

#### CASO 8: Versionado de documento actualizado
```yaml
caso_id: TC-008
nombre: "ActualizaciÃ³n de documento existente con versionado"
tipo: update_flow
precondiciones:
  - Documento v1 ya existe en el sistema
  
pasos:
  1. POST /api/knowledge/ingest con mismo nombre pero contenido diferente
  2. Sistema detecta documento existente
  3. Crear nueva versiÃ³n (v2)
  4. Mantener referencia a versiÃ³n anterior
  5. Verificar ambas versiones accesibles
  
entrada:
  archivo: "politica_deduccion_intangibles_v2.docx"
  metadata_inicial:
    documento_existente_id: "doc_abc123"
    es_actualizacion: true
    
resultado_esperado:
  versionado:
    version_actual: "2.0"
    versiones_anteriores:
      - version: "1.0"
        archivo_id: "doc_abc123"
  indexacion:
    reindexado: true
```

---

## MÃ‰TRICAS, SLOs Y ALERTAS

### MÃ©tricas de Pipeline

| MÃ©trica | DescripciÃ³n | Target | Alerta Warning | Alerta Critical |
|---------|-------------|--------|----------------|-----------------|
| `ingest_latency_p95` | Latencia de ingesta percentil 95 | < 30s | > 45s | > 60s |
| `classification_accuracy` | PrecisiÃ³n de clasificaciÃ³n automÃ¡tica | > 95% | < 90% | < 85% |
| `classification_confidence_avg` | Confianza promedio de clasificaciÃ³n | > 0.85 | < 0.80 | < 0.75 |
| `review_queue_size` | Documentos pendientes de revisiÃ³n humana | < 50 | > 100 | > 200 |
| `review_queue_age_max` | Edad mÃ¡xima de documento en cola | < 24h | > 24h | > 48h |

### MÃ©tricas de RAG

| MÃ©trica | DescripciÃ³n | Target | Alerta Warning | Alerta Critical |
|---------|-------------|--------|----------------|-----------------|
| `rag_latency_p95` | Latencia de query RAG percentil 95 | < 2s | > 3s | > 5s |
| `rag_recall_at_5` | Recall@5 (documentos relevantes en top 5) | > 0.85 | < 0.80 | < 0.70 |
| `rag_mrr` | Mean Reciprocal Rank | > 0.75 | < 0.70 | < 0.60 |
| `embedding_generation_errors` | Errores al generar embeddings | < 0.1% | > 1% | > 5% |
| `vector_db_availability` | Disponibilidad de Vector DB | 99.9% | < 99.5% | < 99% |

### MÃ©tricas de Storage

| MÃ©trica | DescripciÃ³n | Target | Alerta Warning | Alerta Critical |
|---------|-------------|--------|----------------|-----------------|
| `storage_usage_percent` | Uso de almacenamiento | < 80% | > 80% | > 90% |
| `documents_total` | Total de documentos en sistema | N/A | N/A | N/A |
| `index_sync_lag` | Lag entre storage y Ã­ndice | < 5min | > 15min | > 30min |
| `pcloud_sync_failures` | Fallos de sincronizaciÃ³n pcloud | < 0.1% | > 1% | > 5% |

---

## ROADMAP DE IMPLEMENTACIÃ“N

### Sprint 1 (Semanas 1-2): Infraestructura Base
```yaml
sprint: 1
nombre: "Infraestructura y Storage"
objetivo: "Establecer base de almacenamiento y estructura de repositorio"

entregables:
  - Esquema de base de datos PostgreSQL para metadata
  - ConfiguraciÃ³n de storage (S3/MinIO) con estructura de carpetas
  - API bÃ¡sica de browse y upload
  - UI de File Explorer (vista de carpetas, sin funcionalidad avanzada)
  - IntegraciÃ³n con sistema de autenticaciÃ³n existente

tareas:
  - [ ] Crear tablas: documentos, versiones, tags, permisos, audit_log
  - [ ] Configurar bucket S3 con polÃ­ticas de acceso
  - [ ] Implementar endpoints: GET /browse, POST /upload, GET /download
  - [ ] Componente React: KnowledgeExplorer con Ã¡rbol de carpetas
  - [ ] Drag & Drop zone para upload mÃºltiple
  - [ ] Tests unitarios de storage layer

esfuerzo_estimado: 80 horas
riesgos:
  - IntegraciÃ³n con auth existente puede requerir ajustes
mitigacion:
  - ReuniÃ³n tÃ©cnica dÃ­a 1 para alinear interfaces
```

### Sprint 2 (Semanas 3-4): Pipeline de Ingesta
```yaml
sprint: 2
nombre: "Agente de Ingesta y ExtracciÃ³n"
objetivo: "Implementar pipeline completo de ingesta con extracciÃ³n de texto"

entregables:
  - Agente de Ingesta funcional
  - Extractores: PDF, DOCX, XLSX, PPTX, MD, TXT
  - Servicio OCR integrado (Tesseract o cloud)
  - Cola de procesamiento con jobs
  - API de tracking de jobs

tareas:
  - [ ] Implementar IngestAgent con patrÃ³n pipeline
  - [ ] Integrar pdf-parse, mammoth.js, xlsx
  - [ ] Configurar Tesseract OCR o Google Vision API
  - [ ] Implementar job queue con Bull/BullMQ
  - [ ] Endpoint POST /ingest con job tracking
  - [ ] UI: progress indicator durante upload
  - [ ] Tests de integraciÃ³n por formato

esfuerzo_estimado: 100 horas
dependencias:
  - Sprint 1 completado
```

### Sprint 3 (Semanas 5-6): ClasificaciÃ³n y RAG MVP
```yaml
sprint: 3
nombre: "Agente de ClasificaciÃ³n + RAG BÃ¡sico"
objetivo: "ClasificaciÃ³n automÃ¡tica e integraciÃ³n RAG funcional"

entregables:
  - Agente de ClasificaciÃ³n con LLM
  - TaxonomÃ­a implementada con reglas + fallback LLM
  - Vector DB configurado (Pinecone o pgvector)
  - Chunking y embedding pipeline
  - Endpoint /query_rag funcional
  - IntegraciÃ³n con agentes A1-A7 existentes

tareas:
  - [ ] Implementar ClassificationAgent con Claude
  - [ ] Definir prompts de clasificaciÃ³n
  - [ ] Configurar Pinecone index (o pgvector extension)
  - [ ] Implementar chunker semÃ¡ntico
  - [ ] Integrar OpenAI embeddings
  - [ ] Endpoint POST /query_rag
  - [ ] Modificar agentes existentes para usar RAG
  - [ ] Cola de revisiÃ³n humana bÃ¡sica
  - [ ] Tests e2e de flujo completo

esfuerzo_estimado: 120 horas
dependencias:
  - Sprint 2 completado
```

### Sprint 4 (Semanas 7-8): Pcloud Sync y Refinamiento
```yaml
sprint: 4
nombre: "Pcloud Sync + OptimizaciÃ³n"
objetivo: "DistribuciÃ³n a KBs de agentes y optimizaciÃ³n de performance"

entregables:
  - Agente Pcloud Sync completo
  - Referencias en /pcloud/A{n}/ funcionales
  - Re-ranking implementado
  - UI de administraciÃ³n de documentos
  - Dashboard de mÃ©tricas bÃ¡sico
  - Versionado de documentos

tareas:
  - [ ] Implementar PcloudSyncAgent
  - [ ] LÃ³gica de relevancia por agente
  - [ ] Integrar cross-encoder para re-ranking
  - [ ] UI: vista de documento con metadata
  - [ ] UI: panel de admin para clasificaciÃ³n manual
  - [ ] Implementar versionado con diff
  - [ ] Dashboard con mÃ©tricas clave
  - [ ] Performance tuning (caching, Ã­ndices)

esfuerzo_estimado: 100 horas
dependencias:
  - Sprint 3 completado
```

### Sprint 5 (Semanas 9-10): Hardening y Launch
```yaml
sprint: 5
nombre: "Seguridad, Testing y Launch"
objetivo: "Preparar sistema para producciÃ³n"

entregables:
  - AuditorÃ­a de seguridad completa
  - Tests de carga
  - DocumentaciÃ³n tÃ©cnica y de usuario
  - Runbook operativo
  - MigraciÃ³n de datos existentes (si aplica)
  - Go-live

tareas:
  - [ ] Implementar RBAC completo
  - [ ] Cifrado en reposo verificado
  - [ ] Audit logging inmutable
  - [ ] Penetration testing bÃ¡sico
  - [ ] Load testing con k6/Artillery
  - [ ] DocumentaciÃ³n API (OpenAPI spec)
  - [ ] Manual de usuario
  - [ ] Runbook de operaciones
  - [ ] Script de migraciÃ³n
  - [ ] Deployment a producciÃ³n
  - [ ] Monitoreo con alertas configuradas

esfuerzo_estimado: 80 horas
dependencias:
  - Sprint 4 completado
```

---

## CHECKLIST OPERATIVO PARA LANZAMIENTO

### Infraestructura
- [ ] Storage (S3/MinIO) configurado con replicaciÃ³n
- [ ] Vector DB (Pinecone/Milvus) en cluster production
- [ ] PostgreSQL con backups automÃ¡ticos
- [ ] CDN para assets estÃ¡ticos (opcional)
- [ ] SSL/TLS configurado en todos los endpoints

### Seguridad
- [ ] Cifrado en reposo habilitado (AES-256)
- [ ] Cifrado en trÃ¡nsito (TLS 1.3)
- [ ] RBAC implementado y verificado
- [ ] MFA habilitado para acceso admin
- [ ] API keys rotadas
- [ ] Audit logging habilitado
- [ ] Rate limiting configurado
- [ ] CORS policies definidas

### Monitoreo
- [ ] APM configurado (Datadog/NewRelic/Sentry)
- [ ] Alertas crÃ­ticas configuradas
- [ ] Dashboards de mÃ©tricas desplegados
- [ ] Log aggregation funcionando
- [ ] Health checks en todos los servicios

### Datos
- [ ] MigraciÃ³n de datos legacy completada (si aplica)
- [ ] Ãndices de Vector DB poblados
- [ ] Backup inicial realizado
- [ ] Plan de rollback documentado

### DocumentaciÃ³n
- [ ] API documentation publicada
- [ ] Manual de usuario disponible
- [ ] Runbook de operaciones completo
- [ ] Proceso de soporte definido

### Testing
- [ ] Todos los tests unitarios pasando
- [ ] Tests de integraciÃ³n pasando
- [ ] Tests e2e de flujos crÃ­ticos pasando
- [ ] Load test satisfactorio (target: 100 docs/min)
- [ ] Smoke test post-deploy definido

---

## SCRIPTS DE PRUEBA (CLI)

### 1. Subir documento
```bash
#!/bin/bash
# upload_document.sh

API_BASE="https://api.revisar-ia.com"
TOKEN="Bearer ${REVISAR_API_TOKEN}"

# Codificar archivo en base64
FILE_PATH=$1
FILE_NAME=$(basename "$FILE_PATH")
FILE_B64=$(base64 -w 0 "$FILE_PATH")

# Request
curl -X POST "${API_BASE}/api/knowledge/ingest" \
  -H "Authorization: ${TOKEN}" \
  -H "Content-Type: application/json" \
  -d @- <<EOF
{
  "archivo": "${FILE_B64}",
  "nombre_archivo": "${FILE_NAME}",
  "metadata_inicial": {
    "tipo_documento": "politica",
    "categoria_sugerida": "politicas_fiscales",
    "propietario_organico": {
      "area": "Fiscal",
      "responsable": "Admin"
    }
  },
  "opciones": {
    "clasificacion_automatica": true,
    "generar_resumen": true
  }
}
EOF
```

### 2. Forzar re-indexado
```bash
#!/bin/bash
# reindex_document.sh

API_BASE="https://api.revisar-ia.com"
TOKEN="Bearer ${REVISAR_API_TOKEN}"
DOCUMENT_ID=$1

curl -X POST "${API_BASE}/api/knowledge/reindex" \
  -H "Authorization: ${TOKEN}" \
  -H "Content-Type: application/json" \
  -d @- <<EOF
{
  "scope": "document",
  "document_ids": ["${DOCUMENT_ID}"],
  "opciones": {
    "regenerar_embeddings": true,
    "recalcular_relevancia_pcloud": true
  }
}
EOF
```

### 3. Query RAG y validar fuente
```bash
#!/bin/bash
# query_rag.sh

API_BASE="https://api.revisar-ia.com"
TOKEN="Bearer ${REVISAR_API_TOKEN}"
QUERY=$1

RESPONSE=$(curl -s -X POST "${API_BASE}/api/knowledge/query_rag" \
  -H "Authorization: ${TOKEN}" \
  -H "Content-Type: application/json" \
  -d @- <<EOF
{
  "query": "${QUERY}",
  "contexto": {
    "agente_solicitante": "A3_fiscal",
    "empresa_id": "empresa_123"
  },
  "opciones": {
    "top_k": 5,
    "min_similarity": 0.7,
    "incluir_metadata": true
  }
}
EOF
)

# Mostrar resultados
echo "=== QUERY RAG RESULTS ==="
echo "$RESPONSE" | jq '.results[] | {rank, titulo, similarity_score, citation}'

# Verificar latencia
LATENCY=$(echo "$RESPONSE" | jq '.metadata_query.latency_ms')
echo ""
echo "Latencia: ${LATENCY}ms"

if [ "$LATENCY" -gt 2000 ]; then
  echo "âš ï¸ WARNING: Latencia excede SLA de 2000ms"
else
  echo "âœ… Latencia dentro de SLA"
fi
```

### 4. Verificar health del sistema
```bash
#!/bin/bash
# health_check.sh

API_BASE="https://api.revisar-ia.com"

echo "=== KNOWLEDGE SYSTEM HEALTH CHECK ==="

# Check API
API_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${API_BASE}/api/knowledge/health")
echo "API Status: ${API_STATUS}"

# Check Vector DB
VECTOR_STATUS=$(curl -s "${API_BASE}/api/knowledge/health/vector-db" | jq -r '.status')
echo "Vector DB: ${VECTOR_STATUS}"

# Check Storage
STORAGE_STATUS=$(curl -s "${API_BASE}/api/knowledge/health/storage" | jq -r '.status')
echo "Storage: ${STORAGE_STATUS}"

# Check Queue
QUEUE_SIZE=$(curl -s "${API_BASE}/api/knowledge/health/queue" | jq -r '.pending_jobs')
echo "Pending Jobs: ${QUEUE_SIZE}"

# Check Review Queue
REVIEW_QUEUE=$(curl -s "${API_BASE}/api/knowledge/review-queue/stats" | jq -r '.pending_count')
echo "Pending Reviews: ${REVIEW_QUEUE}"

echo ""
echo "=== END HEALTH CHECK ==="
```

---

## EJEMPLO DE PAYLOADS DE PRUEBA

### Payload 1: Ingesta de PolÃ­tica Fiscal
```json
{
  "archivo": "JVBERi0xLjQKJeLjz9MKMyAwIG9iago8PC...[base64 truncado]",
  "nombre_archivo": "politica_deduccion_intangibles_2024_v1.pdf",
  "metadata_inicial": {
    "tipo_documento": "politica",
    "categoria_sugerida": "politicas_fiscales",
    "propietario_organico": {
      "area": "DirecciÃ³n Fiscal",
      "responsable": "Carlos Mendoza",
      "email": "cmendoza@empresa.com"
    },
    "nivel_confidencialidad": "interno",
    "tags_sugeridos": ["deduccion", "intangibles", "lisr", "art_27"]
  },
  "opciones": {
    "forzar_ocr": false,
    "generar_resumen": true,
    "clasificacion_automatica": true,
    "notificar_completado": true
  }
}
```

### Payload 2: Query RAG para Agente Fiscal
```json
{
  "query": "Â¿QuÃ© documentaciÃ³n se requiere para sustentar la deducciÃ³n de regalÃ­as pagadas a empresas del extranjero segÃºn nuestra polÃ­tica interna y los criterios del SAT?",
  "contexto": {
    "agente_solicitante": "A3_fiscal",
    "proyecto_id": "proj_audit_intangibles_2024",
    "empresa_id": "empresa_acme_123",
    "proveedor_id": "prov_tech_solutions",
    "monto_deduccion": 2500000.00
  },
  "opciones": {
    "top_k": 5,
    "min_similarity": 0.65,
    "incluir_metadata": true,
    "incluir_resumen": true,
    "filtros": {
      "categorias": ["politicas_fiscales", "criterios_sat", "normatividad"],
      "nivel_confidencialidad_max": "confidencial",
      "fecha_desde": "2022-01-01",
      "agentes_permitidos_incluye": "A3"
    },
    "reranking": true,
    "expand_query": true
  }
}
```

### Payload 3: ActualizaciÃ³n de Documento con Versionado
```json
{
  "archivo": "UEsDBBQAAAAIAGJxT1kAAA...[base64 truncado]",
  "nombre_archivo": "politica_deduccion_intangibles_2024_v2.docx",
  "metadata_inicial": {
    "documento_existente_id": "doc_7f3a9b2c-4e5d-4a1b-8c9d-0e1f2a3b4c5d",
    "es_actualizacion": true,
    "cambios_descripcion": "ActualizaciÃ³n por cambios en criterios SAT 2024. Se agregan requisitos de documentaciÃ³n para operaciones con partes relacionadas.",
    "tipo_documento": "politica",
    "propietario_organico": {
      "area": "DirecciÃ³n Fiscal",
      "responsable": "Carlos Mendoza"
    }
  },
  "opciones": {
    "generar_resumen": true,
    "clasificacion_automatica": false,
    "mantener_clasificacion_anterior": true,
    "generar_diff": true,
    "notificar_a_suscriptores": true
  }
}
```

---

## COSTOS APROXIMADOS (SaaS/Propietarios)

| Servicio | Uso Estimado | Costo/mes | Alternativa |
|----------|--------------|-----------|-------------|
| **OpenAI Embeddings** | 10K docs Ã— 5 chunks = 50K embeddings | ~$5-10 | sentence-transformers (gratis, self-hosted) |
| **Claude API** (ClasificaciÃ³n) | 10K clasificaciones Ã— ~500 tokens | ~$15-30 | GPT-3.5-turbo (~$5) |
| **Pinecone** | 100K vectors, 1 pod | ~$70 | pgvector (gratis), Milvus (self-hosted) |
| **S3 Storage** | 100GB | ~$2.30 | MinIO (self-hosted) |
| **OCR (Google Vision)** | 5K pÃ¡ginas | ~$7.50 | Tesseract (gratis) |
| **TOTAL ESTIMADO** | - | **~$100-120/mes** | **~$10-20/mes** (self-hosted) |

**Nota:** Costos para 10K requests/mes. Escala linealmente con volumen.

---

## REFERENCIAS Y RECURSOS

- [OpenAI Embeddings Documentation](https://platform.openai.com/docs/guides/embeddings)
- [Pinecone Best Practices](https://docs.pinecone.io/docs/best-practices)
- [pgvector Extension](https://github.com/pgvector/pgvector)
- [LangChain RAG Guide](https://python.langchain.com/docs/use_cases/question_answering/)
- [Anthropic Claude API](https://docs.anthropic.com/)

---

*Documento generado para REVISAR.IA - Sistema de GestiÃ³n del Conocimiento Corporativo*
*VersiÃ³n: 1.0 | Fecha: Enero 2026*