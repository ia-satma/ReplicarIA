MODO AGENTE AUTÃ“NOMO - ARREGLAR ERROR "Body is disturbed" AHORA

ESTO ES URGENTE. NO EXPLICAR. NO PREGUNTAR. SOLO ARREGLAR.

EL ERROR "Body is disturbed or locked" OCURRE EN EL FRONTEND.

<TOON>

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PASO 1: ENCONTRAR EL ARCHIVO QUE HACE LA LLAMADA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

EJECUTAR EN SHELL:

```bash
grep -rn "Confirmar y Crear\|crearCliente\|/api/clientes" frontend/src/ --include="*.tsx" --include="*.ts" | head -20
```

TAMBIÃ‰N BUSCAR:

```bash
grep -rn "Body is disturbed\|response.json\|response.text" frontend/src/ --include="*.tsx" --include="*.ts" | head -20
```

ENCONTRAR EL ARCHIVO Y ABRIRLO.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PASO 2: EL PROBLEMA ESTÃ EN CÃ“MO SE LEE LA RESPUESTA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

BUSCAR CÃ“DIGO COMO ESTE (MAL):

```typescript
// âŒ ESTO CAUSA "Body is disturbed"
const response = await fetch('/api/clientes', {...});
const text = await response.text(); // Lee el body
const data = await response.json(); // ERROR: body ya consumido

// âŒ ESTO TAMBIÃ‰N CAUSA EL ERROR
try {
  const data = await response.json();
} catch {
  const text = await response.text(); // ERROR: body ya consumido
}

// âŒ ESTO TAMBIÃ‰N
const clone = response.clone();
const data = await response.json();
const text = await clone.text(); // A veces falla
```

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PASO 3: REEMPLAZAR CON ESTE CÃ“DIGO EXACTO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ENCONTRAR la funciÃ³n que crea el cliente y REEMPLAZARLA COMPLETAMENTE con:

```typescript
const handleCrearCliente = async () => {
  // Prevenir mÃºltiples clicks
  if (isLoading) return;
  
  setIsLoading(true);
  setError(null);

  // Crear objeto de datos UNA SOLA VEZ
  const payload = {
    nombre: formData.nombre || '',
    rfc: formData.rfc || '',
    razon_social: formData.razonSocial || formData.razon_social || formData.nombre || '',
    direccion: formData.direccion || '',
    email: formData.email || '',
    telefono: formData.telefono || '',
    giro: formData.giro || '',
    sitio_web: formData.sitioWeb || formData.sitio_web || ''
  };

  console.log('ğŸ“¤ Enviando:', JSON.stringify(payload));

  try {
    const response = await fetch('/api/clientes', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload)
    });

    // LEER EL BODY UNA SOLA VEZ - CRÃTICO
    const responseText = await response.text();
    console.log('ğŸ“¥ Respuesta raw:', responseText);

    // Parsear manualmente
    let data;
    try {
      data = JSON.parse(responseText);
    } catch (parseError) {
      console.error('Error parseando respuesta:', responseText);
      throw new Error('Respuesta invÃ¡lida del servidor');
    }

    // Verificar Ã©xito
    if (!response.ok) {
      throw new Error(data.error || data.message || 'Error al crear cliente');
    }

    // Ã‰XITO
    console.log('âœ… Cliente creado:', data);
    
    if (typeof toast !== 'undefined') {
      toast.success('Cliente creado exitosamente');
    }
    
    // Callbacks
    onClienteCreado?.(data.cliente || data);
    onClose?.();
    onSuccess?.();

  } catch (err: any) {
    console.error('âŒ Error:', err);
    const errorMsg = err.message || 'Error al crear cliente';
    setError(errorMsg);
    
    if (typeof toast !== 'undefined') {
      toast.error(errorMsg);
    }
  } finally {
    setIsLoading(false);
  }
};
```

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PASO 4: SI USA REACT QUERY O SWR, BUSCAR Y ARREGLAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

```bash
grep -rn "useMutation\|mutate\|useQuery" frontend/src/ --include="*.tsx" | grep -i client
```

Si usa React Query, el problema puede estar ahÃ­. Buscar algo como:

```typescript
// âŒ MAL
const mutation = useMutation({
  mutationFn: async (data) => {
    const res = await fetch('/api/clientes', {...});
    if (!res.ok) {
      const error = await res.json(); // Lee body
      throw new Error(error.message);
    }
    return res.json(); // ERROR: body ya leÃ­do
  }
});
```

REEMPLAZAR CON:

```typescript
// âœ… BIEN
const mutation = useMutation({
  mutationFn: async (data) => {
    const res = await fetch('/api/clientes', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    
    const text = await res.text();
    const json = JSON.parse(text);
    
    if (!res.ok) {
      throw new Error(json.error || 'Error');
    }
    
    return json;
  }
});
```

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PASO 5: VERIFICAR EL BACKEND TAMBIÃ‰N
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

BUSCAR si hay middleware que lee el body dos veces:

```bash
grep -rn "req.body\|bodyParser\|express.json" server/ --include="*.ts" --include="*.js" | head -30
```

VERIFICAR que en server/index.ts el orden sea:

```typescript
// 1. CORS primero
app.use(cors());

// 2. Body parser UNA SOLA VEZ
app.use(express.json());

// 3. Rutas DESPUÃ‰S
app.use('/api/clientes', clientesRoutes);
```

SI HAY body-parser instalado, DESINSTALARLO:

```bash
npm uninstall body-parser
```

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PASO 6: TEST DIRECTO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Probar el endpoint directamente en Shell:

```bash
curl -X POST http://localhost:5000/api/clientes \
  -H "Content-Type: application/json" \
  -d '{"nombre":"TEST","rfc":"XAXX010101000","email":"test@test.com"}'
```

Si esto funciona, el problema estÃ¡ 100% en el frontend.
Si esto falla, el problema estÃ¡ en el backend.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PASO 7: FIX NUCLEAR - SI NADA FUNCIONA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CREAR un archivo nuevo: frontend/src/utils/api.ts

```typescript
// API Helper que NUNCA causa "Body is disturbed"
export async function apiPost<T>(url: string, data: any): Promise<T> {
  const response = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  });

  // Leer como texto primero (NUNCA falla)
  const text = await response.text();
  
  // Parsear
  let json: any;
  try {
    json = text ? JSON.parse(text) : {};
  } catch {
    throw new Error(`Invalid JSON response: ${text.substring(0, 100)}`);
  }

  // Verificar status
  if (!response.ok) {
    throw new Error(json.error || json.message || `HTTP ${response.status}`);
  }

  return json as T;
}

export async function apiGet<T>(url: string): Promise<T> {
  const response = await fetch(url);
  const text = await response.text();
  
  let json: any;
  try {
    json = text ? JSON.parse(text) : {};
  } catch {
    throw new Error(`Invalid JSON response: ${text.substring(0, 100)}`);
  }

  if (!response.ok) {
    throw new Error(json.error || json.message || `HTTP ${response.status}`);
  }

  return json as T;
}
```

USAR ASÃ en el componente:

```typescript
import { apiPost } from '@/utils/api';

const handleCrearCliente = async () => {
  setIsLoading(true);
  try {
    const result = await apiPost('/api/clientes', {
      nombre: formData.nombre,
      rfc: formData.rfc,
      // etc...
    });
    console.log('Cliente creado:', result);
    onSuccess?.();
  } catch (error: any) {
    console.error(error);
    setError(error.message);
  } finally {
    setIsLoading(false);
  }
};
```

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EJECUTAR TODO AHORA - EL CLIENTE DEBE PODER CREARSE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

</TOON>