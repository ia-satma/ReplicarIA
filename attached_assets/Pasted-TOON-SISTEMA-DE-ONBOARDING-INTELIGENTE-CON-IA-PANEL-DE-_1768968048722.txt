TOON: SISTEMA DE ONBOARDING INTELIGENTE CON IA + PANEL DE ADMINISTRACI√ìN

================================================================================
ARQUITECTURA DEL SISTEMA
================================================================================

FLUJO DE ONBOARDING:
1. Usuario abre "Chat de Archivo" 
2. Sube documentos (contratos, facturas, CSF, etc.)
3. Proporciona email del cliente/proveedor
4. IA analiza documentos y extrae datos
5. IA busca en internet datos faltantes (RFC, direcci√≥n, etc.)
6. IA presenta resumen y pide confirmaci√≥n
7. Sistema crea el cliente/proveedor autom√°ticamente
8. Admin puede editar despu√©s desde el panel

================================================================================
PASO 1: CREAR EL CHAT DE ARCHIVO (ONBOARDING INTELIGENTE)
================================================================================

CREAR: client/components/ChatArchivo/ChatArchivo.tsx
```tsx
import { useState, useRef, useEffect } from 'react';
import { 
  Upload, Send, FileText, Mail, Building2, User,
  Loader2, CheckCircle, AlertCircle, Search, Brain,
  Globe, Sparkles, X, Plus, Eye
} from 'lucide-react';

interface Mensaje {
  id: string;
  tipo: 'usuario' | 'sistema' | 'ia';
  contenido: string;
  timestamp: Date;
  archivos?: ArchivoSubido[];
  datosExtraidos?: DatosExtraidos;
  accion?: 'confirmar_creacion' | 'solicitar_email' | 'buscando_web';
}

interface ArchivoSubido {
  id: string;
  nombre: string;
  tipo: string;
  tama√±o: number;
  estado: 'subiendo' | 'analizando' | 'completado' | 'error';
}

interface DatosExtraidos {
  tipo: 'cliente' | 'proveedor';
  nombre?: string;
  rfc?: string;
  razon_social?: string;
  direccion?: string;
  email?: string;
  telefono?: string;
  giro?: string;
  regimen_fiscal?: string;
  sitio_web?: string;
  // Fuentes de los datos
  fuentes: {
    campo: string;
    fuente: 'documento' | 'web' | 'usuario';
    confianza: number;
  }[];
  datosCompletos: boolean;
  datosFaltantes: string[];
}

export function ChatArchivo() {
  const [mensajes, setMensajes] = useState<Mensaje[]>([]);
  const [input, setInput] = useState('');
  const [archivos, setArchivos] = useState<File[]>([]);
  const [loading, setLoading] = useState(false);
  const [emailContacto, setEmailContacto] = useState('');
  const [tipoEntidad, setTipoEntidad] = useState<'cliente' | 'proveedor'>('cliente');
  const [datosActuales, setDatosActuales] = useState<DatosExtraidos | null>(null);
  const [paso, setPaso] = useState<'inicial' | 'subir' | 'analizar' | 'confirmar' | 'completado'>('inicial');
  
  const fileInputRef = useRef<HTMLInputElement>(null);
  const messagesEndRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [mensajes]);

  // Mensaje inicial
  useEffect(() => {
    const bienvenida: Mensaje = {
      id: 'welcome',
      tipo: 'ia',
      contenido: `¬°Hola! üëã Soy el Asistente de Archivo de REVISAR.IA.

Puedo ayudarte a dar de alta nuevos **clientes** o **proveedores** de forma inteligente.

**¬øC√≥mo funciona?**
1. üìÅ Sube los documentos que tengas (contratos, facturas, CSF, etc.)
2. üìß Dame un email de contacto
3. üîç Analizar√© los documentos y buscar√© datos faltantes en internet
4. ‚úÖ Confirmas y creamos el registro autom√°ticamente

**¬øQu√© quieres dar de alta hoy?**`,
      timestamp: new Date()
    };
    setMensajes([bienvenida]);
  }, []);

  // Seleccionar tipo de entidad
  const handleSeleccionarTipo = (tipo: 'cliente' | 'proveedor') => {
    setTipoEntidad(tipo);
    setPaso('subir');
    
    const msg: Mensaje = {
      id: Date.now().toString(),
      tipo: 'ia',
      contenido: `Perfecto, vamos a dar de alta un nuevo **${tipo}**.

üìÅ **Sube los documentos** que tengas disponibles:
- Constancia de Situaci√≥n Fiscal (CSF)
- Contratos
- Facturas
- Acta constitutiva
- Cualquier documento con datos del ${tipo}

Entre m√°s documentos subas, m√°s completa ser√° la informaci√≥n.`,
      timestamp: new Date()
    };
    setMensajes(prev => [...prev, msg]);
  };

  // Manejar archivos seleccionados
  const handleFilesSelected = (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = Array.from(e.target.files || []);
    setArchivos(prev => [...prev, ...files]);
  };

  // Quitar archivo
  const handleQuitarArchivo = (index: number) => {
    setArchivos(prev => prev.filter((_, i) => i !== index));
  };

  // Procesar documentos y analizar
  const handleProcesarDocumentos = async () => {
    if (archivos.length === 0) {
      alert('Por favor sube al menos un documento');
      return;
    }

    setLoading(true);
    setPaso('analizar');

    // Mensaje de usuario con archivos
    const msgUsuario: Mensaje = {
      id: Date.now().toString(),
      tipo: 'usuario',
      contenido: `Sub√≠ ${archivos.length} documento(s)`,
      timestamp: new Date(),
      archivos: archivos.map(f => ({
        id: Math.random().toString(),
        nombre: f.name,
        tipo: f.type,
        tama√±o: f.size,
        estado: 'subiendo'
      }))
    };
    setMensajes(prev => [...prev, msgUsuario]);

    // Mensaje de an√°lisis
    const msgAnalisis: Mensaje = {
      id: (Date.now() + 1).toString(),
      tipo: 'ia',
      contenido: 'üîç Analizando documentos...',
      timestamp: new Date(),
      accion: 'buscando_web'
    };
    setMensajes(prev => [...prev, msgAnalisis]);

    try {
      // Subir y analizar documentos
      const formData = new FormData();
      archivos.forEach(f => formData.append('files', f));
      formData.append('tipo_entidad', tipoEntidad);
      formData.append('email_contacto', emailContacto);

      const response = await fetch('/api/archivo/analizar', {
        method: 'POST',
        body: formData
      });

      const data = await response.json();

      // Actualizar mensaje de an√°lisis
      setMensajes(prev => prev.map(m => 
        m.id === msgAnalisis.id 
          ? {
              ...m,
              contenido: construirMensajeAnalisis(data),
              datosExtraidos: data.datos,
              accion: undefined
            }
          : m
      ));

      setDatosActuales(data.datos);

      // Si faltan datos, buscar en web
      if (data.datos.datosFaltantes?.length > 0) {
        await buscarDatosEnWeb(data.datos);
      } else {
        // Pedir email si no lo tenemos
        if (!emailContacto) {
          solicitarEmail();
        } else {
          mostrarConfirmacion();
        }
      }

    } catch (error: any) {
      const msgError: Mensaje = {
        id: (Date.now() + 2).toString(),
        tipo: 'sistema',
        contenido: `‚ùå Error analizando documentos: ${error.message}`,
        timestamp: new Date()
      };
      setMensajes(prev => [...prev, msgError]);
    } finally {
      setLoading(false);
    }
  };

  // Buscar datos faltantes en internet
  const buscarDatosEnWeb = async (datosActuales: DatosExtraidos) => {
    const msgBusqueda: Mensaje = {
      id: Date.now().toString(),
      tipo: 'ia',
      contenido: `üåê **Buscando datos faltantes en internet...**

Faltan: ${datosActuales.datosFaltantes?.join(', ')}

Usando b√∫squeda web y deep research para encontrar:
- Datos del SAT
- Informaci√≥n p√∫blica de la empresa
- Directorios empresariales`,
      timestamp: new Date(),
      accion: 'buscando_web'
    };
    setMensajes(prev => [...prev, msgBusqueda]);

    try {
      const response = await fetch('/api/archivo/buscar-web', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          datos_actuales: datosActuales,
          campos_faltantes: datosActuales.datosFaltantes
        })
      });

      const data = await response.json();

      // Actualizar datos con lo encontrado en web
      const datosActualizados = { ...datosActuales, ...data.datos_encontrados };
      datosActualizados.fuentes = [
        ...datosActuales.fuentes,
        ...data.fuentes_nuevas
      ];
      datosActualizados.datosFaltantes = data.aun_faltantes || [];
      datosActualizados.datosCompletos = data.aun_faltantes?.length === 0;

      setDatosActuales(datosActualizados);

      // Mensaje con resultados de b√∫squeda web
      const msgResultados: Mensaje = {
        id: (Date.now() + 1).toString(),
        tipo: 'ia',
        contenido: construirMensajeBusquedaWeb(data),
        timestamp: new Date(),
        datosExtraidos: datosActualizados
      };
      setMensajes(prev => prev.map(m => 
        m.id === msgBusqueda.id ? msgResultados : m
      ));

      // Solicitar email o confirmar
      if (!emailContacto) {
        solicitarEmail();
      } else {
        mostrarConfirmacion();
      }

    } catch (error: any) {
      console.error('Error buscando en web:', error);
      // Continuar sin datos web
      if (!emailContacto) {
        solicitarEmail();
      } else {
        mostrarConfirmacion();
      }
    }
  };

  // Solicitar email de contacto
  const solicitarEmail = () => {
    const msg: Mensaje = {
      id: Date.now().toString(),
      tipo: 'ia',
      contenido: `üìß **¬øCu√°l es el email de contacto del ${tipoEntidad}?**

Este email se usar√° para:
- Enviar notificaciones
- Comunicaciones del sistema
- Solicitar documentos adicionales`,
      timestamp: new Date(),
      accion: 'solicitar_email'
    };
    setMensajes(prev => [...prev, msg]);
  };

  // Guardar email y continuar
  const handleGuardarEmail = () => {
    if (!emailContacto || !emailContacto.includes('@')) {
      alert('Por favor ingresa un email v√°lido');
      return;
    }

    const msgUsuario: Mensaje = {
      id: Date.now().toString(),
      tipo: 'usuario',
      contenido: `Email: ${emailContacto}`,
      timestamp: new Date()
    };
    setMensajes(prev => [...prev, msgUsuario]);

    if (datosActuales) {
      setDatosActuales({ ...datosActuales, email: emailContacto });
    }

    mostrarConfirmacion();
  };

  // Mostrar confirmaci√≥n final
  const mostrarConfirmacion = () => {
    setPaso('confirmar');
    
    const msg: Mensaje = {
      id: Date.now().toString(),
      tipo: 'ia',
      contenido: `‚úÖ **¬°Listo! He recopilado la siguiente informaci√≥n:**`,
      timestamp: new Date(),
      datosExtraidos: datosActuales!,
      accion: 'confirmar_creacion'
    };
    setMensajes(prev => [...prev, msg]);
  };

  // Confirmar y crear entidad
  const handleConfirmarCreacion = async () => {
    setLoading(true);

    try {
      const response = await fetch('/api/archivo/crear-entidad', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          tipo: tipoEntidad,
          datos: datosActuales,
          email_contacto: emailContacto,
          archivos_ids: [] // IDs de archivos ya subidos
        })
      });

      const data = await response.json();

      if (!response.ok) throw new Error(data.error);

      setPaso('completado');

      const msgExito: Mensaje = {
        id: Date.now().toString(),
        tipo: 'ia',
        contenido: `üéâ **¬°${tipoEntidad === 'cliente' ? 'Cliente' : 'Proveedor'} creado exitosamente!**

**${datosActuales?.nombre || datosActuales?.razon_social}**
RFC: ${datosActuales?.rfc || 'N/A'}

‚úÖ Registro creado en el sistema
‚úÖ Documentos guardados en su expediente
‚úÖ Knowledge Base inicializado
${emailContacto ? `‚úÖ Se enviar√° email de bienvenida a ${emailContacto}` : ''}

Puedes editar este ${tipoEntidad} desde el **Panel de Administraci√≥n**.

¬øQuieres dar de alta otro ${tipoEntidad === 'cliente' ? 'cliente o proveedor' : 'proveedor o cliente'}?`,
        timestamp: new Date()
      };
      setMensajes(prev => [...prev, msgExito]);

      // Limpiar para nuevo registro
      setArchivos([]);
      setEmailContacto('');
      setDatosActuales(null);

    } catch (error: any) {
      const msgError: Mensaje = {
        id: Date.now().toString(),
        tipo: 'sistema',
        contenido: `‚ùå Error creando ${tipoEntidad}: ${error.message}`,
        timestamp: new Date()
      };
      setMensajes(prev => [...prev, msgError]);
    } finally {
      setLoading(false);
    }
  };

  // Editar campo antes de confirmar
  const handleEditarCampo = (campo: string, valor: string) => {
    if (datosActuales) {
      setDatosActuales({
        ...datosActuales,
        [campo]: valor,
        fuentes: [
          ...datosActuales.fuentes.filter(f => f.campo !== campo),
          { campo, fuente: 'usuario', confianza: 1 }
        ]
      });
    }
  };

  // Construir mensaje de an√°lisis
  const construirMensajeAnalisis = (data: any) => {
    const d = data.datos;
    let msg = `üìä **An√°lisis completado**\n\n`;
    msg += `**Datos extra√≠dos de los documentos:**\n`;
    if (d.nombre) msg += `‚Ä¢ Nombre: ${d.nombre}\n`;
    if (d.rfc) msg += `‚Ä¢ RFC: ${d.rfc}\n`;
    if (d.razon_social) msg += `‚Ä¢ Raz√≥n Social: ${d.razon_social}\n`;
    if (d.direccion) msg += `‚Ä¢ Direcci√≥n: ${d.direccion}\n`;
    if (d.telefono) msg += `‚Ä¢ Tel√©fono: ${d.telefono}\n`;
    if (d.giro) msg += `‚Ä¢ Giro: ${d.giro}\n`;
    
    if (d.datosFaltantes?.length > 0) {
      msg += `\n‚ö†Ô∏è **Datos faltantes:** ${d.datosFaltantes.join(', ')}`;
    }
    
    return msg;
  };

  // Construir mensaje de b√∫squeda web
  const construirMensajeBusquedaWeb = (data: any) => {
    let msg = `üåê **Resultados de b√∫squeda web:**\n\n`;
    
    if (data.datos_encontrados && Object.keys(data.datos_encontrados).length > 0) {
      msg += `**Datos encontrados:**\n`;
      for (const [campo, valor] of Object.entries(data.datos_encontrados)) {
        msg += `‚Ä¢ ${campo}: ${valor}\n`;
      }
    }
    
    if (data.fuentes_nuevas?.length > 0) {
      msg += `\n**Fuentes:**\n`;
      data.fuentes_nuevas.forEach((f: any) => {
        msg += `‚Ä¢ ${f.campo}: ${f.fuente} (${Math.round(f.confianza * 100)}% confianza)\n`;
      });
    }
    
    if (data.aun_faltantes?.length > 0) {
      msg += `\n‚ö†Ô∏è No se encontraron: ${data.aun_faltantes.join(', ')}`;
    } else {
      msg += `\n‚úÖ ¬°Todos los datos completados!`;
    }
    
    return msg;
  };

  return (
    <div className="flex flex-col h-full bg-gray-50">
      {/* Header */}
      <div className="bg-gradient-to-r from-indigo-600 to-purple-600 p-4 text-white">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
            <FileText className="w-5 h-5" />
          </div>
          <div>
            <h2 className="font-bold">Chat de Archivo</h2>
            <p className="text-indigo-200 text-sm">Onboarding inteligente de clientes y proveedores</p>
          </div>
        </div>
      </div>

      {/* Mensajes */}
      <div className="flex-1 overflow-y-auto p-4 space-y-4">
        {mensajes.map((msg) => (
          <div key={msg.id} className={`flex gap-3 ${msg.tipo === 'usuario' ? 'flex-row-reverse' : ''}`}>
            {/* Avatar */}
            <div className={`w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0 ${
              msg.tipo === 'usuario' ? 'bg-blue-100' :
              msg.tipo === 'sistema' ? 'bg-yellow-100' :
              'bg-gradient-to-br from-indigo-500 to-purple-500'
            }`}>
              {msg.tipo === 'usuario' ? (
                <User className="w-4 h-4 text-blue-600" />
              ) : msg.tipo === 'sistema' ? (
                <AlertCircle className="w-4 h-4 text-yellow-600" />
              ) : (
                <Sparkles className="w-4 h-4 text-white" />
              )}
            </div>

            {/* Contenido */}
            <div className={`max-w-[80%] ${msg.tipo === 'usuario' ? 'text-right' : ''}`}>
              <div className={`rounded-2xl px-4 py-3 ${
                msg.tipo === 'usuario' ? 'bg-blue-600 text-white rounded-tr-sm' :
                msg.tipo === 'sistema' ? 'bg-yellow-100 text-yellow-800 rounded-tl-sm' :
                'bg-white shadow-sm border rounded-tl-sm'
              }`}>
                {/* Indicador de b√∫squeda web */}
                {msg.accion === 'buscando_web' && (
                  <div className="flex items-center gap-2 text-indigo-600 mb-2">
                    <Globe className="w-4 h-4 animate-pulse" />
                    <span className="text-sm">Buscando en internet...</span>
                  </div>
                )}

                {/* Contenido del mensaje */}
                <div className="text-sm whitespace-pre-wrap">
                  {msg.contenido.split('\n').map((line, i) => {
                    // Formatear markdown b√°sico
                    let formatted = line
                      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                      .replace(/\*(.*?)\*/g, '<em>$1</em>');
                    return <p key={i} dangerouslySetInnerHTML={{ __html: formatted }} className="mb-1" />;
                  })}
                </div>

                {/* Archivos subidos */}
                {msg.archivos && msg.archivos.length > 0 && (
                  <div className="mt-3 space-y-2">
                    {msg.archivos.map((archivo) => (
                      <div key={archivo.id} className="flex items-center gap-2 bg-gray-50 p-2 rounded-lg text-sm">
                        <FileText className="w-4 h-4 text-gray-400" />
                        <span className="flex-1 truncate">{archivo.nombre}</span>
                        {archivo.estado === 'subiendo' && <Loader2 className="w-4 h-4 animate-spin text-blue-500" />}
                        {archivo.estado === 'completado' && <CheckCircle className="w-4 h-4 text-green-500" />}
                      </div>
                    ))}
                  </div>
                )}
              </div>

              {/* Card de datos extra√≠dos para confirmar */}
              {msg.accion === 'confirmar_creacion' && datosActuales && (
                <div className="mt-3 bg-white border rounded-xl p-4 shadow-sm">
                  <div className="grid grid-cols-2 gap-3 text-sm">
                    <EditableField
                      label="Nombre"
                      value={datosActuales.nombre || ''}
                      onChange={(v) => handleEditarCampo('nombre', v)}
                      fuente={datosActuales.fuentes.find(f => f.campo === 'nombre')}
                    />
                    <EditableField
                      label="RFC"
                      value={datosActuales.rfc || ''}
                      onChange={(v) => handleEditarCampo('rfc', v)}
                      fuente={datosActuales.fuentes.find(f => f.campo === 'rfc')}
                    />
                    <EditableField
                      label="Raz√≥n Social"
                      value={datosActuales.razon_social || ''}
                      onChange={(v) => handleEditarCampo('razon_social', v)}
                      fuente={datosActuales.fuentes.find(f => f.campo === 'razon_social')}
                      className="col-span-2"
                    />
                    <EditableField
                      label="Direcci√≥n"
                      value={datosActuales.direccion || ''}
                      onChange={(v) => handleEditarCampo('direccion', v)}
                      fuente={datosActuales.fuentes.find(f => f.campo === 'direccion')}
                      className="col-span-2"
                    />
                    <EditableField
                      label="Email"
                      value={datosActuales.email || emailContacto || ''}
                      onChange={(v) => { setEmailContacto(v); handleEditarCampo('email', v); }}
                      fuente={datosActuales.fuentes.find(f => f.campo === 'email')}
                    />
                    <EditableField
                      label="Tel√©fono"
                      value={datosActuales.telefono || ''}
                      onChange={(v) => handleEditarCampo('telefono', v)}
                      fuente={datosActuales.fuentes.find(f => f.campo === 'telefono')}
                    />
                    <EditableField
                      label="Giro"
                      value={datosActuales.giro || ''}
                      onChange={(v) => handleEditarCampo('giro', v)}
                      fuente={datosActuales.fuentes.find(f => f.campo === 'giro')}
                    />
                    <EditableField
                      label="Sitio Web"
                      value={datosActuales.sitio_web || ''}
                      onChange={(v) => handleEditarCampo('sitio_web', v)}
                      fuente={datosActuales.fuentes.find(f => f.campo === 'sitio_web')}
                    />
                  </div>

                  <div className="flex gap-3 mt-4 pt-4 border-t">
                    <button
                      onClick={handleConfirmarCreacion}
                      disabled={loading}
                      className="flex-1 flex items-center justify-center gap-2 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50"
                    >
                      {loading ? <Loader2 className="w-5 h-5 animate-spin" /> : <CheckCircle className="w-5 h-5" />}
                      Confirmar y Crear {tipoEntidad === 'cliente' ? 'Cliente' : 'Proveedor'}
                    </button>
                  </div>
                </div>
              )}

              {/* Input de email */}
              {msg.accion === 'solicitar_email' && (
                <div className="mt-3 bg-white border rounded-xl p-4 shadow-sm">
                  <div className="flex gap-2">
                    <input
                      type="email"
                      value={emailContacto}
                      onChange={(e) => setEmailContacto(e.target.value)}
                      placeholder="email@empresa.com"
                      className="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500"
                    />
                    <button
                      onClick={handleGuardarEmail}
                      className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
                    >
                      Continuar
                    </button>
                  </div>
                </div>
              )}
            </div>
          </div>
        ))}

        {/* Loading */}
        {loading && (
          <div className="flex gap-3">
            <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center">
              <Sparkles className="w-4 h-4 text-white" />
            </div>
            <div className="bg-white shadow-sm border rounded-2xl rounded-tl-sm px-4 py-3">
              <div className="flex items-center gap-2 text-sm text-gray-500">
                <Loader2 className="w-4 h-4 animate-spin" />
                Procesando...
              </div>
            </div>
          </div>
        )}

        <div ref={messagesEndRef} />
      </div>

      {/* Botones de selecci√≥n inicial */}
      {paso === 'inicial' && (
        <div className="p-4 border-t bg-white">
          <div className="flex gap-3">
            <button
              onClick={() => handleSeleccionarTipo('cliente')}
              className="flex-1 flex items-center justify-center gap-3 py-4 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-xl hover:shadow-lg transition"
            >
              <User className="w-6 h-6" />
              <span className="font-semibold">Nuevo Cliente</span>
            </button>
            <button
              onClick={() => handleSeleccionarTipo('proveedor')}
              className="flex-1 flex items-center justify-center gap-3 py-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl hover:shadow-lg transition"
            >
              <Building2 className="w-6 h-6" />
              <span className="font-semibold">Nuevo Proveedor</span>
            </button>
          </div>
        </div>
      )}

      {/* √Årea de subida de archivos */}
      {paso === 'subir' && (
        <div className="p-4 border-t bg-white space-y-4">
          {/* Preview de archivos */}
          {archivos.length > 0 && (
            <div className="flex flex-wrap gap-2">
              {archivos.map((file, index) => (
                <div key={index} className="flex items-center gap-2 bg-indigo-50 px-3 py-2 rounded-lg text-sm">
                  <FileText className="w-4 h-4 text-indigo-500" />
                  <span className="max-w-[150px] truncate">{file.name}</span>
                  <button 
                    onClick={() => handleQuitarArchivo(index)}
                    className="text-gray-400 hover:text-red-500"
                  >
                    <X className="w-4 h-4" />
                  </button>
                </div>
              ))}
            </div>
          )}

          <div className="flex gap-3">
            <button
              onClick={() => fileInputRef.current?.click()}
              className="flex items-center gap-2 px-4 py-3 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200"
            >
              <Plus className="w-5 h-5" />
              Agregar Documentos
            </button>
            <input
              ref={fileInputRef}
              type="file"
              multiple
              accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.xml"
              onChange={handleFilesSelected}
              className="hidden"
            />
            
            <button
              onClick={handleProcesarDocumentos}
              disabled={archivos.length === 0 || loading}
              className="flex-1 flex items-center justify-center gap-2 py-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <Brain className="w-5 h-5" />
              Analizar con IA
            </button>
          </div>
        </div>
      )}

      {/* Despu√©s de completado - opci√≥n de nuevo */}
      {paso === 'completado' && (
        <div className="p-4 border-t bg-white">
          <div className="flex gap-3">
            <button
              onClick={() => {
                setPaso('inicial');
                setMensajes([mensajes[0]]);
              }}
              className="flex-1 flex items-center justify-center gap-2 py-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700"
            >
              <Plus className="w-5 h-5" />
              Dar de alta otro
            </button>
          </div>
        </div>
      )}
    </div>
  );
}

// Componente de campo editable
function EditableField({ 
  label, 
  value, 
  onChange, 
  fuente,
  className = ''
}: { 
  label: string; 
  value: string; 
  onChange: (v: string) => void;
  fuente?: { fuente: string; confianza: number };
  className?: string;
}) {
  const [editing, setEditing] = useState(false);

  const fuenteIcon = fuente?.fuente === 'documento' ? 'üìÑ' : 
                     fuente?.fuente === 'web' ? 'üåê' : 
                     fuente?.fuente === 'usuario' ? '‚úèÔ∏è' : '‚ùì';

  return (
    <div className={className}>
      <div className="flex items-center justify-between mb-1">
        <label className="text-xs text-gray-500">{label}</label>
        {fuente && (
          <span className="text-xs text-gray-400" title={`Fuente: ${fuente.fuente}`}>
            {fuenteIcon} {Math.round(fuente.confianza * 100)}%
          </span>
        )}
      </div>
      {editing ? (
        <input
          type="text"
          value={value}
          onChange={(e) => onChange(e.target.value)}
          onBlur={() => setEditing(false)}
          autoFocus
          className="w-full px-2 py-1 border rounded text-sm focus:ring-2 focus:ring-indigo-500"
        />
      ) : (
        <div 
          onClick={() => setEditing(true)}
          className="px-2 py-1 bg-gray-50 rounded cursor-pointer hover:bg-gray-100 text-sm"
        >
          {value || <span className="text-gray-400 italic">Clic para editar</span>}
        </div>
      )}
    </div>
  );
}
```

================================================================================
PASO 2: CREAR ENDPOINTS DE BACKEND PARA ONBOARDING
================================================================================

CREAR: server/routes/archivo.py
```python
from fastapi import APIRouter, UploadFile, File, HTTPException
from typing import List, Optional
from pydantic import BaseModel
import uuid
import json
from datetime import datetime

router = APIRouter()

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# ANALIZAR DOCUMENTOS CON IA
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

@router.post("/analizar")
async def analizar_documentos(
    files: List[UploadFile] = File(...),
    tipo_entidad: str = "cliente",
    email_contacto: Optional[str] = None
):
    """Analiza documentos y extrae datos del cliente/proveedor"""
    from server.services.document_analyzer import analizar_documentos_ia
    from server.services.ocr import extraer_texto_documento
    
    textos_documentos = []
    
    for file in files:
        contenido = await file.read()
        texto = await extraer_texto_documento(contenido, file.filename)
        textos_documentos.append({
            "nombre": file.filename,
            "texto": texto
        })
    
    # Analizar con IA
    datos_extraidos = await analizar_documentos_ia(
        textos_documentos, 
        tipo_entidad
    )
    
    return {
        "datos": datos_extraidos,
        "documentos_analizados": len(files)
    }


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# BUSCAR DATOS FALTANTES EN INTERNET
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

class BuscarWebRequest(BaseModel):
    datos_actuales: dict
    campos_faltantes: List[str]

@router.post("/buscar-web")
async def buscar_datos_web(data: BuscarWebRequest):
    """Busca datos faltantes usando b√∫squeda web y deep research"""
    from server.services.web_search import buscar_datos_empresa
    from server.services.deep_research import investigar_empresa
    
    datos_encontrados = {}
    fuentes_nuevas = []
    aun_faltantes = []
    
    # Informaci√≥n base para buscar
    nombre = data.datos_actuales.get('nombre') or data.datos_actuales.get('razon_social')
    rfc = data.datos_actuales.get('rfc')
    
    if not nombre and not rfc:
        return {
            "datos_encontrados": {},
            "fuentes_nuevas": [],
            "aun_faltantes": data.campos_faltantes
        }
    
    # 1. B√∫squeda web b√°sica
    try:
        resultados_web = await buscar_datos_empresa(nombre, rfc)
        
        for campo in data.campos_faltantes:
            if campo in resultados_web and resultados_web[campo]:
                datos_encontrados[campo] = resultados_web[campo]
                fuentes_nuevas.append({
                    "campo": campo,
                    "fuente": "web",
                    "confianza": resultados_web.get(f"{campo}_confianza", 0.7)
                })
    except Exception as e:
        print(f"Error en b√∫squeda web: {e}")
    
    # 2. Deep Research para datos m√°s espec√≠ficos
    campos_aun_faltantes = [c for c in data.campos_faltantes if c not in datos_encontrados]
    
    if campos_aun_faltantes and (nombre or rfc):
        try:
            resultados_deep = await investigar_empresa(
                nombre=nombre,
                rfc=rfc,
                campos_buscar=campos_aun_faltantes
            )
            
            for campo, valor in resultados_deep.items():
                if valor and campo not in datos_encontrados:
                    datos_encontrados[campo] = valor
                    fuentes_nuevas.append({
                        "campo": campo,
                        "fuente": "deep_research",
                        "confianza": 0.85
                    })
        except Exception as e:
            print(f"Error en deep research: {e}")
    
    # Calcular qu√© sigue faltando
    aun_faltantes = [c for c in data.campos_faltantes if c not in datos_encontrados]
    
    return {
        "datos_encontrados": datos_encontrados,
        "fuentes_nuevas": fuentes_nuevas,
        "aun_faltantes": aun_faltantes
    }


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# CREAR ENTIDAD (CLIENTE O PROVEEDOR)
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

class CrearEntidadRequest(BaseModel):
    tipo: str  # 'cliente' o 'proveedor'
    datos: dict
    email_contacto: str
    archivos_ids: Optional[List[str]] = []

@router.post("/crear-entidad")
async def crear_entidad(data: CrearEntidadRequest):
    """Crea un cliente o proveedor con los datos recopilados"""
    from server.db import db
    
    entidad_id = str(uuid.uuid4())
    empresa_id = str(uuid.uuid4())
    
    try:
        # 1. Crear empresa
        db.execute("""
            INSERT INTO empresas (
                id, nombre, rfc, razon_social, direccion, 
                telefono, email, sitio_web, giro, regimen_fiscal,
                tipo, created_at
            ) VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, NOW())
        """, (
            empresa_id,
            data.datos.get('nombre'),
            data.datos.get('rfc'),
            data.datos.get('razon_social'),
            data.datos.get('direccion'),
            data.datos.get('telefono'),
            data.datos.get('email') or data.email_contacto,
            data.datos.get('sitio_web'),
            data.datos.get('giro'),
            data.datos.get('regimen_fiscal'),
            data.tipo
        ))
        
        # 2. Crear usuario asociado
        usuario_id = str(uuid.uuid4())
        db.execute("""
            INSERT INTO usuarios_autorizados (
                id, email, nombre, rol, estado, empresa_id, created_at
            ) VALUES (%s, %s, %s, %s, 'aprobado', %s, NOW())
        """, (
            usuario_id,
            data.email_contacto,
            data.datos.get('nombre') or data.datos.get('razon_social'),
            data.tipo,  # 'cliente' o 'proveedor'
            empresa_id
        ))
        
        # 3. Guardar metadatos del onboarding
        db.execute("""
            INSERT INTO onboarding_log (
                id, entidad_id, tipo, datos_extraidos, fuentes, created_at
            ) VALUES (%s, %s, %s, %s, %s, NOW())
        """, (
            str(uuid.uuid4()),
            empresa_id,
            data.tipo,
            json.dumps(data.datos),
            json.dumps(data.datos.get('fuentes', []))
        ))
        
        # 4. Enviar email de bienvenida
        from server.services.email import enviar_email_bienvenida
        await enviar_email_bienvenida(
            email=data.email_contacto,
            nombre=data.datos.get('nombre') or data.datos.get('razon_social'),
            tipo=data.tipo
        )
        
        return {
            "success": True,
            "empresa_id": empresa_id,
            "usuario_id": usuario_id,
            "mensaje": f"{data.tipo.capitalize()} creado exitosamente"
        }
        
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
```

================================================================================
PASO 3: CREAR SERVICIOS DE IA PARA AN√ÅLISIS Y B√öSQUEDA
================================================================================

CREAR: server/services/document_analyzer.py
```python
import anthropic
import json
from typing import List, Dict

client = anthropic.Anthropic()

async def analizar_documentos_ia(
    documentos: List[Dict],
    tipo_entidad: str
) -> Dict:
    """Analiza documentos con Claude para extraer datos"""
    
    # Construir prompt con todos los documentos
    textos = "\n\n---DOCUMENTO---\n".join([
        f"Archivo: {d['nombre']}\n{d['texto'][:5000]}"  # Limitar tama√±o
        for d in documentos
    ])
    
    prompt = f"""Analiza los siguientes documentos de un {tipo_entidad} y extrae todos los datos que puedas encontrar.

DOCUMENTOS:
{textos}

Extrae los siguientes datos si est√°n disponibles:
- nombre (nombre comercial)
- rfc (RFC mexicano, 12-13 caracteres)
- razon_social (raz√≥n social completa)
- direccion (direcci√≥n fiscal completa)
- telefono (tel√©fono de contacto)
- email (correo electr√≥nico)
- giro (actividad o giro del negocio)
- regimen_fiscal (r√©gimen fiscal si se menciona)
- sitio_web (p√°gina web si se menciona)

IMPORTANTE:
- Solo extrae datos que est√©n CLARAMENTE en los documentos
- Si un dato no est√° claro, no lo incluyas
- El RFC mexicano tiene formato: 3-4 letras + 6 n√∫meros fecha + 3 caracteres homoclave

Responde SOLO con un JSON v√°lido con esta estructura:
{{
  "nombre": "...",
  "rfc": "...",
  "razon_social": "...",
  "direccion": "...",
  "telefono": "...",
  "email": "...",
  "giro": "...",
  "regimen_fiscal": "...",
  "sitio_web": "...",
  "fuentes": [
    {{"campo": "nombre", "fuente": "documento", "confianza": 0.95}},
    ...
  ],
  "datosFaltantes": ["campo1", "campo2"],
  "datosCompletos": true/false
}}"""

    response = client.messages.create(
        model="claude-sonnet-4-20250514",
        max_tokens=2000,
        messages=[{"role": "user", "content": prompt}]
    )
    
    # Parsear respuesta JSON
    texto_respuesta = response.content[0].text
    
    # Limpiar markdown si existe
    if "```json" in texto_respuesta:
        texto_respuesta = texto_respuesta.split("```json")[1].split("```")[0]
    elif "```" in texto_respuesta:
        texto_respuesta = texto_respuesta.split("```")[1].split("```")[0]
    
    try:
        datos = json.loads(texto_respuesta.strip())
    except:
        datos = {
            "datosFaltantes": ["nombre", "rfc", "direccion", "email"],
            "datosCompletos": False,
            "fuentes": []
        }
    
    # Calcular datos faltantes
    campos_requeridos = ["nombre", "rfc", "email"]
    datos_faltantes = [c for c in campos_requeridos if not datos.get(c)]
    
    # Agregar campos opcionales faltantes
    campos_opcionales = ["direccion", "telefono", "giro"]
    datos_faltantes.extend([c for c in campos_opcionales if not datos.get(c)])
    
    datos["datosFaltantes"] = datos_faltantes
    datos["datosCompletos"] = len([c for c in campos_requeridos if not datos.get(c)]) == 0
    
    return datos
```

CREAR: server/services/web_search.py
```python
import anthropic
import json

client = anthropic.Anthropic()

async def buscar_datos_empresa(nombre: str = None, rfc: str = None) -> Dict:
    """Busca datos de una empresa usando web search de Claude"""
    
    if not nombre and not rfc:
        return {}
    
    query = f"empresa mexicana {nombre or ''} {rfc or ''} datos fiscales direcci√≥n tel√©fono"
    
    response = client.messages.create(
        model="claude-sonnet-4-20250514",
        max_tokens=2000,
        tools=[{
            "type": "web_search_20250305",
            "name": "web_search"
        }],
        messages=[{
            "role": "user",
            "content": f"""Busca informaci√≥n sobre esta empresa mexicana y extrae sus datos:

Nombre: {nombre or 'No proporcionado'}
RFC: {rfc or 'No proporcionado'}

Busca en:
- SAT (si es posible verificar RFC)
- Directorios empresariales
- P√°ginas amarillas
- LinkedIn
- P√°gina web de la empresa

Extrae:
- Direcci√≥n fiscal
- Tel√©fono
- Email de contacto
- Sitio web
- Giro/actividad

Responde con JSON:
{{
  "direccion": "...",
  "telefono": "...",
  "email": "...",
  "sitio_web": "...",
  "giro": "...",
  "direccion_confianza": 0.8,
  "telefono_confianza": 0.7,
  ...
}}"""
        }]
    )
    
    # Procesar respuesta
    texto = ""
    for block in response.content:
        if hasattr(block, 'text'):
            texto += block.text
    
    try:
        # Limpiar y parsear JSON
        if "```json" in texto:
            texto = texto.split("```json")[1].split("```")[0]
        elif "```" in texto:
            texto = texto.split("```")[1].split("```")[0]
        
        return json.loads(texto.strip())
    except:
        return {}
```

CREAR: server/services/deep_research.py
```python
import anthropic
import json
from typing import List, Dict

client = anthropic.Anthropic()

async def investigar_empresa(
    nombre: str = None,
    rfc: str = None,
    campos_buscar: List[str] = None
) -> Dict:
    """Investigaci√≥n profunda de una empresa usando m√∫ltiples b√∫squedas"""
    
    if not nombre and not rfc:
        return {}
    
    campos = campos_buscar or ["direccion", "telefono", "email", "sitio_web", "giro"]
    
    prompt = f"""Realiza una investigaci√≥n profunda sobre esta empresa mexicana:

Nombre: {nombre or 'Desconocido'}
RFC: {rfc or 'Desconocido'}

Necesito encontrar espec√≠ficamente: {', '.join(campos)}

INSTRUCCIONES:
1. Busca el RFC en bases de datos del SAT si es posible
2. Busca la empresa en directorios empresariales mexicanos
3. Busca su p√°gina web oficial
4. Busca en LinkedIn u otras redes profesionales
5. Busca noticias recientes sobre la empresa

Para cada dato encontrado, indica qu√© tan confiable es la fuente (0-1).

Responde SOLO con JSON:
{{
  "direccion": "Direcci√≥n encontrada o null",
  "telefono": "Tel√©fono encontrado o null",
  "email": "Email encontrado o null",
  "sitio_web": "URL encontrada o null",
  "giro": "Actividad encontrada o null",
  "fuentes_consultadas": ["lista de fuentes"],
  "notas": "Observaciones adicionales"
}}"""

    response = client.messages.create(
        model="claude-sonnet-4-20250514",
        max_tokens=3000,
        tools=[{
            "type": "web_search_20250305",
            "name": "web_search"
        }],
        messages=[{"role": "user", "content": prompt}]
    )
    
    # Procesar respuesta
    texto = ""
    for block in response.content:
        if hasattr(block, 'text'):
            texto += block.text
    
    try:
        if "```json" in texto:
            texto = texto.split("```json")[1].split("```")[0]
        elif "```" in texto:
            texto = texto.split("```")[1].split("```")[0]
        
        resultado = json.loads(texto.strip())
        # Filtrar valores nulos
        return {k: v for k, v in resultado.items() if v and v != "null"}
    except:
        return {}
```

================================================================================
PASO 4: REGISTRAR RUTAS EN EL SERVIDOR
================================================================================
```python
# main.py
from server.routes.archivo import router as archivo_router
app.include_router(archivo_router, prefix="/api/archivo", tags=["archivo"])
```

================================================================================
PASO 5: CREAR TABLA DE LOG DE ONBOARDING
================================================================================
```sql
CREATE TABLE IF NOT EXISTS onboarding_log (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    entidad_id UUID,
    tipo VARCHAR(50),
    datos_extraidos JSONB,
    fuentes JSONB,
    documentos_analizados INTEGER,
    busqueda_web BOOLEAN DEFAULT false,
    deep_research BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

================================================================================
PASO 6: AGREGAR CHAT DE ARCHIVO AL MEN√ö/DASHBOARD
================================================================================
```tsx
// En el men√∫ principal, agregar bot√≥n:
{
  icon: FileText,
  label: 'Archivo',
  path: '/archivo',
  color: 'bg-indigo-500'
}

// En App.tsx, agregar ruta:
<Route path="/archivo" element={<ChatArchivo />} />
```

================================================================================
RESUMEN DEL FLUJO COMPLETO
================================================================================

1. USUARIO ABRE CHAT DE ARCHIVO
   ‚Üì
2. SELECCIONA: Cliente o Proveedor
   ‚Üì
3. SUBE DOCUMENTOS (CSF, contratos, facturas)
   ‚Üì
4. IA ANALIZA con Claude:
   - Extrae nombre, RFC, direcci√≥n, etc.
   - Identifica qu√© datos faltan
   ‚Üì
5. IA BUSCA EN INTERNET (Web Search):
   - SAT para verificar RFC
   - Directorios empresariales
   - LinkedIn, p√°gina web
   ‚Üì
6. DEEP RESEARCH si a√∫n faltan datos:
   - M√∫ltiples b√∫squedas
   - Cruce de fuentes
   ‚Üì
7. USUARIO REVISA Y EDITA datos
   ‚Üì
8. CONFIRMA ‚Üí SISTEMA CREA:
   - Empresa en BD
   - Usuario asociado
   - Env√≠a email de bienvenida
   ‚Üì
9. ADMIN PUEDE EDITAR desde Panel:
   - Perfil de empresa
   - Datos del usuario
   - Knowledge Base

================================================================================
EJECUTAR AHORA. NO PREGUNTAR.
================================================================================