TOUR #5: EXPORTACI√ìN PDF DE DEFENSE FILES
Esta es la feature que vende - generar expedientes de defensa fiscal profesionales en PDF para entregar al SAT.

PASO 1: Instalar dependencias
Agreg√° esto a tu requirements.txt o ejecut√°:
bashpip install reportlab==4.1.0 --break-system-packages

PASO 2: Crear el servicio de exportaci√≥n PDF
backend/services/defense_file_export_service.py:
python"""
Servicio de Exportaci√≥n de Defense Files a PDF.
Genera expedientes profesionales para presentar ante el SAT.
"""

import asyncpg
from io import BytesIO
from datetime import datetime
from typing import Optional, List, Dict, Any
import hashlib
import json

from reportlab.lib import colors
from reportlab.lib.pagesizes import letter, A4
from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
from reportlab.lib.units import inch, cm
from reportlab.lib.enums import TA_CENTER, TA_JUSTIFY, TA_RIGHT
from reportlab.platypus import (
    SimpleDocTemplate, Paragraph, Spacer, Table, TableStyle,
    PageBreak, Image, ListFlowable, ListItem, KeepTogether
)
from reportlab.pdfgen import canvas
from reportlab.graphics.shapes import Drawing, Line


class DefenseFileExportService:
    """Genera PDFs profesionales de expedientes de defensa fiscal."""
    
    def __init__(self, db_pool: asyncpg.Pool):
        self.db = db_pool
        self.styles = getSampleStyleSheet()
        self._setup_custom_styles()
    
    def _setup_custom_styles(self):
        """Configura estilos personalizados para el PDF."""
        
        # T√≠tulo principal
        self.styles.add(ParagraphStyle(
            name='DocTitle',
            parent=self.styles['Heading1'],
            fontSize=24,
            spaceAfter=30,
            alignment=TA_CENTER,
            textColor=colors.HexColor('#1a365d')
        ))
        
        # Subt√≠tulo
        self.styles.add(ParagraphStyle(
            name='DocSubtitle',
            parent=self.styles['Normal'],
            fontSize=14,
            spaceAfter=20,
            alignment=TA_CENTER,
            textColor=colors.HexColor('#4a5568')
        ))
        
        # Encabezado de secci√≥n
        self.styles.add(ParagraphStyle(
            name='SectionHeader',
            parent=self.styles['Heading1'],
            fontSize=16,
            spaceBefore=20,
            spaceAfter=12,
            textColor=colors.HexColor('#1a365d'),
            borderPadding=(0, 0, 5, 0)
        ))
        
        # Subsecci√≥n
        self.styles.add(ParagraphStyle(
            name='SubsectionHeader',
            parent=self.styles['Heading2'],
            fontSize=13,
            spaceBefore=15,
            spaceAfter=8,
            textColor=colors.HexColor('#2d3748')
        ))
        
        # Texto legal
        self.styles.add(ParagraphStyle(
            name='LegalText',
            parent=self.styles['Normal'],
            fontSize=10,
            leading=14,
            spaceAfter=8,
            alignment=TA_JUSTIFY
        ))
        
        # Cita de ley
        self.styles.add(ParagraphStyle(
            name='LawQuote',
            parent=self.styles['Normal'],
            fontSize=9,
            leading=12,
            leftIndent=20,
            rightIndent=20,
            spaceAfter=10,
            fontName='Helvetica-Oblique',
            textColor=colors.HexColor('#4a5568'),
            borderPadding=10,
            backColor=colors.HexColor('#f7fafc')
        ))
        
        # Dictamen
        self.styles.add(ParagraphStyle(
            name='Dictamen',
            parent=self.styles['Normal'],
            fontSize=11,
            leading=15,
            spaceBefore=10,
            spaceAfter=10,
            fontName='Helvetica-Bold',
            alignment=TA_CENTER
        ))
        
        # Hash de verificaci√≥n
        self.styles.add(ParagraphStyle(
            name='HashText',
            parent=self.styles['Normal'],
            fontSize=7,
            textColor=colors.grey,
            fontName='Courier'
        ))
        
        # Pie de p√°gina
        self.styles.add(ParagraphStyle(
            name='Footer',
            parent=self.styles['Normal'],
            fontSize=8,
            textColor=colors.grey,
            alignment=TA_CENTER
        ))
    
    async def generate_defense_file_pdf(
        self,
        project_id: str,
        empresa_id: str,
        include_annexes: bool = True
    ) -> BytesIO:
        """
        Genera el PDF completo del expediente de defensa.
        
        Args:
            project_id: ID del proyecto
            empresa_id: ID de la empresa (para validaci√≥n)
            include_annexes: Si incluir anexos detallados
            
        Returns:
            BytesIO con el PDF generado
        """
        
        # 1. Obtener todos los datos necesarios
        project = await self._get_project_data(project_id, empresa_id)
        if not project:
            raise ValueError("Proyecto no encontrado")
        
        empresa = await self._get_empresa_data(empresa_id)
        deliberations = await self._get_deliberations(project_id, empresa_id)
        phases = await self._get_phases(project_id, empresa_id)
        legal_foundations = await self._get_legal_foundations(project)
        
        # 2. Crear documento PDF
        buffer = BytesIO()
        doc = SimpleDocTemplate(
            buffer,
            pagesize=letter,
            rightMargin=0.75*inch,
            leftMargin=0.75*inch,
            topMargin=1*inch,
            bottomMargin=0.75*inch,
            title=f"Expediente de Defensa - {project['nombre']}",
            author="Revisar.IA - SATMA"
        )
        
        # 3. Construir contenido
        story = []
        
        # Portada
        story.extend(self._build_cover_page(project, empresa))
        story.append(PageBreak())
        
        # √çndice
        story.extend(self._build_table_of_contents())
        story.append(PageBreak())
        
        # 1. Resumen Ejecutivo
        story.extend(self._build_executive_summary(project, deliberations, phases))
        story.append(PageBreak())
        
        # 2. Datos del Contribuyente
        story.extend(self._build_taxpayer_section(empresa))
        story.append(PageBreak())
        
        # 3. Descripci√≥n del Servicio
        story.extend(self._build_service_description(project))
        story.append(PageBreak())
        
        # 4. Fundamentos Legales
        story.extend(self._build_legal_foundations(legal_foundations))
        story.append(PageBreak())
        
        # 5. An√°lisis por Agente Especializado
        story.extend(self._build_agent_analyses(deliberations))
        story.append(PageBreak())
        
        # 6. Evidencia de Materialidad
        story.extend(self._build_materiality_evidence(project, phases))
        story.append(PageBreak())
        
        # 7. Matriz de Riesgos
        story.extend(self._build_risk_matrix(project))
        story.append(PageBreak())
        
        # 8. Conclusiones y Dictamen
        story.extend(self._build_conclusions(project, deliberations))
        story.append(PageBreak())
        
        # 9. Cadena de Integridad
        story.extend(self._build_integrity_chain(project_id, project, deliberations))
        
        # 4. Generar PDF
        doc.build(
            story,
            onFirstPage=self._add_header_footer,
            onLaterPages=self._add_header_footer
        )
        
        buffer.seek(0)
        return buffer
    
    # ==================== SECCIONES DEL PDF ====================
    
    def _build_cover_page(self, project: dict, empresa: dict) -> list:
        """Construye la portada del documento."""
        elements = []
        
        elements.append(Spacer(1, 1.5*inch))
        
        # Logo placeholder (puedes agregar logo real)
        elements.append(Paragraph(
            "üìã",
            ParagraphStyle(
                'LogoStyle',
                parent=self.styles['Normal'],
                fontSize=48,
                alignment=TA_CENTER
            )
        ))
        
        elements.append(Spacer(1, 0.3*inch))
        
        # T√≠tulo
        elements.append(Paragraph(
            "EXPEDIENTE DE DEFENSA FISCAL",
            self.styles['DocTitle']
        ))
        
        elements.append(Paragraph(
            "Documentaci√≥n de Soporte para Auditor√≠a SAT",
            self.styles['DocSubtitle']
        ))
        
        elements.append(Spacer(1, 0.5*inch))
        
        # Informaci√≥n del proyecto
        info_data = [
            ["PROYECTO:", project.get('nombre', 'N/A')],
            ["EMPRESA:", empresa.get('nombre', 'N/A')],
            ["RFC:", empresa.get('rfc', 'N/A')],
            ["PROVEEDOR:", project.get('proveedor_nombre', 'N/A')],
            ["RFC PROVEEDOR:", project.get('proveedor_rfc', 'N/A')],
            ["MONTO:", f"${project.get('monto_total', 0):,.2f} {project.get('moneda', 'MXN')}"],
            ["FECHA:", datetime.now().strftime('%d de %B de %Y')],
        ]
        
        info_table = Table(info_data, colWidths=[2*inch, 4*inch])
        info_table.setStyle(TableStyle([
            ('FONTNAME', (0, 0), (0, -1), 'Helvetica-Bold'),
            ('FONTNAME', (1, 0), (1, -1), 'Helvetica'),
            ('FONTSIZE', (0, 0), (-1, -1), 11),
            ('TEXTCOLOR', (0, 0), (0, -1), colors.HexColor('#4a5568')),
            ('TEXTCOLOR', (1, 0), (1, -1), colors.HexColor('#1a202c')),
            ('BOTTOMPADDING', (0, 0), (-1, -1), 8),
            ('TOPPADDING', (0, 0), (-1, -1), 8),
            ('ALIGN', (0, 0), (0, -1), 'RIGHT'),
            ('ALIGN', (1, 0), (1, -1), 'LEFT'),
            ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
        ]))
        
        elements.append(info_table)
        
        elements.append(Spacer(1, 0.5*inch))
        
        # Score de compliance
        risk_score = project.get('risk_score') or project.get('compliance_score') or 0
        score_color = self._get_score_color(risk_score)
        
        elements.append(Paragraph(
            f"SCORE DE COMPLIANCE: <font color='{score_color}'><b>{risk_score}/100</b></font>",
            ParagraphStyle(
                'ScoreStyle',
                parent=self.styles['Normal'],
                fontSize=14,
                alignment=TA_CENTER,
                spaceBefore=20
            )
        ))
        
        # Clasificaci√≥n
        clasificacion = self._get_risk_classification(risk_score)
        elements.append(Paragraph(
            f"Clasificaci√≥n: <b>{clasificacion}</b>",
            ParagraphStyle(
                'ClasStyle',
                parent=self.styles['Normal'],
                fontSize=12,
                alignment=TA_CENTER,
                textColor=colors.HexColor(score_color)
            )
        ))
        
        elements.append(Spacer(1, 1*inch))
        
        # Confidencialidad
        elements.append(Paragraph(
            "<b>DOCUMENTO CONFIDENCIAL</b><br/>"
            "Este expediente contiene informaci√≥n privilegiada para uso exclusivo "
            "en procedimientos de auditor√≠a fiscal ante el SAT.",
            ParagraphStyle(
                'ConfStyle',
                parent=self.styles['Normal'],
                fontSize=9,
                alignment=TA_CENTER,
                textColor=colors.HexColor('#718096'),
                borderWidth=1,
                borderColor=colors.HexColor('#e2e8f0'),
                borderPadding=15
            )
        ))
        
        return elements
    
    def _build_table_of_contents(self) -> list:
        """Construye el √≠ndice del documento."""
        elements = []
        
        elements.append(Paragraph("√çNDICE", self.styles['SectionHeader']))
        elements.append(Spacer(1, 0.2*inch))
        
        toc_items = [
            ("1.", "Resumen Ejecutivo", 3),
            ("2.", "Datos del Contribuyente", 4),
            ("3.", "Descripci√≥n del Servicio Intangible", 5),
            ("4.", "Fundamentos Legales Aplicables", 6),
            ("5.", "An√°lisis por Agente Especializado", 7),
            ("  5.1", "An√°lisis Fiscal (A3)", 7),
            ("  5.2", "An√°lisis Legal (A4)", 8),
            ("  5.3", "Verificaci√≥n de Proveedor (A6)", 9),
            ("6.", "Evidencia de Materialidad", 10),
            ("7.", "Matriz de Riesgos", 11),
            ("8.", "Conclusiones y Dictamen Final", 12),
            ("9.", "Cadena de Integridad", 13),
        ]
        
        toc_data = [[num, title, f"....... {page}"] for num, title, page in toc_items]
        
        toc_table = Table(toc_data, colWidths=[0.5*inch, 4.5*inch, 1*inch])
        toc_table.setStyle(TableStyle([
            ('FONTNAME', (0, 0), (-1, -1), 'Helvetica'),
            ('FONTSIZE', (0, 0), (-1, -1), 11),
            ('TEXTCOLOR', (0, 0), (-1, -1), colors.HexColor('#2d3748')),
            ('BOTTOMPADDING', (0, 0), (-1, -1), 6),
            ('TOPPADDING', (0, 0), (-1, -1), 6),
            ('ALIGN', (0, 0), (0, -1), 'RIGHT'),
            ('ALIGN', (2, 0), (2, -1), 'RIGHT'),
        ]))
        
        elements.append(toc_table)
        
        return elements
    
    def _build_executive_summary(
        self,
        project: dict,
        deliberations: list,
        phases: list
    ) -> list:
        """Construye el resumen ejecutivo."""
        elements = []
        
        elements.append(Paragraph("1. RESUMEN EJECUTIVO", self.styles['SectionHeader']))
        
        # Descripci√≥n general
        elements.append(Paragraph(
            f"El presente expediente documenta la contrataci√≥n del servicio "
            f"<b>\"{project.get('nombre', 'N/A')}\"</b> con el proveedor "
            f"<b>{project.get('proveedor_nombre', 'N/A')}</b> "
            f"(RFC: {project.get('proveedor_rfc', 'N/A')}) por un monto de "
            f"<b>${project.get('monto_total', 0):,.2f} {project.get('moneda', 'MXN')}</b>.",
            self.styles['LegalText']
        ))
        
        elements.append(Spacer(1, 0.2*inch))
        
        # Estado de fases
        elements.append(Paragraph("Estado del Proceso:", self.styles['SubsectionHeader']))
        
        phases_completed = len([p for p in phases if p.get('estado') == 'aprobado'])
        phases_total = len(phases)
        
        phase_data = [["Fase", "Nombre", "Estado"]]
        for phase in phases:
            estado = phase.get('estado', 'pendiente')
            estado_display = "‚úÖ Aprobado" if estado == 'aprobado' else "‚è≥ Pendiente" if estado == 'pendiente' else f"‚ùå {estado}"
            phase_data.append([
                f"F{phase.get('fase', 0)}",
                phase.get('nombre', 'N/A'),
                estado_display
            ])
        
        phase_table = Table(phase_data, colWidths=[0.6*inch, 3*inch, 1.5*inch])
        phase_table.setStyle(TableStyle([
            ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#2d3748')),
            ('TEXTCOLOR', (0, 0), (-1, 0), colors.white),
            ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
            ('FONTNAME', (0, 1), (-1, -1), 'Helvetica'),
            ('FONTSIZE', (0, 0), (-1, -1), 9),
            ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
            ('GRID', (0, 0), (-1, -1), 0.5, colors.HexColor('#e2e8f0')),
            ('BOTTOMPADDING', (0, 0), (-1, -1), 6),
            ('TOPPADDING', (0, 0), (-1, -1), 6),
            ('ROWBACKGROUNDS', (0, 1), (-1, -1), [colors.white, colors.HexColor('#f7fafc')]),
        ]))
        
        elements.append(phase_table)
        
        elements.append(Spacer(1, 0.2*inch))
        
        # Resumen de deliberaciones
        elements.append(Paragraph("Dict√°menes de Agentes:", self.styles['SubsectionHeader']))
        
        agent_summaries = self._summarize_deliberations(deliberations)
        
        for agent_id, summary in agent_summaries.items():
            color = '#10b981' if summary['aprobado'] else '#ef4444'
            elements.append(Paragraph(
                f"<b>{summary['nombre']}</b>: "
                f"<font color='{color}'>{summary['dictamen']}</font>",
                self.styles['LegalText']
            ))
        
        return elements
    
    def _build_taxpayer_section(self, empresa: dict) -> list:
        """Construye la secci√≥n de datos del contribuyente."""
        elements = []
        
        elements.append(Paragraph("2. DATOS DEL CONTRIBUYENTE", self.styles['SectionHeader']))
        
        taxpayer_data = [
            ["Raz√≥n Social:", empresa.get('nombre', 'N/A')],
            ["RFC:", empresa.get('rfc', 'N/A')],
            ["R√©gimen Fiscal:", empresa.get('regimen_fiscal', 'N/A')],
            ["Domicilio Fiscal:", empresa.get('domicilio_fiscal', 'N/A')],
            ["Actividad Preponderante:", empresa.get('actividad_preponderante', 'N/A')],
        ]
        
        taxpayer_table = Table(taxpayer_data, colWidths=[2*inch, 4.5*inch])
        taxpayer_table.setStyle(TableStyle([
            ('FONTNAME', (0, 0), (0, -1), 'Helvetica-Bold'),
            ('FONTNAME', (1, 0), (1, -1), 'Helvetica'),
            ('FONTSIZE', (0, 0), (-1, -1), 10),
            ('BOTTOMPADDING', (0, 0), (-1, -1), 8),
            ('TOPPADDING', (0, 0), (-1, -1), 8),
            ('LINEBELOW', (0, 0), (-1, -1), 0.5, colors.HexColor('#e2e8f0')),
        ]))
        
        elements.append(taxpayer_table)
        
        return elements
    
    def _build_service_description(self, project: dict) -> list:
        """Construye la descripci√≥n del servicio."""
        elements = []
        
        elements.append(Paragraph("3. DESCRIPCI√ìN DEL SERVICIO INTANGIBLE", self.styles['SectionHeader']))
        
        datos_sib = project.get('datos_sib', {}) or {}
        
        elements.append(Paragraph(
            f"<b>Nombre del Servicio:</b> {project.get('nombre', 'N/A')}",
            self.styles['LegalText']
        ))
        
        if project.get('descripcion'):
            elements.append(Paragraph(
                f"<b>Descripci√≥n:</b> {project.get('descripcion')}",
                self.styles['LegalText']
            ))
        
        elements.append(Spacer(1, 0.2*inch))
        
        # Detalles del proveedor
        elements.append(Paragraph("Datos del Proveedor:", self.styles['SubsectionHeader']))
        
        proveedor_data = [
            ["Raz√≥n Social:", project.get('proveedor_nombre', 'N/A')],
            ["RFC:", project.get('proveedor_rfc', 'N/A')],
            ["Monto Contratado:", f"${project.get('monto_total', 0):,.2f} {project.get('moneda', 'MXN')}"],
        ]
        
        prov_table = Table(proveedor_data, colWidths=[1.5*inch, 4*inch])
        prov_table.setStyle(TableStyle([
            ('FONTNAME', (0, 0), (0, -1), 'Helvetica-Bold'),
            ('FONTSIZE', (0, 0), (-1, -1), 10),
            ('BOTTOMPADDING', (0, 0), (-1, -1), 6),
        ]))
        
        elements.append(prov_table)
        
        return elements
    
    def _build_legal_foundations(self, foundations: list) -> list:
        """Construye la secci√≥n de fundamentos legales."""
        elements = []
        
        elements.append(Paragraph("4. FUNDAMENTOS LEGALES APLICABLES", self.styles['SectionHeader']))
        
        elements.append(Paragraph(
            "El presente servicio intangible se sustenta en los siguientes "
            "fundamentos legales del marco fiscal mexicano:",
            self.styles['LegalText']
        ))
        
        for foundation in foundations:
            elements.append(Paragraph(
                f"<b>{foundation['ley']} - {foundation['articulo']}</b>",
                self.styles['SubsectionHeader']
            ))
            
            # Cita de la ley
            elements.append(Paragraph(
                f"<i>\"{foundation['texto']}\"</i>",
                self.styles['LawQuote']
            ))
            
            # Aplicaci√≥n
            if foundation.get('aplicacion'):
                elements.append(Paragraph(
                    f"<b>Aplicaci√≥n al caso:</b> {foundation['aplicacion']}",
                    self.styles['LegalText']
                ))
            
            elements.append(Spacer(1, 0.1*inch))
        
        return elements
    
    def _build_agent_analyses(self, deliberations: list) -> list:
        """Construye la secci√≥n de an√°lisis por agente."""
        elements = []
        
        elements.append(Paragraph("5. AN√ÅLISIS POR AGENTE ESPECIALIZADO", self.styles['SectionHeader']))
        
        # Agrupar deliberaciones por agente
        by_agent = {}
        for d in deliberations:
            agent = d.get('agente_id', 'UNKNOWN')
            if agent not in by_agent:
                by_agent[agent] = []
            by_agent[agent].append(d)
        
        agent_names = {
            'A1_ESTRATEGIA': ('5.1', 'Mar√≠a Rodr√≠guez', 'Sponsor/Estrategia'),
            'A3_FISCAL': ('5.2', 'Laura S√°nchez', 'Especialista Fiscal'),
            'A4_LEGAL': ('5.3', 'Especialista Legal', 'Legal/Contratos'),
            'A5_FINANZAS': ('5.4', 'Roberto Torres', 'An√°lisis Financiero'),
            'A6_PROVEEDOR': ('5.5', 'Ana Garc√≠a', 'Verificaci√≥n Proveedores'),
            'A7_DEFENSA': ('5.6', 'Agente de Defensa', 'Expedientes'),
            'A8_AUDITOR': ('5.7', 'Auditor', 'Compliance'),
        }
        
        for agent_id, delibs in by_agent.items():
            info = agent_names.get(agent_id, ('5.X', agent_id, 'Agente'))
            
            elements.append(Paragraph(
                f"{info[0]} {info[1]} - {info[2]}",
                self.styles['SubsectionHeader']
            ))
            
            for delib in delibs:
                # Fase y tipo
                elements.append(Paragraph(
                    f"<b>Fase {delib.get('fase', 0)} - {delib.get('tipo', 'an√°lisis').upper()}</b>",
                    ParagraphStyle(
                        'DelibHeader',
                        parent=self.styles['Normal'],
                        fontSize=10,
                        fontName='Helvetica-Bold',
                        textColor=colors.HexColor('#4a5568'),
                        spaceBefore=10
                    )
                ))
                
                # Contenido (limitar longitud)
                contenido = delib.get('contenido', '')
                if len(contenido) > 2000:
                    contenido = contenido[:2000] + "... [contin√∫a en anexos]"
                
                elements.append(Paragraph(contenido, self.styles['LegalText']))
                
                # Decisi√≥n si existe
                decision = delib.get('decision', {})
                if decision:
                    aprobado = decision.get('aprobado', False)
                    color = '#10b981' if aprobado else '#ef4444'
                    status = "‚úÖ APROBADO" if aprobado else "‚ùå NO APROBADO"
                    
                    elements.append(Paragraph(
                        f"<font color='{color}'><b>Dictamen: {status}</b></font>",
                        self.styles['Dictamen']
                    ))
                
                elements.append(Spacer(1, 0.1*inch))
        
        return elements
    
    def _build_materiality_evidence(self, project: dict, phases: list) -> list:
        """Construye la secci√≥n de evidencia de materialidad."""
        elements = []
        
        elements.append(Paragraph("6. EVIDENCIA DE MATERIALIDAD", self.styles['SectionHeader']))
        
        elements.append(Paragraph(
            "De conformidad con el Art√≠culo 69-B del C√≥digo Fiscal de la Federaci√≥n, "
            "se documenta la evidencia que demuestra la materialidad del servicio contratado:",
            self.styles['LegalText']
        ))
        
        # Lista de evidencias
        evidencias = [
            "Contrato de servicios firmado con fecha cierta",
            "Orden de compra autorizada",
            "Entregables recibidos y validados",
            "Acta de entrega-recepci√≥n firmada",
            "CFDI(s) correspondientes timbrados",
            "Comprobante de pago bancarizado",
            "Registro contable del gasto",
        ]
        
        for i, evidencia in enumerate(evidencias, 1):
            # Verificar si la fase correspondiente est√° aprobada
            fase_correspondiente = min(i - 1, len(phases) - 1)
            aprobada = phases[fase_correspondiente].get('estado') == 'aprobado' if fase_correspondiente < len(phases) else False
            
            icon = "‚úÖ" if aprobada else "‚è≥"
            elements.append(Paragraph(
                f"{icon} {evidencia}",
                self.styles['LegalText']
            ))
        
        return elements
    
    def _build_risk_matrix(self, project: dict) -> list:
        """Construye la matriz de riesgos."""
        elements = []
        
        elements.append(Paragraph("7. MATRIZ DE RIESGOS", self.styles['SectionHeader']))
        
        scores_detalle = project.get('scores_detalle', {}) or {}
        
        risk_data = [
            ["Pilar de Compliance", "Puntuaci√≥n", "Estado", "Observaciones"]
        ]
        
        pilares = [
            ("Indispensabilidad (Art. 27 LISR)", scores_detalle.get('indispensabilidad', 0), 25),
            ("Materialidad (Art. 69-B CFF)", scores_detalle.get('materialidad', 0), 25),
            ("Bancarizaci√≥n", scores_detalle.get('bancarizacion', 0), 25),
            ("Registro Contable", scores_detalle.get('registro', 0), 25),
        ]
        
        for nombre, score, max_score in pilares:
            pct = (score / max_score * 100) if max_score > 0 else 0
            estado = "üü¢ Bajo" if pct >= 80 else "üü° Medio" if pct >= 60 else "üî¥ Alto"
            obs = "Cumple" if pct >= 80 else "Revisar" if pct >= 60 else "Atenci√≥n requerida"
            
            risk_data.append([nombre, f"{score}/{max_score}", estado, obs])
        
        risk_table = Table(risk_data, colWidths=[2.5*inch, 1*inch, 1*inch, 1.5*inch])
        risk_table.setStyle(TableStyle([
            ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#2d3748')),
            ('TEXTCOLOR', (0, 0), (-1, 0), colors.white),
            ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
            ('FONTNAME', (0, 1), (-1, -1), 'Helvetica'),
            ('FONTSIZE', (0, 0), (-1, -1), 9),
            ('ALIGN', (1, 0), (-1, -1), 'CENTER'),
            ('GRID', (0, 0), (-1, -1), 0.5, colors.HexColor('#e2e8f0')),
            ('BOTTOMPADDING', (0, 0), (-1, -1), 8),
            ('TOPPADDING', (0, 0), (-1, -1), 8),
        ]))
        
        elements.append(risk_table)
        
        return elements
    
    def _build_conclusions(self, project: dict, deliberations: list) -> list:
        """Construye las conclusiones y dictamen final."""
        elements = []
        
        elements.append(Paragraph("8. CONCLUSIONES Y DICTAMEN FINAL", self.styles['SectionHeader']))
        
        risk_score = project.get('risk_score') or project.get('compliance_score') or 0
        
        # Determinar dictamen
        if risk_score >= 80:
            dictamen = "DEDUCIBLE SIN OBSERVACIONES"
            color = '#10b981'
            texto = ("Con base en el an√°lisis realizado por los agentes especializados, "
                    "se concluye que el presente servicio intangible cumple con todos los "
                    "requisitos fiscales para su deducibilidad.")
        elif risk_score >= 60:
            dictamen = "DEDUCIBLE CON OBSERVACIONES"
            color = '#f59e0b'
            texto = ("El servicio intangible es susceptible de deducci√≥n, sin embargo, "
                    "se recomienda atender las observaciones se√±aladas para fortalecer "
                    "la posici√≥n ante una eventual revisi√≥n del SAT.")
        else:
            dictamen = "REQUIERE CORRECCIONES"
            color = '#ef4444'
            texto = ("Se identificaron deficiencias significativas que ponen en riesgo "
                    "la deducibilidad del gasto. Se recomienda implementar las correcciones "
                    "sugeridas antes de considerar el gasto como deducible.")
        
        elements.append(Paragraph(
            f"<font color='{color}' size='14'><b>DICTAMEN: {dictamen}</b></font>",
            ParagraphStyle(
                'DictamenFinal',
                parent=self.styles['Normal'],
                alignment=TA_CENTER,
                spaceBefore=20,
                spaceAfter=20
            )
        ))
        
        elements.append(Paragraph(texto, self.styles['LegalText']))
        
        elements.append(Spacer(1, 0.3*inch))
        
        # Firma digital
        elements.append(Paragraph(
            f"Expediente generado por Revisar.IA<br/>"
            f"Fecha: {datetime.now().strftime('%d de %B de %Y, %H:%M hrs')}<br/>"
            f"Score de Compliance: {risk_score}/100",
            ParagraphStyle(
                'Firma',
                parent=self.styles['Normal'],
                alignment=TA_CENTER,
                fontSize=10,
                textColor=colors.HexColor('#718096')
            )
        ))
        
        return elements
    
    def _build_integrity_chain(
        self,
        project_id: str,
        project: dict,
        deliberations: list
    ) -> list:
        """Construye la cadena de integridad con hash."""
        elements = []
        
        elements.append(Paragraph("9. CADENA DE INTEGRIDAD", self.styles['SectionHeader']))
        
        elements.append(Paragraph(
            "Este expediente cuenta con verificaci√≥n de integridad mediante hash criptogr√°fico. "
            "Cualquier modificaci√≥n posterior al documento invalidar√° esta verificaci√≥n.",
            self.styles['LegalText']
        ))
        
        elements.append(Spacer(1, 0.2*inch))
        
        # Calcular hash del contenido
        content_for_hash = json.dumps({
            "project_id": project_id,
            "project_name": project.get('nombre'),
            "risk_score": project.get('risk_score'),
            "deliberations_count": len(deliberations),
            "generated_at": datetime.utcnow().isoformat()
        }, sort_keys=True)
        
        doc_hash = hashlib.sha256(content_for_hash.encode()).hexdigest()
        
        hash_data = [
            ["Algoritmo:", "SHA-256"],
            ["Hash del Documento:", doc_hash[:32]],
            ["", doc_hash[32:]],
            ["Timestamp:", datetime.utcnow().isoformat() + "Z"],
            ["Project ID:", project_id],
        ]
        
        hash_table = Table(hash_data, colWidths=[1.5*inch, 5*inch])
        hash_table.setStyle(TableStyle([
            ('FONTNAME', (0, 0), (-1, -1), 'Courier'),
            ('FONTSIZE', (0, 0), (-1, -1), 8),
            ('TEXTCOLOR', (0, 0), (-1, -1), colors.grey),
            ('BOTTOMPADDING', (0, 0), (-1, -1), 4),
        ]))
        
        elements.append(hash_table)
        
        elements.append(Spacer(1, 0.2*inch))
        
        elements.append(Paragraph(
            "Para verificar la autenticidad de este documento, contacte a: "
            "verificacion@satma.mx",
            self.styles['HashText']
        ))
        
        return elements
    
    # ==================== HELPERS ====================
    
    def _add_header_footer(self, canvas, doc):
        """Agrega header y footer a cada p√°gina."""
        canvas.saveState()
        
        # Header
        canvas.setFont('Helvetica', 8)
        canvas.setFillColor(colors.HexColor('#718096'))
        canvas.drawString(
            0.75*inch,
            letter[1] - 0.5*inch,
            "EXPEDIENTE DE DEFENSA FISCAL - CONFIDENCIAL"
        )
        canvas.drawRightString(
            letter[0] - 0.75*inch,
            letter[1] - 0.5*inch,
            f"Generado por Revisar.IA"
        )
        
        # L√≠nea separadora header
        canvas.setStrokeColor(colors.HexColor('#e2e8f0'))
        canvas.line(0.75*inch, letter[1] - 0.6*inch, letter[0] - 0.75*inch, letter[1] - 0.6*inch)
        
        # Footer
        canvas.drawString(
            0.75*inch,
            0.4*inch,
            f"Fecha: {datetime.now().strftime('%d/%m/%Y')}"
        )
        canvas.drawCentredString(
            letter[0] / 2,
            0.4*inch,
            f"P√°gina {doc.page}"
        )
        canvas.drawRightString(
            letter[0] - 0.75*inch,
            0.4*inch,
            "¬© SATMA - Revisar.IA"
        )
        
        # L√≠nea separadora footer
        canvas.line(0.75*inch, 0.55*inch, letter[0] - 0.75*inch, 0.55*inch)
        
        canvas.restoreState()
    
    def _get_score_color(self, score: int) -> str:
        """Retorna color basado en score."""
        if score >= 80:
            return '#10b981'  # Verde
        elif score >= 60:
            return '#f59e0b'  # Amarillo
        else:
            return '#ef4444'  # Rojo
    
    def _get_risk_classification(self, score: int) -> str:
        """Retorna clasificaci√≥n de riesgo."""
        if score >= 80:
            return "BAJO RIESGO"
        elif score >= 60:
            return "RIESGO MEDIO"
        else:
            return "ALTO RIESGO"
    
    def _summarize_deliberations(self, deliberations: list) -> dict:
        """Resume deliberaciones por agente."""
        summaries = {}
        
        agent_names = {
            'A3_FISCAL': 'Laura S√°nchez (Fiscal)',
            'A4_LEGAL': 'Legal',
            'A6_PROVEEDOR': 'Ana Garc√≠a (Proveedores)',
        }
        
        for d in deliberations:
            agent = d.get('agente_id')
            if agent not in summaries:
                decision = d.get('decision', {})
                aprobado = decision.get('aprobado', False) if decision else False
                
                summaries[agent] = {
                    'nombre': agent_names.get(agent, agent),
                    'aprobado': aprobado,
                    'dictamen': 'APROBADO' if aprobado else 'PENDIENTE/RECHAZADO'
                }
        
        return summaries
    
    # ==================== DATA FETCHERS ====================
    
    async def _get_project_data(self, project_id: str, empresa_id: str) -> dict:
        """Obtiene datos del proyecto."""
        row = await self.db.fetchrow("""
            SELECT * FROM projects
            WHERE id = $1 AND empresa_id = $2
        """, project_id, empresa_id)
        
        return dict(row) if row else None
    
    async def _get_empresa_data(self, empresa_id: str) -> dict:
        """Obtiene datos de la empresa."""
        row = await self.db.fetchrow("""
            SELECT * FROM empresas
            WHERE id = $1
        """, empresa_id)
        
        return dict(row) if row else {}
    
    async def _get_deliberations(self, project_id: str, empresa_id: str) -> list:
        """Obtiene deliberaciones del proyecto."""
        rows = await self.db.fetch("""
            SELECT * FROM deliberations
            WHERE project_id = $1 AND empresa_id = $2
            ORDER BY fase, created_at
        """, project_id, empresa_id)
        
        return [dict(row) for row in rows]
    
    async def _get_phases(self, project_id: str, empresa_id: str) -> list:
        """Obtiene fases del proyecto."""
        rows = await self.db.fetch("""
            SELECT * FROM project_phases
            WHERE project_id = $1 AND empresa_id = $2
            ORDER BY fase
        """, project_id, empresa_id)
        
        return [dict(row) for row in rows]
    
    async def _get_legal_foundations(self, project: dict) -> list:
        """Obtiene fundamentos legales aplicables."""
        # Fundamentos base para servicios intangibles
        return [
            {
                "ley": "C√≥digo Fiscal de la Federaci√≥n",
                "articulo": "Art√≠culo 5-A",
                "texto": "Los actos jur√≠dicos que carezcan de una raz√≥n de negocios y que generen un beneficio fiscal directo o indirecto, tendr√°n los efectos fiscales que correspondan a los que se habr√≠an realizado para la obtenci√≥n del beneficio econ√≥mico razonablemente esperado.",
                "aplicacion": "El servicio contratado tiene una raz√≥n de negocios leg√≠tima vinculada a las operaciones del contribuyente."
            },
            {
                "ley": "C√≥digo Fiscal de la Federaci√≥n",
                "articulo": "Art√≠culo 69-B",
                "texto": "Cuando la autoridad fiscal detecte que un contribuyente ha estado emitiendo comprobantes sin contar con los activos, personal, infraestructura o capacidad material, directa o indirectamente, para prestar los servicios o producir, comercializar o entregar los bienes que amparan tales comprobantes...",
                "aplicacion": "Se documenta la materialidad del servicio mediante evidencia de entregables, comunicaciones y resultados tangibles."
            },
            {
                "ley": "Ley del Impuesto Sobre la Renta",
                "articulo": "Art√≠culo 27, Fracci√≥n I",
                "texto": "Las deducciones autorizadas en este T√≠tulo deber√°n reunir los siguientes requisitos: I. Ser estrictamente indispensables para los fines de la actividad del contribuyente.",
                "aplicacion": "El servicio es estrictamente indispensable para las operaciones del contribuyente seg√∫n se documenta en el presente expediente."
            },
            {
                "ley": "Ley del Impuesto Sobre la Renta",
                "articulo": "Art√≠culo 27, Fracci√≥n III",
                "texto": "III. Estar amparadas con un comprobante fiscal y que los pagos cuyo monto exceda de $2,000.00 se efect√∫en mediante transferencia electr√≥nica de fondos.",
                "aplicacion": "Los pagos se realizan mediante transferencia bancaria y est√°n amparados con CFDI."
            },
        ]

PASO 3: Crear rutas para exportaci√≥n
backend/routes/defense_files.py:
python"""
Rutas para Defense Files y exportaci√≥n PDF.
"""

from fastapi import APIRouter, Depends, HTTPException
from fastapi.responses import StreamingResponse
from datetime import datetime

from middleware.tenant_context import get_current_user, TenantContext
from services.defense_file_export_service import DefenseFileExportService
from dependencies import get_db_pool

router = APIRouter(prefix="/api/defense-files", tags=["Defense Files"])


@router.get("/projects/{project_id}/pdf")
async def download_defense_file_pdf(
    project_id: str,
    include_annexes: bool = True,
    tenant: TenantContext = Depends(get_current_user),
    db=Depends(get_db_pool)
):
    """
    Genera y descarga el PDF del expediente de defensa.
    
    Args:
        project_id: ID del proyecto
        include_annexes: Si incluir anexos detallados (default: true)
    
    Returns:
        PDF del expediente de defensa
    """
    
    export_service = DefenseFileExportService(db)
    
    try:
        pdf_buffer = await export_service.generate_defense_file_pdf(
            project_id=project_id,
            empresa_id=tenant.empresa_id,
            include_annexes=include_annexes
        )
    except ValueError as e:
        raise HTTPException(status_code=404, detail=str(e))
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Error generando PDF: {str(e)}")
    
    # Generar nombre de archivo
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    filename = f"expediente_defensa_{project_id[:8]}_{timestamp}.pdf"
    
    return StreamingResponse(
        pdf_buffer,
        media_type="application/pdf",
        headers={
            "Content-Disposition": f"attachment; filename={filename}",
            "X-Filename": filename
        }
    )


@router.get("/projects/{project_id}/preview")
async def preview_defense_file(
    project_id: str,
    tenant: TenantContext = Depends(get_current_user),
    db=Depends(get_db_pool)
):
    """
    Retorna los datos que se incluir√≠an en el PDF sin generarlo.
    √ötil para preview en frontend.
    """
    
    # Obtener datos b√°sicos
    project = await db.fetchrow("""
        SELECT * FROM projects
        WHERE id = $1 AND empresa_id = $2
    """, project_id, tenant.empresa_id)
    
    if not project:
        raise HTTPException(status_code=404, detail="Proyecto no encontrado")
    
    # Obtener deliberaciones
    deliberations = await db.fetch("""
        SELECT agente_id, fase, tipo, resumen, decision, created_at
        FROM deliberations
        WHERE project_id = $1 AND empresa_id = $2
        ORDER BY fase, created_at
    """, project_id, tenant.empresa_id)
    
    # Obtener fases
    phases = await db.fetch("""
        SELECT fase, nombre, estado, fecha_completado
        FROM project_phases
        WHERE project_id = $1 AND empresa_id = $2
        ORDER BY fase
    """, project_id, tenant.empresa_id)
    
    return {
        "project": dict(project),
        "deliberations": [dict(d) for d in deliberations],
        "phases": [dict(p) for p in phases],
        "can_generate": True,
        "estimated_pages": 10 + len(deliberations),
    }

PASO 4: Registrar rutas en server.py
python# En backend/server.py

from routes.defense_files import router as defense_files_router

# Agregar router
app.include_router(defense_files_router)

PASO 5: Componente frontend para descargar PDF
frontend/src/components/DefenseFileDownload.jsx:
jsximport { useState } from 'react';
import apiClient from '../api/client';

export function DefenseFileDownload({ projectId, projectName }) {
  const [isGenerating, setIsGenerating] = useState(false);
  const [error, setError] = useState(null);

  const handleDownload = async () => {
    setIsGenerating(true);
    setError(null);

    try {
      const response = await apiClient.get(
        `/defense-files/projects/${projectId}/pdf`,
        {
          responseType: 'blob',
        }
      );

      // Crear URL del blob
      const blob = new Blob([response.data], { type: 'application/pdf' });
      const url = window.URL.createObjectURL(blob);

      // Obtener nombre del archivo del header o generar uno
      const contentDisposition = response.headers['content-disposition'];
      let filename = `expediente_defensa_${projectId.slice(0, 8)}.pdf`;
      
      if (contentDisposition) {
        const matches = /filename=([^;]+)/.exec(contentDisposition);
        if (matches && matches[1]) {
          filename = matches[1].trim();
        }
      }

      // Crear link temporal y descargar
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();

      // Limpiar
      document.body.removeChild(link);
      window.URL.revokeObjectURL(url);
    } catch (err) {
      console.error('Error descargando PDF:', err);
      setError(err.response?.data?.detail || 'Error al generar el PDF');
    } finally {
      setIsGenerating(false);
    }
  };

  return (
    <div className="flex flex-col gap-2">
      <button
        onClick={handleDownload}
        disabled={isGenerating}
        className="flex items-center justify-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
      >
        {isGenerating ? (
          <>
            <svg
              className="w-5 h-5 animate-spin"
              fill="none"
              viewBox="0 0 24 24"
            >
              <circle
                className="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                strokeWidth="4"
              />
              <path
                className="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
              />
            </svg>
            Generando PDF...
          </>
        ) : (
          <>
            <svg
              className="w-5 h-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
              />
            </svg>
            Descargar Expediente PDF
          </>
        )}
      </button>

      {error && (
        <p className="text-sm text-red-600 flex items-center gap-1">
          <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path
              fillRule="evenodd"
              d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
              clipRule="evenodd"
            />
          </svg>
          {error}
        </button>
      )}

      <p className="text-xs text-gray-500 text-center">
        Se generar√° un PDF profesional con todos los an√°lisis y fundamentos legales
      </p>
    </div>
  );
}

‚úÖ CHECKLIST TOUR #5
#TareaEstado1Instalar reportlab‚¨ú2Crear defense_file_export_service.py‚¨ú3Crear routes/defense_files.py‚¨ú4Registrar rutas en server.py‚¨ú5Crear componente DefenseFileDownload.jsx‚¨ú6Probar endpoint /api/defense-files/projects/{id}/pdf‚¨ú7Probar descarga desde frontend‚¨ú

üìã RESUMEN DE TODOS LOS TOURS
TourDescripci√≥nEstado#1RAG con Vector Embeddings (pgvector)‚úÖ#2Refactor Frontend (65K ‚Üí 350 l√≠neas)‚úÖ#3Consolidar DBs (MongoDB ‚Üí PostgreSQL)‚úÖ#4Rate Limiting + Usage Tracking‚úÖ#5Exportaci√≥n PDF Defense Files‚úÖ

üéØ RESULTADO FINAL
Tu plataforma ahora tiene:

RAG Sem√°ntico Real - B√∫squeda por significado, no solo keywords
Frontend Mantenible - Componentes modulares, hooks reutilizables
Una Sola DB - PostgreSQL con JSONB, sin sincronizaci√≥n
Protecci√≥n de Costos - Rate limiting por plan, tracking de uso
Feature de Venta - PDFs profesionales para el SAT