â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”§ ARREGLAR AGENTE DE ONBOARDING - NO RAZONA + NO RECONOCE ADMIN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PROBLEMAS DETECTADOS:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Usuario pregunta "Â¿ya estÃ¡ dada de alta Fortezza?" 
   â†’ Agente IGNORA la pregunta y sigue con su script
   â†’ DEBERÃA buscar en BD si existe el cliente

2. Usuario entra como santiago@satma.mx (admin)
   â†’ Agente NO lo reconoce como administrador
   â†’ DEBERÃA saber quiÃ©n es y ajustar su comportamiento

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PROBLEMA 1: AGENTE CON FLUJO RÃGIDO (NO RAZONA)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

El agente actual tiene un flujo lineal tipo:
  Paso 1 â†’ Paso 2 â†’ Paso 3 â†’ ...

Y IGNORA cualquier pregunta que no encaje en ese flujo.

SOLUCIÃ“N: Agregar "function calling" o lÃ³gica de intenciÃ³n para que:
- Detecte cuando el usuario PREGUNTA algo (no sigue el flujo)
- Busque en la BD antes de responder
- Sea conversacional, no un wizard rÃ­gido

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ARREGLO 1: SISTEMA DE INTENCIONES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Modificar el prompt del agente de onboarding para que detecte intenciones:

```python
SYSTEM_PROMPT_ONBOARDING = """
Eres el Agente de Onboarding de SATMA. Tu trabajo es ayudar a dar de alta 
clientes y proyectos.

IMPORTANTE - ANTES de seguir cualquier flujo, ANALIZA el mensaje del usuario:

1. SI EL USUARIO PREGUNTA SOBRE UN CLIENTE EXISTENTE:
   - Palabras clave: "ya estÃ¡", "existe", "tiene", "registrado", "dado de alta"
   - ACCIÃ“N: Usa la funciÃ³n buscar_cliente() para verificar
   - Ejemplo: "Â¿ya estÃ¡ dada de alta Fortezza?" â†’ buscar_cliente("Fortezza")

2. SI EL USUARIO QUIERE DAR DE ALTA UN CLIENTE NUEVO:
   - Palabras clave: "nuevo cliente", "dar de alta", "registrar"
   - ACCIÃ“N: Inicia flujo de alta

3. SI EL USUARIO PREGUNTA ALGO GENERAL:
   - ACCIÃ“N: Responde la pregunta, no sigas el flujo ciegamente

NUNCA ignores una pregunta del usuario para seguir tu flujo.
SIEMPRE responde lo que el usuario pregunta PRIMERO.

InformaciÃ³n del usuario actual:
- Email: {usuario_email}
- Nombre: {usuario_nombre}
- Es Admin: {es_admin}
- Cliente asociado: {cliente_nombre} (si aplica)
"""
```

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ARREGLO 2: FUNCIÃ“N PARA BUSCAR CLIENTES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

El agente necesita poder buscar en la BD. Agregar herramienta/funciÃ³n:

```python
# En el archivo del agente de onboarding (buscar nombre real del archivo)

from sqlalchemy import text
from database import db  # Ajustar segÃºn tu proyecto

async def buscar_cliente(termino: str) -> dict:
    """
    Busca un cliente por nombre, RFC o nombre comercial.
    El agente debe llamar esto cuando el usuario pregunta si un cliente existe.
    """
    
    result = db.session.execute(text("""
        SELECT 
            id, nombre, rfc, nombre_comercial, email,
            activo, created_at
        FROM clientes
        WHERE 
            LOWER(nombre) LIKE LOWER(:termino)
            OR LOWER(nombre_comercial) LIKE LOWER(:termino)
            OR LOWER(rfc) LIKE LOWER(:termino)
        LIMIT 5
    """), {'termino': f'%{termino}%'})
    
    clientes = []
    for row in result:
        clientes.append({
            'id': row.id,
            'nombre': row.nombre,
            'rfc': row.rfc,
            'nombre_comercial': row.nombre_comercial,
            'email': row.email,
            'activo': row.activo
        })
    
    if clientes:
        return {
            'encontrado': True,
            'clientes': clientes,
            'mensaje': f"EncontrÃ© {len(clientes)} cliente(s) que coinciden con '{termino}'"
        }
    else:
        return {
            'encontrado': False,
            'clientes': [],
            'mensaje': f"No encontrÃ© ningÃºn cliente con '{termino}'. Â¿Quieres darlo de alta?"
        }


# Si usas function calling de Claude/OpenAI:
TOOLS_ONBOARDING = [
    {
        "name": "buscar_cliente",
        "description": "Busca si un cliente ya existe en el sistema por nombre, RFC o nombre comercial. Usar cuando el usuario pregunta si un cliente ya estÃ¡ registrado.",
        "input_schema": {
            "type": "object",
            "properties": {
                "termino": {
                    "type": "string",
                    "description": "Nombre, RFC o tÃ©rmino a buscar"
                }
            },
            "required": ["termino"]
        }
    },
    {
        "name": "obtener_info_usuario",
        "description": "Obtiene informaciÃ³n del usuario actual (nombre, email, si es admin, cliente asociado)",
        "input_schema": {
            "type": "object",
            "properties": {}
        }
    }
]
```

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PROBLEMA 2: NO RECONOCE AL ADMINISTRADOR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

El agente no sabe quiÃ©n es el usuario que estÃ¡ hablando.
Necesita recibir el contexto del usuario autenticado.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ARREGLO 3: PASAR CONTEXTO DE USUARIO AL AGENTE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Buscar el archivo de rutas del onboarding y modificar para pasar el usuario:

```python
# En el endpoint de chat del onboarding

@router.post("/chat")
async def chat_onboarding(request: Request, body: ChatRequest):
    mensaje = body.message
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # OBTENER USUARIO ACTUAL DE LA SESIÃ“N/TOKEN
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    # OpciÃ³n 1: Si usas JWT/token en header
    token = request.headers.get('Authorization', '').replace('Bearer ', '')
    usuario = await obtener_usuario_de_token(token)
    
    # OpciÃ³n 2: Si usas sesiÃ³n
    # usuario = await obtener_usuario_de_sesion(request)
    
    # OpciÃ³n 3: Si viene en el body
    # usuario_id = body.usuario_id
    # usuario = await obtener_usuario_por_id(usuario_id)
    
    if not usuario:
        # Usuario no autenticado - manejar como guest
        usuario = {
            'id': None,
            'email': 'guest',
            'nombre': 'Usuario',
            'is_admin': False,
            'cliente_id': None,
            'cliente_nombre': None
        }
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # CONSTRUIR CONTEXTO PARA EL AGENTE
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    contexto_usuario = f"""
    USUARIO ACTUAL:
    - Email: {usuario['email']}
    - Nombre: {usuario['nombre']}
    - Es Administrador: {'SÃ' if usuario['is_admin'] else 'NO'}
    - Cliente asociado: {usuario.get('cliente_nombre', 'Ninguno')}
    
    {'âš ï¸ Este usuario es ADMINISTRADOR, tiene acceso completo.' if usuario['is_admin'] else ''}
    """
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # LLAMAR AL MODELO CON CONTEXTO
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    system_prompt = SYSTEM_PROMPT_ONBOARDING.format(
        usuario_email=usuario['email'],
        usuario_nombre=usuario['nombre'],
        es_admin='SÃ' if usuario['is_admin'] else 'NO',
        cliente_nombre=usuario.get('cliente_nombre', 'Ninguno')
    )
    
    # Agregar contexto al system prompt
    system_prompt_completo = system_prompt + "\n\n" + contexto_usuario
    
    # Llamar a Claude/modelo
    respuesta = await llamar_modelo(
        system=system_prompt_completo,
        messages=[{"role": "user", "content": mensaje}],
        tools=TOOLS_ONBOARDING  # Para que pueda buscar clientes
    )
    
    return {"response": respuesta}


async def obtener_usuario_de_token(token: str) -> dict:
    """Obtiene usuario desde JWT token"""
    
    if not token:
        return None
    
    try:
        # Decodificar token (ajustar segÃºn tu implementaciÃ³n)
        import jwt
        payload = jwt.decode(token, SECRET_KEY, algorithms=['HS256'])
        user_id = payload.get('user_id') or payload.get('sub')
        
        if not user_id:
            return None
        
        # Buscar usuario en BD
        result = db.session.execute(text("""
            SELECT u.id, u.email, u.nombre, u.is_admin, u.cliente_id,
                   c.nombre as cliente_nombre
            FROM users u
            LEFT JOIN clientes c ON u.cliente_id = c.id
            WHERE u.id = :id
        """), {'id': user_id}).fetchone()
        
        if result:
            return {
                'id': result.id,
                'email': result.email,
                'nombre': result.nombre,
                'is_admin': result.is_admin,
                'cliente_id': result.cliente_id,
                'cliente_nombre': result.cliente_nombre
            }
        
    except Exception as e:
        print(f"Error decodificando token: {e}")
    
    return None
```

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ARREGLO 4: PROMPT MEJORADO QUE RAZONA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

```python
SYSTEM_PROMPT_ONBOARDING_MEJORADO = """
Eres el Agente de Onboarding de SATMA. Ayudas a dar de alta clientes y proyectos.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
INFORMACIÃ“N DEL USUARIO ACTUAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Email: {usuario_email}
Nombre: {usuario_nombre}
Es Administrador: {es_admin}
Cliente asociado: {cliente_nombre}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
REGLAS CRÃTICAS - LEE ESTO PRIMERO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. NUNCA ignores una pregunta del usuario para seguir un flujo predefinido.

2. Si el usuario PREGUNTA algo (usa signos de interrogaciÃ³n o palabras como 
   "ya estÃ¡", "existe", "tiene", "cuÃ¡ntos", "cuÃ¡l"):
   - PRIMERO responde su pregunta
   - USA las herramientas disponibles para buscar informaciÃ³n
   - DESPUÃ‰S ofrece continuar con lo que necesite

3. Si el usuario menciona un nombre de empresa/cliente:
   - SIEMPRE usa buscar_cliente() para verificar si ya existe
   - Informa si encontraste o no el cliente
   - Si existe, muestra los datos y pregunta si quiere hacer algo con Ã©l
   - Si no existe, ofrece darlo de alta

4. Si el usuario es ADMINISTRADOR (is_admin = SÃ):
   - Puede ver todos los clientes
   - Puede crear cualquier cliente
   - Puede modificar configuraciones
   - TrÃ¡talo con el contexto de que tiene acceso completo

5. Si el usuario NO es admin pero tiene cliente asociado:
   - Solo puede ver informaciÃ³n de su cliente
   - No puede crear otros clientes

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
HERRAMIENTAS DISPONIBLES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

- buscar_cliente(termino): Busca clientes por nombre, RFC o nombre comercial
- obtener_info_usuario(): Obtiene info del usuario actual

USA ESTAS HERRAMIENTAS cuando el usuario pregunte sobre clientes existentes.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EJEMPLOS DE CÃ“MO RESPONDER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Usuario: "Â¿Ya estÃ¡ dada de alta Fortezza?"
CORRECTO: [Llamar buscar_cliente("Fortezza")] â†’ "SÃ­, Fortezza ya estÃ¡ registrada 
          con RFC XXX. Â¿Necesitas crear un proyecto para ellos?"
INCORRECTO: "Entendido. Â¿CuÃ¡l es el nombre del cliente?" (ignorar la pregunta)

Usuario: "Quiero dar de alta un cliente nuevo"
CORRECTO: "Perfecto. Â¿CuÃ¡l es el nombre o razÃ³n social del cliente?"

Usuario: "Â¿CuÃ¡ntos clientes tenemos?"
CORRECTO: [Buscar en BD] â†’ "Actualmente hay 4 clientes registrados: ..."
INCORRECTO: "Entendido. Â¿CuÃ¡l es el nombre del cliente?" (ignorar)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""
```

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ARREGLO 5: IMPLEMENTAR FUNCTION CALLING REAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Si usas Claude, agregar tools al llamado:

```python
import anthropic

client = anthropic.Anthropic()

async def llamar_modelo_con_tools(system: str, mensaje: str, historial: list = None):
    """Llama a Claude con function calling para que pueda buscar clientes"""
    
    messages = historial or []
    messages.append({"role": "user", "content": mensaje})
    
    # Definir herramientas
    tools = [
        {
            "name": "buscar_cliente",
            "description": "Busca si un cliente ya existe en el sistema. Usar cuando el usuario pregunta si un cliente estÃ¡ registrado o menciona un nombre de empresa.",
            "input_schema": {
                "type": "object",
                "properties": {
                    "termino": {
                        "type": "string",
                        "description": "Nombre, RFC o tÃ©rmino a buscar"
                    }
                },
                "required": ["termino"]
            }
        },
        {
            "name": "listar_clientes",
            "description": "Lista todos los clientes registrados. Usar cuando el usuario pregunta cuÃ¡ntos clientes hay o quiere ver la lista.",
            "input_schema": {
                "type": "object",
                "properties": {
                    "limite": {
                        "type": "integer",
                        "description": "NÃºmero mÃ¡ximo de clientes a mostrar",
                        "default": 10
                    }
                }
            }
        }
    ]
    
    # Primera llamada
    response = client.messages.create(
        model="claude-sonnet-4-20250514",
        max_tokens=1024,
        system=system,
        tools=tools,
        messages=messages
    )
    
    # Si el modelo quiere usar una herramienta
    while response.stop_reason == "tool_use":
        # Encontrar el tool_use block
        tool_use = next(block for block in response.content if block.type == "tool_use")
        tool_name = tool_use.name
        tool_input = tool_use.input
        
        # Ejecutar la herramienta
        if tool_name == "buscar_cliente":
            resultado = await buscar_cliente(tool_input["termino"])
        elif tool_name == "listar_clientes":
            resultado = await listar_clientes(tool_input.get("limite", 10))
        else:
            resultado = {"error": f"Herramienta {tool_name} no implementada"}
        
        # Agregar resultado al historial
        messages.append({"role": "assistant", "content": response.content})
        messages.append({
            "role": "user",
            "content": [{
                "type": "tool_result",
                "tool_use_id": tool_use.id,
                "content": json.dumps(resultado, ensure_ascii=False)
            }]
        })
        
        # Llamar de nuevo con el resultado
        response = client.messages.create(
            model="claude-sonnet-4-20250514",
            max_tokens=1024,
            system=system,
            tools=tools,
            messages=messages
        )
    
    # Extraer texto de la respuesta final
    texto_respuesta = ""
    for block in response.content:
        if hasattr(block, 'text'):
            texto_respuesta += block.text
    
    return texto_respuesta


async def listar_clientes(limite: int = 10) -> dict:
    """Lista clientes registrados"""
    
    result = db.session.execute(text("""
        SELECT id, nombre, rfc, nombre_comercial, activo
        FROM clientes
        ORDER BY nombre
        LIMIT :limite
    """), {'limite': limite})
    
    clientes = [dict(row._mapping) for row in result]
    
    return {
        'total': len(clientes),
        'clientes': clientes
    }
```

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
DIAGNÃ“STICO: ENCONTRAR EL ARCHIVO CORRECTO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Ejecutar esto para encontrar dÃ³nde estÃ¡ el cÃ³digo del agente de onboarding:

```bash
# Buscar archivos relacionados con onboarding
find backend -name "*onboarding*" -o -name "*alta*" | head -20

# Buscar dÃ³nde estÃ¡ el prompt actual del agente
grep -r "Onboarding\|dar de alta\|nuevo cliente" backend/routes/ --include="*.py" | head -20

# Buscar dÃ³nde se define el system prompt
grep -r "system.*prompt\|SYSTEM_PROMPT" backend/ --include="*.py" | head -20

# Ver estructura de la carpeta de agentes
ls -la backend/services/agentes/ 2>/dev/null || ls -la backend/services/agents/ 2>/dev/null
```

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
CHECKLIST DE IMPLEMENTACIÃ“N
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â–¡ 1. Encontrar archivo del agente de onboarding
â–¡ 2. Agregar funciÃ³n buscar_cliente()
â–¡ 3. Agregar funciÃ³n listar_clientes()
â–¡ 4. Modificar el system prompt para que razone
â–¡ 5. Agregar tools/function calling
â–¡ 6. Pasar contexto del usuario autenticado al agente
â–¡ 7. Probar:
     - "Â¿Ya estÃ¡ dada de alta Fortezza?" â†’ Debe buscar y responder
     - "Â¿CuÃ¡ntos clientes hay?" â†’ Debe listar
     - "Soy admin" â†’ Debe reconocerte

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PRUEBA RÃPIDA DESPUÃ‰S DE IMPLEMENTAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ConversaciÃ³n esperada:

Usuario: "Â¿Ya estÃ¡ dada de alta Fortezza?"

Agente: "DÃ©jame verificar... 
        âœ… SÃ­, Fortezza estÃ¡ registrada:
        - Nombre: Fortezza SA de CV
        - RFC: FOR123456ABC
        - Activo: SÃ­
        
        Â¿Necesitas crear un proyecto para Fortezza o hacer algo mÃ¡s?"

Usuario: "SÃ­, crear proyecto"

Agente: "Perfecto. Â¿QuÃ© tipo de proyecto necesitas para Fortezza?
        1. AuditorÃ­a fiscal
        2. Defensa fiscal
        3. ConsultorÃ­a
        ..."

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
