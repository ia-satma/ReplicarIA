import React from 'react';
import { AlertTriangle, CheckCircle, AlertCircle, XCircle } from 'lucide-react';
import type { RiesgoProveedor } from '@/shared/schemas/proveedor.schema';

interface RiesgoIndicadorProps {
  riesgo: RiesgoProveedor;
  mostrarDetalles?: boolean;
}

export function RiesgoIndicador({ riesgo, mostrarDetalles = true }: RiesgoIndicadorProps) {
  const getColorNivel = (nivel: string) => {
    switch (nivel) {
      case 'bajo': return { bg: 'bg-green-100', text: 'text-green-800', icon: CheckCircle };
      case 'medio': return { bg: 'bg-yellow-100', text: 'text-yellow-800', icon: AlertCircle };
      case 'alto': return { bg: 'bg-orange-100', text: 'text-orange-800', icon: AlertTriangle };
      case 'critico': return { bg: 'bg-red-100', text: 'text-red-800', icon: XCircle };
      default: return { bg: 'bg-gray-100', text: 'text-gray-800', icon: AlertCircle };
    }
  };

  const config = getColorNivel(riesgo.nivelRiesgo);
  const IconoNivel = config.icon;

  const flagsActivos = Object.entries(riesgo.flags)
    .filter(([key, value]) => value === true && !['revisadoManualmente', 'aprobadoConExcepcion'].includes(key))
    .map(([key]) => key);

  const formatearFlag = (flag: string): string => {
    const mapeo: Record<string, string> = {
      proveedorReciente: 'Proveedor reciente (< 12 meses)',
      proveedorMuyReciente: 'Proveedor muy reciente (< 6 meses)',
      capitalVsMontosIncongruente: 'Capital social incongruente con montos',
      sinOpinionCumplimiento: 'Sin opinión de cumplimiento',
      opinionNegativa: 'Opinión de cumplimiento negativa',
      sinRepseSiAplica: 'REPSE requerido pero no presentado',
      repseVencido: 'REPSE vencido',
      domicilioAltoRiesgo: 'Domicilio de alto riesgo',
      rfcEnLista69B: 'RFC en lista 69-B del SAT',
      rfcEnListaEFOS: 'RFC en lista EFOS',
      objetoSocialIncongruente: 'Objeto social no coincide con servicios',
      regimenFiscalIncongruente: 'Régimen fiscal incongruente',
      sinPresenciaDigital: 'Sin presencia digital verificable',
      emailNoCoincideConDominio: 'Email no coincide con dominio web'
    };
    return mapeo[flag] || flag;
  };

  return (
    <div className={`rounded-lg p-4 ${config.bg}`}>
      {/* Header con nivel de riesgo */}
      <div className="flex items-center justify-between mb-4">
        <div className="flex items-center gap-3">
          <IconoNivel className={`h-8 w-8 ${config.text}`} />
          <div>
            <p className={`text-lg font-semibold ${config.text} capitalize`}>
              Riesgo {riesgo.nivelRiesgo}
            </p>
            <p className="text-sm text-gray-600">
              Score general: {riesgo.scoreGeneral}/100
            </p>
          </div>
        </div>
        
        <div className="text-right">
          <p className="text-xs text-gray-500">Materialidad potencial</p>
          <p className={`text-lg font-bold ${
            riesgo.scoreMaterialidadPotencial >= 70 ? 'text-green-600' :
            riesgo.scoreMaterialidadPotencial >= 40 ? 'text-yellow-600' :
            'text-red-600'
          }`}>
            {riesgo.scoreMaterialidadPotencial}%
          </p>
        </div>
      </div>

      {/* Barras de scores */}
      {mostrarDetalles && (
        <>
          <div className="space-y-2 mb-4">
            <ScoreBar label="Fiscal" score={riesgo.scoreFiscal} />
            <ScoreBar label="Legal" score={riesgo.scoreLegal} />
            <ScoreBar label="Operativo" score={riesgo.scoreOperativo} />
          </div>

          {/* Flags activos */}
          {flagsActivos.length > 0 && (
            <div className="mt-4 pt-4 border-t border-gray-200">
              <p className="text-sm font-medium text-gray-700 mb-2">
                Alertas detectadas ({flagsActivos.length}):
              </p>
              <ul className="space-y-1">
                {flagsActivos.map((flag) => (
                  <li key={flag} className="text-xs text-gray-600 flex items-center gap-2">
                    <span className="w-1.5 h-1.5 rounded-full bg-orange-500" />
                    {formatearFlag(flag)}
                  </li>
                ))}
              </ul>
            </div>
          )}
        </>
      )}
    </div>
  );
}

function ScoreBar({ label, score }: { label: string; score: number }) {
  const getColor = (s: number) => {
    if (s >= 70) return 'bg-red-500';
    if (s >= 40) return 'bg-orange-500';
    if (s >= 20) return 'bg-yellow-500';
    return 'bg-green-500';
  };

  return (
    <div className="flex items-center gap-3">
      <span className="text-xs text-gray-600 w-16">{label}</span>
      <div className="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
        <div 
          className={`h-full ${getColor(score)} transition-all duration-500`}
          style={{ width: `${score}%` }}
        />
      </div>
      <span className="text-xs font-medium text-gray-700 w-8 text-right">
        {score}
      </span>
    </div>
  );
}