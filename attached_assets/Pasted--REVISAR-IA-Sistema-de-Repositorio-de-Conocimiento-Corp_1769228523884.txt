# REVISAR.IA - Sistema de Repositorio de Conocimiento Corporativo

## EspecificaciÃ³n TÃ©cnica v1.0

---

## RESUMEN EJECUTIVO

RediseÃ±o integral de la secciÃ³n "Repositorio" de Revisar.IA: se elimina la interfaz tipo chat inoperativa y se implementa un sistema de almacenamiento jerÃ¡rquico tipo "disco duro" con agentes autÃ³nomos de ingesta, clasificaciÃ³n y sincronizaciÃ³n. El sistema incluye pipeline RAG completo con embeddings vectoriales, permitiendo a los agentes fiscales (A1-A7) acceder a conocimiento corporativo indexado con latencia inferior a 2 segundos. La arquitectura define 4 agentes principales, 3 subagentes de soporte, y 8 casos de prueba de flujo de informaciÃ³n.

---

## DIAGRAMA ARQUITECTÃ“NICO

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           CAPA DE ENTRADA                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚   Drag &     â”‚   â”‚   API REST   â”‚   â”‚   Watcher    â”‚   â”‚   Email      â”‚    â”‚
â”‚   â”‚   Drop UI    â”‚   â”‚   /ingest    â”‚   â”‚   S3/FTP     â”‚   â”‚   Inbox      â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚          â”‚                  â”‚                  â”‚                  â”‚             â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                      â”‚                                           â”‚
â”‚                                      â–¼                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                         CAPA DE PROCESAMIENTO                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                    AGENTE DE INGESTA (A-ING)                            â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚   â”‚
â”‚   â”‚  â”‚ Extractor  â”‚  â”‚    OCR     â”‚  â”‚ Normalizer â”‚  â”‚ Validator  â”‚        â”‚   â”‚
â”‚   â”‚  â”‚   Texto    â”‚  â”‚  (Tesser.) â”‚  â”‚  (UTF-8)   â”‚  â”‚  (Schema)  â”‚        â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â”‚   â”‚
â”‚   â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚                                            â”‚
â”‚                                     â–¼                                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                 AGENTE DE CLASIFICACIÃ“N (A-CLAS)                        â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚   â”‚
â”‚   â”‚  â”‚ TaxonomÃ­a  â”‚  â”‚  Entidad   â”‚  â”‚   Tags     â”‚  â”‚  Routing   â”‚        â”‚   â”‚
â”‚   â”‚  â”‚  Fiscal    â”‚  â”‚ Extraction â”‚  â”‚ AutomÃ¡tico â”‚  â”‚  Decision  â”‚        â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â”‚   â”‚
â”‚   â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚                                            â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚          â”‚                          â”‚                          â”‚                â”‚
â”‚          â–¼                          â–¼                          â–¼                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚   â”‚ SUBAGENTE   â”‚           â”‚ SUBAGENTE   â”‚           â”‚ SUBAGENTE   â”‚          â”‚
â”‚   â”‚ Verificador â”‚           â”‚  Resumidor  â”‚           â”‚ Compliance  â”‚          â”‚
â”‚   â”‚   Humano    â”‚           â”‚ AutomÃ¡tico  â”‚           â”‚  Monitor    â”‚          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                     â”‚                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                          CAPA DE ALMACENAMIENTO                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚                                            â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚    â”‚                                                                  â”‚          â”‚
â”‚    â–¼                                                                  â–¼          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚     REPOSITORIO PRINCIPAL        â”‚    â”‚         VECTOR DATABASE          â”‚   â”‚
â”‚ â”‚        (Disco Duro)              â”‚    â”‚      (Pinecone/Milvus)           â”‚   â”‚
â”‚ â”‚                                  â”‚    â”‚                                  â”‚   â”‚
â”‚ â”‚  /empresa                        â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚ â”‚    /info_general                 â”‚    â”‚  â”‚  Embeddings (1536-dim)  â”‚    â”‚   â”‚
â”‚ â”‚    /planeacion_estrategica       â”‚    â”‚  â”‚  - text-embedding-3     â”‚    â”‚   â”‚
â”‚ â”‚    /politicas                    â”‚    â”‚  â”‚  - chunk_size: 512      â”‚    â”‚   â”‚
â”‚ â”‚    /manuales                     â”‚    â”‚  â”‚  - overlap: 50          â”‚    â”‚   â”‚
â”‚ â”‚  /fiscal                         â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚ â”‚    /normativa_sat                â”‚    â”‚                                  â”‚   â”‚
â”‚ â”‚    /criterios_juridicos          â”‚    â”‚  Ãndices:                       â”‚   â”‚
â”‚ â”‚    /casos_precedentes            â”‚    â”‚  - idx_fiscal                   â”‚   â”‚
â”‚ â”‚  /clientes                       â”‚    â”‚  - idx_empresa                  â”‚   â”‚
â”‚ â”‚    /{rfc}/expediente             â”‚    â”‚  - idx_clientes                 â”‚   â”‚
â”‚ â”‚  /proveedores                    â”‚    â”‚  - idx_normativa                â”‚   â”‚
â”‚ â”‚    /{rfc}/documentos             â”‚    â”‚                                  â”‚   â”‚
â”‚ â”‚                                  â”‚    â”‚                                  â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚       METADATA STORE             â”‚    â”‚       PCLOUD POR AGENTE          â”‚   â”‚
â”‚ â”‚     (PostgreSQL/OpenSearch)      â”‚    â”‚    (Knowledge Base Local)        â”‚   â”‚
â”‚ â”‚                                  â”‚    â”‚                                  â”‚   â”‚
â”‚ â”‚  - BÃºsqueda por metadatos        â”‚    â”‚  /pcloud/A1_Sponsor/kb/          â”‚   â”‚
â”‚ â”‚  - Filtros facetados             â”‚    â”‚  /pcloud/A2_PMO/kb/              â”‚   â”‚
â”‚ â”‚  - Full-text search              â”‚    â”‚  /pcloud/A3_Fiscal/kb/           â”‚   â”‚
â”‚ â”‚  - Audit log                     â”‚    â”‚  /pcloud/A4_Legal/kb/            â”‚   â”‚
â”‚ â”‚                                  â”‚    â”‚  /pcloud/A5_Finanzas/kb/         â”‚   â”‚
â”‚ â”‚                                  â”‚    â”‚  /pcloud/A6_Proveedor/kb/        â”‚   â”‚
â”‚ â”‚                                  â”‚    â”‚  /pcloud/A7_Defense/kb/          â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                            CAPA DE ACCESO RAG                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                      AGENTE RAG (A-RAG)                                 â”‚   â”‚
â”‚   â”‚                                                                          â”‚   â”‚
â”‚   â”‚   Query â†’ Embedding â†’ Vector Search â†’ Re-ranking â†’ Context Assembly     â”‚   â”‚
â”‚   â”‚                                                                          â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚   â”‚
â”‚   â”‚   â”‚  Retriever   â”‚ â†’  â”‚  Re-ranker   â”‚ â†’  â”‚   Prompt     â”‚             â”‚   â”‚
â”‚   â”‚   â”‚  (top-k=20)  â”‚    â”‚  (top-k=5)   â”‚    â”‚  Augmenter   â”‚             â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚   â”‚
â”‚   â”‚                                                                          â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚                                            â”‚
â”‚                                     â–¼                                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                    AGENTES CONSUMIDORES                                 â”‚   â”‚
â”‚   â”‚                                                                          â”‚   â”‚
â”‚   â”‚   A1-Sponsor  A2-PMO  A3-Fiscal  A4-Legal  A5-Finanzas  A6-Prov  A7-Def â”‚   â”‚
â”‚   â”‚       â”‚          â”‚        â”‚          â”‚          â”‚          â”‚        â”‚    â”‚   â”‚
â”‚   â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚   â”‚                              â–²                                            â”‚   â”‚
â”‚   â”‚                              â”‚                                            â”‚   â”‚
â”‚   â”‚                    context_augmented_prompt                              â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## COMPONENTES Y RESPONSABILIDADES

| Componente | Tipo | PropÃ³sito | Owner | Responsable Operativo | Entradas | Salidas | SLA |
|------------|------|-----------|-------|----------------------|----------|---------|-----|
| **UI Repositorio** | Frontend | Interfaz drag-drop para carga de archivos, navegaciÃ³n tipo explorador | Equipo Frontend | Dev Frontend Sr. | Archivos del usuario | Payload a API /ingest | Disponibilidad 99.5% |
| **API Gateway** | Backend | Endpoints REST para ingesta, consulta y administraciÃ³n | Equipo Backend | Ingeniero Backend | HTTP Requests | Respuestas JSON/Eventos | Latencia p95 < 200ms |
| **Agente Ingesta (A-ING)** | Agente IA | ExtracciÃ³n de texto, OCR, normalizaciÃ³n, validaciÃ³n de esquema | Equipo de Datos | Ingeniero de Datos | Archivos raw + metadatos | Documento normalizado + texto extraÃ­do | Procesamiento < 30s/doc |
| **Agente ClasificaciÃ³n (A-CLAS)** | Agente IA | TaxonomÃ­a fiscal, extracciÃ³n de entidades, asignaciÃ³n de tags y rutas | Equipo de Datos | Especialista Fiscal | Documento normalizado | Documento clasificado + ruta destino | PrecisiÃ³n > 85% |
| **Agente Sync Pcloud (A-SYNC)** | Agente IA | SincronizaciÃ³n de KB por agente, versionado, referencias cruzadas | Equipo de Datos | Ingeniero de Datos | Documento clasificado | Copia en pcloud + metadato de referencia | Sync < 5s |
| **Agente RAG (A-RAG)** | Agente IA | Retrieval, re-ranking, prompt augmentation para agentes consumidores | Equipo IA | ML Engineer | Query + contexto agente | Contexto aumentado + fuentes | Latencia < 2s |
| **Subagente Verificador Humano** | Subagente | Cola de revisiÃ³n para documentos con clasificaciÃ³n incierta | Equipo QA | Analista de Datos | Docs con confidence < 0.7 | ClasificaciÃ³n validada | SLA humano: 24h |
| **Subagente Resumidor** | Subagente | GeneraciÃ³n automÃ¡tica de resÃºmenes ejecutivos | Equipo IA | ML Engineer | Documento completo | Resumen 200-500 palabras | < 10s/doc |
| **Subagente Compliance** | Subagente | VerificaciÃ³n de nivel de confidencialidad y cumplimiento regulatorio | Equipo Legal | Oficial de Cumplimiento | Documento + metadatos | Flag compliance + alertas | Tiempo real |
| **Vector DB** | Infraestructura | Almacenamiento de embeddings para bÃºsqueda semÃ¡ntica | Equipo Infra | SRE | Embeddings 1536-dim | Resultados similitud | Latencia < 100ms |
| **Metadata Store** | Infraestructura | Ãndice de metadatos, bÃºsqueda facetada, audit log | Equipo Infra | DBA | Metadatos JSON | Resultados bÃºsqueda | Latencia < 50ms |
| **File Storage** | Infraestructura | Almacenamiento de archivos originales y versionados | Equipo Infra | SRE | Archivos binarios | URLs firmadas | Disponibilidad 99.9% |

---

## ESPECIFICACIÃ“N TÃ‰CNICA

### 1. Estructura del Repositorio (Disco Duro)

```
/repositorio/
â”‚
â”œâ”€â”€ /empresa/
â”‚   â”œâ”€â”€ /info_general/
â”‚   â”‚   â”œâ”€â”€ acta_constitutiva.pdf
â”‚   â”‚   â”œâ”€â”€ RFC_empresa.pdf
â”‚   â”‚   â””â”€â”€ organigrama_2024.xlsx
â”‚   â”‚
â”‚   â”œâ”€â”€ /planeacion_estrategica/
â”‚   â”‚   â”œâ”€â”€ plan_2024_2026.pptx
â”‚   â”‚   â”œâ”€â”€ objetivos_Q1_2024.docx
â”‚   â”‚   â””â”€â”€ KPIs_definicion.xlsx
â”‚   â”‚
â”‚   â”œâ”€â”€ /politicas/
â”‚   â”‚   â”œâ”€â”€ politica_gastos.pdf
â”‚   â”‚   â”œâ”€â”€ politica_viajes.pdf
â”‚   â”‚   â””â”€â”€ codigo_etica.pdf
â”‚   â”‚
â”‚   â””â”€â”€ /manuales/
â”‚       â”œâ”€â”€ manual_operaciones.pdf
â”‚       â””â”€â”€ manual_contabilidad.pdf
â”‚
â”œâ”€â”€ /fiscal/
â”‚   â”œâ”€â”€ /normativa_sat/
â”‚   â”‚   â”œâ”€â”€ CFF_2024.pdf
â”‚   â”‚   â”œâ”€â”€ LISR_2024.pdf
â”‚   â”‚   â”œâ”€â”€ LIVA_2024.pdf
â”‚   â”‚   â””â”€â”€ RMF_2024.pdf
â”‚   â”‚
â”‚   â”œâ”€â”€ /criterios_juridicos/
â”‚   â”‚   â”œâ”€â”€ criterios_no_vinculativos_2024.pdf
â”‚   â”‚   â””â”€â”€ tesis_SCJN_intangibles.pdf
â”‚   â”‚
â”‚   â””â”€â”€ /casos_precedentes/
â”‚       â”œâ”€â”€ caso_001_intangibles_aprobado.json
â”‚       â””â”€â”€ caso_002_69B_rechazado.json
â”‚
â”œâ”€â”€ /clientes/
â”‚   â””â”€â”€ /{RFC_CLIENTE}/
â”‚       â”œâ”€â”€ /expediente/
â”‚       â”‚   â”œâ”€â”€ CSF.pdf
â”‚       â”‚   â”œâ”€â”€ estados_financieros/
â”‚       â”‚   â””â”€â”€ contratos/
â”‚       â””â”€â”€ /diagnosticos/
â”‚           â””â”€â”€ /proyecto_{id}/
â”‚
â”œâ”€â”€ /proveedores/
â”‚   â””â”€â”€ /{RFC_PROVEEDOR}/
â”‚       â”œâ”€â”€ CSF.pdf
â”‚       â”œâ”€â”€ opinion_32D.pdf
â”‚       â””â”€â”€ contratos/
â”‚
â””â”€â”€ /pcloud/
    â”œâ”€â”€ /A1_Sponsor/kb/
    â”œâ”€â”€ /A2_PMO/kb/
    â”œâ”€â”€ /A3_Fiscal/kb/
    â”œâ”€â”€ /A4_Legal/kb/
    â”œâ”€â”€ /A5_Finanzas/kb/
    â”œâ”€â”€ /A6_Proveedor/kb/
    â””â”€â”€ /A7_Defense/kb/
```

### 2. ConvenciÃ³n de Nombres

```
{tipo}_{subtipo}_{fecha}_{version}.{ext}

Ejemplos:
- POL_gastos_20240115_v1.pdf
- MAN_contabilidad_20240201_v2.pdf
- NORM_CFF_20240101_v1.pdf
- CSF_XAXX010101000_20240115.pdf
- DIAG_proyecto123_fase3_20240120.json
```

### 3. Esquema de Metadatos

```json
{
  "id": "doc_a1b2c3d4e5f6",
  "titulo": "PolÃ­tica de Gastos de Viaje 2024",
  "tipo_documento": "politica",
  "subtipo": "gastos",
  "formato": "pdf",
  "origen": "upload_manual",
  "propietario_organico": "direccion_finanzas",
  "autor": "CFO",
  "tags": ["gastos", "viajes", "politica_interna", "reembolsos"],
  "nivel_confidencialidad": "interno",
  "fecha_creacion": "2024-01-15T10:30:00Z",
  "fecha_modificacion": "2024-01-15T10:30:00Z",
  "fecha_revision": "2025-01-15T00:00:00Z",
  "fecha_expiracion": null,
  "version": "1.0",
  "versiones_anteriores": [],
  "checksum_sha256": "a1b2c3d4e5f6g7h8i9j0...",
  "tamano_bytes": 245760,
  "paginas": 12,
  "idioma": "es",
  "ruta_repositorio": "/empresa/politicas/POL_gastos_20240115_v1.pdf",
  "ruta_pcloud": {
    "A3_Fiscal": "/pcloud/A3_Fiscal/kb/politicas/POL_gastos.pdf",
    "A5_Finanzas": "/pcloud/A5_Finanzas/kb/politicas/POL_gastos.pdf"
  },
  "vector_ids": ["vec_001", "vec_002", "vec_003"],
  "clasificacion": {
    "categoria_principal": "politica_corporativa",
    "categorias_secundarias": ["fiscal", "finanzas"],
    "confidence_score": 0.92,
    "clasificado_por": "A-CLAS",
    "requiere_revision": false
  },
  "entidades_extraidas": {
    "montos": ["$5,000 MXN", "$50,000 MXN"],
    "fechas": ["2024-01-01", "2024-12-31"],
    "personas": [],
    "organizaciones": ["SAT", "Empresa XYZ"],
    "rfc": []
  },
  "resumen_automatico": "PolÃ­tica que establece los lineamientos para gastos de viaje...",
  "permisos": {
    "lectura": ["admin", "fiscal", "finanzas", "operaciones"],
    "escritura": ["admin", "finanzas"],
    "eliminacion": ["admin"]
  },
  "compliance": {
    "revisado": true,
    "nivel_riesgo": "bajo",
    "notas": null
  },
  "audit_trail": [
    {
      "accion": "creado",
      "timestamp": "2024-01-15T10:30:00Z",
      "usuario": "admin@empresa.com",
      "ip": "192.168.1.100"
    }
  ]
}
```

### 4. Endpoints API

#### POST /api/repository/ingest

Sube un documento al sistema de ingesta.

**Request:**
```json
{
  "archivo": "<base64_encoded_file>",
  "nombre_archivo": "politica_gastos_2024.pdf",
  "metadata_inicial": {
    "titulo": "PolÃ­tica de Gastos de Viaje 2024",
    "tipo_documento": "politica",
    "propietario_organico": "direccion_finanzas",
    "nivel_confidencialidad": "interno",
    "tags": ["gastos", "viajes"]
  },
  "opciones": {
    "forzar_ocr": false,
    "generar_resumen": true,
    "notificar_agentes": ["A3_Fiscal", "A5_Finanzas"]
  }
}
```

**Response (202 Accepted):**
```json
{
  "success": true,
  "job_id": "job_x1y2z3",
  "documento_id": "doc_a1b2c3d4e5f6",
  "estado": "procesando",
  "mensaje": "Documento recibido. Procesamiento iniciado.",
  "webhook_status": "/api/repository/jobs/job_x1y2z3/status",
  "tiempo_estimado_segundos": 25
}
```

#### POST /api/repository/reindex

Fuerza re-indexaciÃ³n de documento(s).

**Request:**
```json
{
  "documento_ids": ["doc_a1b2c3d4e5f6"],
  "opciones": {
    "regenerar_embeddings": true,
    "recalcular_clasificacion": false,
    "actualizar_resumen": true
  }
}
```

**Response (202 Accepted):**
```json
{
  "success": true,
  "job_id": "job_reindex_001",
  "documentos_en_cola": 1,
  "estado": "en_proceso",
  "mensaje": "Re-indexaciÃ³n iniciada para 1 documento(s)."
}
```

#### POST /api/repository/query_rag

Consulta RAG para obtener contexto aumentado.

**Request:**
```json
{
  "query": "Â¿CuÃ¡les son los requisitos para deducir gastos de viaje segÃºn la polÃ­tica interna?",
  "agente_solicitante": "A3_Fiscal",
  "contexto_proyecto": {
    "proyecto_id": "proj_123",
    "cliente_rfc": "XAXX010101000",
    "fase_actual": "F3_analisis_fiscal"
  },
  "parametros_busqueda": {
    "top_k": 5,
    "threshold_similaridad": 0.75,
    "filtros": {
      "tipo_documento": ["politica", "manual", "normativa"],
      "nivel_confidencialidad": ["publico", "interno"]
    },
    "incluir_fuentes": true
  }
}
```

**Response (200 OK):**
```json
{
  "success": true,
  "query_id": "qry_abc123",
  "latencia_ms": 847,
  "contexto_aumentado": "SegÃºn la PolÃ­tica de Gastos de Viaje 2024 (POL_gastos_20240115_v1.pdf), los requisitos para deducciÃ³n incluyen:\n\n1. Comprobante fiscal (CFDI) a nombre de la empresa\n2. RelaciÃ³n de gastos firmada por el viajero\n3. AprobaciÃ³n previa del jefe directo para montos > $5,000 MXN\n4. JustificaciÃ³n de razÃ³n de negocios\n\nAdicional, el Manual de Contabilidad establece...",
  "fuentes": [
    {
      "documento_id": "doc_a1b2c3d4e5f6",
      "titulo": "PolÃ­tica de Gastos de Viaje 2024",
      "ruta": "/empresa/politicas/POL_gastos_20240115_v1.pdf",
      "chunk_id": "chunk_001",
      "score_similaridad": 0.94,
      "texto_relevante": "Los gastos de viaje serÃ¡n deducibles cuando cumplan con..."
    },
    {
      "documento_id": "doc_b2c3d4e5f6g7",
      "titulo": "Manual de Contabilidad",
      "ruta": "/empresa/manuales/MAN_contabilidad_20240201_v2.pdf",
      "chunk_id": "chunk_045",
      "score_similaridad": 0.88,
      "texto_relevante": "El registro contable de gastos de viaje requiere..."
    }
  ],
  "metadatos_consulta": {
    "embeddings_consultados": 1547,
    "documentos_evaluados": 23,
    "chunks_recuperados": 12,
    "chunks_post_rerank": 5
  }
}
```

#### GET /api/repository/browse

Navega el repositorio tipo explorador de archivos.

**Request:**
```
GET /api/repository/browse?path=/empresa/politicas&depth=1
```

**Response (200 OK):**
```json
{
  "success": true,
  "ruta_actual": "/empresa/politicas",
  "contenido": [
    {
      "nombre": "POL_gastos_20240115_v1.pdf",
      "tipo": "archivo",
      "documento_id": "doc_a1b2c3d4e5f6",
      "tamano_bytes": 245760,
      "fecha_modificacion": "2024-01-15T10:30:00Z",
      "nivel_confidencialidad": "interno"
    },
    {
      "nombre": "POL_viajes_20240110_v1.pdf",
      "tipo": "archivo",
      "documento_id": "doc_c3d4e5f6g7h8",
      "tamano_bytes": 189440,
      "fecha_modificacion": "2024-01-10T14:20:00Z",
      "nivel_confidencialidad": "interno"
    }
  ],
  "breadcrumb": [
    {"nombre": "repositorio", "ruta": "/"},
    {"nombre": "empresa", "ruta": "/empresa"},
    {"nombre": "politicas", "ruta": "/empresa/politicas"}
  ],
  "permisos_usuario": {
    "puede_subir": true,
    "puede_eliminar": false,
    "puede_crear_carpeta": true
  }
}
```

### 5. PseudocÃ³digo del Pipeline de Ingesta

```python
# Pipeline de Ingesta - Agente A-ING

async def pipeline_ingesta(archivo_raw: bytes, metadata_inicial: dict) -> DocumentoProcesado:
    """
    Pipeline principal de ingesta de documentos.
    Orquesta extracciÃ³n, normalizaciÃ³n, validaciÃ³n y almacenamiento inicial.
    """
    
    # 1. VALIDACIÃ“N INICIAL
    validar_tamano(archivo_raw, max_mb=50)
    formato = detectar_formato(archivo_raw)
    
    if formato not in FORMATOS_SOPORTADOS:
        raise FormatoNoSoportadoError(formato)
    
    # 2. EXTRACCIÃ“N DE TEXTO
    if formato in ['pdf', 'docx', 'pptx', 'xlsx']:
        texto_extraido = extraer_texto_estructurado(archivo_raw, formato)
    elif formato in ['png', 'jpg', 'tiff']:
        texto_extraido = ejecutar_ocr(archivo_raw)  # Tesseract
    elif formato in ['md', 'txt', 'html']:
        texto_extraido = leer_texto_plano(archivo_raw)
    
    # 3. NORMALIZACIÃ“N
    texto_normalizado = normalizar_texto(texto_extraido)
    texto_normalizado = convertir_encoding_utf8(texto_normalizado)
    idioma = detectar_idioma(texto_normalizado)
    
    # 4. GENERACIÃ“N DE METADATOS BASE
    documento_id = generar_uuid()
    checksum = calcular_sha256(archivo_raw)
    
    metadata = {
        **metadata_inicial,
        'id': documento_id,
        'checksum_sha256': checksum,
        'tamano_bytes': len(archivo_raw),
        'idioma': idioma,
        'fecha_creacion': utc_now(),
        'texto_extraido_chars': len(texto_normalizado)
    }
    
    # 5. ALMACENAMIENTO TEMPORAL
    ruta_temp = guardar_temporal(archivo_raw, documento_id)
    
    # 6. ENVIAR A CLASIFICACIÃ“N
    evento_clasificacion = {
        'documento_id': documento_id,
        'texto': texto_normalizado[:50000],  # Limitar para clasificaciÃ³n
        'metadata': metadata,
        'ruta_temp': ruta_temp
    }
    
    await publicar_evento('cola_clasificacion', evento_clasificacion)
    
    return DocumentoProcesado(
        id=documento_id,
        estado='en_clasificacion',
        metadata=metadata
    )


async def ejecutar_ocr(imagen_bytes: bytes) -> str:
    """Ejecuta OCR con Tesseract + preprocesamiento."""
    
    # Preprocesamiento de imagen
    imagen = cargar_imagen(imagen_bytes)
    imagen = corregir_orientacion(imagen)
    imagen = binarizar(imagen)
    imagen = eliminar_ruido(imagen)
    
    # OCR
    texto = tesseract_ocr(imagen, lang='spa+eng')
    
    # Post-procesamiento
    texto = corregir_errores_comunes(texto)
    
    return texto
```

### 6. PseudocÃ³digo del Clasificador

```python
# Pipeline de ClasificaciÃ³n - Agente A-CLAS

TAXONOMIA_FISCAL = {
    'empresa': ['info_general', 'planeacion_estrategica', 'politicas', 'manuales'],
    'fiscal': ['normativa_sat', 'criterios_juridicos', 'casos_precedentes'],
    'clientes': ['expediente', 'diagnosticos'],
    'proveedores': ['documentos', 'verificaciones']
}

AGENTES_POR_CATEGORIA = {
    'empresa/politicas': ['A3_Fiscal', 'A5_Finanzas'],
    'empresa/manuales': ['A2_PMO', 'A3_Fiscal'],
    'fiscal/normativa_sat': ['A3_Fiscal', 'A4_Legal'],
    'fiscal/criterios_juridicos': ['A3_Fiscal', 'A4_Legal', 'A7_Defense'],
    'clientes/expediente': ['A1_Sponsor', 'A3_Fiscal', 'A6_Proveedor'],
    'proveedores/documentos': ['A6_Proveedor', 'A3_Fiscal']
}


async def pipeline_clasificacion(evento: dict) -> DocumentoClasificado:
    """
    Clasifica documento y determina ruta de almacenamiento + agentes destino.
    """
    
    documento_id = evento['documento_id']
    texto = evento['texto']
    metadata = evento['metadata']
    
    # 1. EXTRACCIÃ“N DE ENTIDADES
    entidades = extraer_entidades_ner(texto)
    entidades['rfc'] = extraer_rfcs(texto)
    entidades['montos'] = extraer_montos(texto)
    entidades['fechas'] = extraer_fechas(texto)
    
    # 2. CLASIFICACIÃ“N CON LLM
    prompt_clasificacion = f"""
    Analiza el siguiente documento y clasifÃ­calo segÃºn la taxonomÃ­a fiscal mexicana.
    
    TAXONOMÃA DISPONIBLE:
    {json.dumps(TAXONOMIA_FISCAL, indent=2)}
    
    TEXTO DEL DOCUMENTO (primeros 5000 caracteres):
    {texto[:5000]}
    
    METADATA PROPORCIONADA:
    {json.dumps(metadata, indent=2)}
    
    Responde en JSON con:
    - categoria_principal: string
    - categorias_secundarias: array
    - confidence_score: float 0-1
    - tags_sugeridos: array
    - razon: string breve
    """
    
    resultado_llm = await llamar_claude(prompt_clasificacion, response_format='json')
    clasificacion = json.loads(resultado_llm)
    
    # 3. VALIDACIÃ“N DE CONFIANZA
    if clasificacion['confidence_score'] < 0.7:
        clasificacion['requiere_revision'] = True
        await encolar_revision_humana(documento_id, clasificacion)
    else:
        clasificacion['requiere_revision'] = False
    
    # 4. DETERMINAR RUTA DE ALMACENAMIENTO
    ruta_repositorio = construir_ruta(
        categoria=clasificacion['categoria_principal'],
        subcategoria=clasificacion.get('subcategoria'),
        metadata=metadata
    )
    
    # 5. DETERMINAR AGENTES DESTINO PARA PCLOUD
    agentes_destino = AGENTES_POR_CATEGORIA.get(
        f"{clasificacion['categoria_principal']}/{clasificacion.get('subcategoria', '')}",
        ['A2_PMO']  # Default: PMO recibe todo
    )
    
    # 6. ACTUALIZAR METADATA
    metadata_actualizada = {
        **metadata,
        'clasificacion': clasificacion,
        'entidades_extraidas': entidades,
        'ruta_repositorio': ruta_repositorio,
        'agentes_destino': agentes_destino
    }
    
    # 7. ENVIAR A ALMACENAMIENTO Y SYNC
    await publicar_evento('cola_almacenamiento', {
        'documento_id': documento_id,
        'metadata': metadata_actualizada,
        'ruta_destino': ruta_repositorio,
        'agentes_pcloud': agentes_destino
    })
    
    return DocumentoClasificado(
        id=documento_id,
        clasificacion=clasificacion,
        ruta=ruta_repositorio,
        agentes=agentes_destino
    )


async def encolar_revision_humana(documento_id: str, clasificacion: dict):
    """Encola documento para revisiÃ³n humana cuando confidence < 0.7"""
    
    await db.insert('cola_revision_humana', {
        'documento_id': documento_id,
        'clasificacion_sugerida': clasificacion,
        'estado': 'pendiente',
        'fecha_encolado': utc_now(),
        'sla_limite': utc_now() + timedelta(hours=24)
    })
    
    await notificar_slack('#revisar-ia-qa', 
        f"ğŸ“‹ Documento {documento_id} requiere revisiÃ³n manual. "
        f"Confidence: {clasificacion['confidence_score']:.2f}")
```

### 7. DefiniciÃ³n RAG

#### Modelo de Embeddings

```yaml
embedding_model:
  provider: "openai"
  model: "text-embedding-3-small"
  dimensions: 1536
  batch_size: 100
  
  alternativas:
    - provider: "cohere"
      model: "embed-multilingual-v3.0"
      dimensions: 1024
      pros: "Mejor para espaÃ±ol, mÃ¡s econÃ³mico"
      cons: "Menor precisiÃ³n en tÃ©rminos tÃ©cnicos fiscales"
      
    - provider: "local"
      model: "sentence-transformers/paraphrase-multilingual-mpnet-base-v2"
      dimensions: 768
      pros: "Sin costo por request, privacidad total"
      cons: "Requiere GPU, menor calidad"
```

#### ConfiguraciÃ³n Vector DB

```yaml
vector_db:
  primary: "pinecone"
  config:
    environment: "us-west1-gcp"
    index_name: "revisar-ia-knowledge"
    metric: "cosine"
    pods: 1
    replicas: 1
    pod_type: "p1.x1"
    
  alternativa:
    provider: "milvus"
    config:
      host: "milvus.revisar-ia.internal"
      port: 19530
      collection: "knowledge_base"
      index_type: "IVF_FLAT"
      nlist: 1024
      
  costos_estimados:
    pinecone_10k_queries: "$70/mes (Starter)"
    milvus_self_hosted: "$150/mes (EC2 t3.large)"
```

#### Estrategia de Chunking

```python
CHUNKING_CONFIG = {
    'chunk_size': 512,           # tokens
    'chunk_overlap': 50,         # tokens
    'separators': ['\n\n', '\n', '. ', ' '],
    'length_function': 'tiktoken_cl100k',
    
    # Chunking especial por tipo de documento
    'overrides': {
        'normativa_sat': {
            'chunk_size': 1024,   # ArtÃ­culos completos
            'chunk_overlap': 100,
            'preserve_structure': True  # Mantener numeraciÃ³n de artÃ­culos
        },
        'contratos': {
            'chunk_size': 768,
            'chunk_overlap': 75,
            'preserve_structure': True  # Mantener clÃ¡usulas
        }
    }
}
```

#### Re-ranking Strategy

```python
RERANK_CONFIG = {
    'enabled': True,
    'model': 'cohere-rerank-v3',
    'top_k_initial': 20,      # Candidatos del vector search
    'top_k_final': 5,         # DespuÃ©s de re-rank
    
    'fallback': {
        'model': 'bm25',      # Si Cohere falla
        'top_k': 5
    },
    
    'boost_factors': {
        'mismo_cliente': 1.3,         # Docs del mismo RFC
        'mismo_proyecto': 1.5,        # Docs del proyecto actual
        'normativa_vigente': 1.2,     # Normativa del aÃ±o actual
        'caso_precedente_exitoso': 1.4
    }
}
```

#### Prompt Template RAG

```python
RAG_PROMPT_TEMPLATE = """
<system>
Eres {agente_nombre}, un agente especializado en {agente_especialidad} dentro de la plataforma Revisar.IA.

Tu rol es analizar informaciÃ³n fiscal y proporcionar respuestas precisas basadas ÃšNICAMENTE en el contexto proporcionado.
</system>

<contexto_recuperado>
Los siguientes fragmentos de documentos son relevantes para responder la consulta:

{chunks_formateados}
</contexto_recuperado>

<metadata_proyecto>
- Cliente: {cliente_nombre} (RFC: {cliente_rfc})
- Proyecto: {proyecto_id}
- Fase actual: {fase_actual}
- Monto en anÃ¡lisis: {monto_proyecto}
</metadata_proyecto>

<consulta>
{query_usuario}
</consulta>

<instrucciones>
1. Responde basÃ¡ndote EXCLUSIVAMENTE en el contexto proporcionado
2. Si el contexto no contiene informaciÃ³n suficiente, indÃ­calo claramente
3. Cita las fuentes usando el formato [Fuente: nombre_documento, pÃ¡g. X]
4. MantÃ©n un tono profesional y tÃ©cnico
5. Si hay contradicciones entre fuentes, seÃ±Ã¡lalas
</instrucciones>

Respuesta:
"""
```

---

## DEFINICIÃ“N DE AGENTES Y SUBAGENTES

### Agentes Principales

#### A-ING: Agente de Ingesta

| Campo | Valor |
|-------|-------|
| **Nombre** | A-ING (Agente de Ingesta) |
| **PropÃ³sito** | Recibir, extraer, normalizar y validar documentos entrantes |
| **Owner** | Equipo de Datos |
| **Responsable Operativo** | Ingeniero de Datos Sr. |
| **Entradas** | Archivos raw (PDF, DOCX, XLSX, imÃ¡genes, etc.), metadata inicial |
| **Salidas** | Documento normalizado, texto extraÃ­do, metadata enriquecida |
| **SLA** | Procesamiento < 30 segundos por documento de hasta 50 pÃ¡ginas |
| **Triggers** | POST /api/repository/ingest, Evento S3 PutObject, Watcher FTP |
| **Dependencias** | Tesseract OCR, Apache Tika, Storage temporal |
| **Fallback** | Si extracciÃ³n falla â†’ marcar como "requires_manual_extraction" |

#### A-CLAS: Agente de ClasificaciÃ³n

| Campo | Valor |
|-------|-------|
| **Nombre** | A-CLAS (Agente de ClasificaciÃ³n) |
| **PropÃ³sito** | Clasificar documentos segÃºn taxonomÃ­a fiscal, asignar tags, determinar rutas |
| **Owner** | Equipo de Datos |
| **Responsable Operativo** | Especialista Fiscal / ML Engineer |
| **Entradas** | Documento normalizado + texto + metadata base |
| **Salidas** | ClasificaciÃ³n, tags, ruta repositorio, agentes destino pcloud |
| **SLA** | ClasificaciÃ³n < 10 segundos, PrecisiÃ³n > 85% |
| **Triggers** | Evento cola_clasificacion |
| **Dependencias** | Claude API, TaxonomÃ­a fiscal, NER models |
| **Fallback** | Si confidence < 0.7 â†’ encolar para revisiÃ³n humana |

#### A-SYNC: Agente de SincronizaciÃ³n Pcloud

| Campo | Valor |
|-------|-------|
| **Nombre** | A-SYNC (Agente Sync Pcloud) |
| **PropÃ³sito** | Sincronizar documentos clasificados a pcloud de agentes, mantener referencias |
| **Owner** | Equipo de Datos |
| **Responsable Operativo** | Ingeniero de Datos |
| **Entradas** | Documento clasificado + lista de agentes destino |
| **Salidas** | Copias/referencias en pcloud, metadata actualizada con rutas |
| **SLA** | SincronizaciÃ³n < 5 segundos |
| **Triggers** | Evento cola_almacenamiento |
| **Dependencias** | File Storage, Metadata Store |
| **Fallback** | Retry exponencial hasta 3 intentos, luego alerta |

#### A-RAG: Agente RAG

| Campo | Valor |
|-------|-------|
| **Nombre** | A-RAG (Agente RAG) |
| **PropÃ³sito** | Retrieval semÃ¡ntico, re-ranking, construcciÃ³n de contexto aumentado |
| **Owner** | Equipo IA |
| **Responsable Operativo** | ML Engineer Sr. |
| **Entradas** | Query, agente solicitante, contexto proyecto, filtros |
| **Salidas** | Contexto aumentado, fuentes citadas, scores de relevancia |
| **SLA** | Latencia end-to-end < 2 segundos para top-5 chunks |
| **Triggers** | POST /api/repository/query_rag, Llamada interna de agentes A1-A7 |
| **Dependencias** | Vector DB, Embedding model, Re-ranker, Metadata Store |
| **Fallback** | Si Vector DB falla â†’ bÃºsqueda BM25 en metadata |

### Subagentes

#### SUB-VH: Subagente Verificador Humano

| Campo | Valor |
|-------|-------|
| **Nombre** | SUB-VH (Verificador Humano) |
| **PropÃ³sito** | Gestionar cola de documentos con clasificaciÃ³n incierta |
| **Owner** | Equipo QA |
| **Responsable Operativo** | Analista de Datos |
| **Entradas** | Documentos con confidence < 0.7 |
| **Salidas** | ClasificaciÃ³n validada manualmente |
| **SLA** | RevisiÃ³n en < 24 horas |
| **UI** | Panel de revisiÃ³n con documento + clasificaciÃ³n sugerida + opciones |

#### SUB-RES: Subagente Resumidor

| Campo | Valor |
|-------|-------|
| **Nombre** | SUB-RES (Resumidor AutomÃ¡tico) |
| **PropÃ³sito** | Generar resÃºmenes ejecutivos de documentos |
| **Owner** | Equipo IA |
| **Responsable Operativo** | ML Engineer |
| **Entradas** | Texto completo del documento |
| **Salidas** | Resumen de 200-500 palabras |
| **SLA** | GeneraciÃ³n < 10 segundos |
| **Modelo** | Claude 3 Haiku (costo-eficiente) |

#### SUB-COMP: Subagente Compliance

| Campo | Valor |
|-------|-------|
| **Nombre** | SUB-COMP (Compliance Monitor) |
| **PropÃ³sito** | Verificar niveles de confidencialidad, detectar PII, cumplimiento regulatorio |
| **Owner** | Equipo Legal |
| **Responsable Operativo** | Oficial de Cumplimiento |
| **Entradas** | Documento + metadata |
| **Salidas** | Flag compliance, alertas si hay violaciones |
| **SLA** | VerificaciÃ³n en tiempo real (< 2 segundos) |
| **Reglas** | DetecciÃ³n de RFC, CURP, datos bancarios sin cifrar |

---

## PLAN DE PRUEBAS

### Casos de Prueba de Flujo de InformaciÃ³n

#### CP-001: Ingesta exitosa de PDF con texto

| Campo | Valor |
|-------|-------|
| **ID** | CP-001 |
| **Nombre** | Ingesta exitosa de PDF con texto |
| **Precondiciones** | Sistema operativo, usuario autenticado con rol admin |
| **Pasos** | 1. POST /api/repository/ingest con PDF de 10 pÃ¡ginas (polÃ­tica de gastos)<br>2. Esperar respuesta 202<br>3. GET /api/repository/jobs/{job_id}/status cada 5s<br>4. Verificar estado final "completado" |
| **Datos de entrada** | politica_gastos_test.pdf (245KB), metadata: {tipo_documento: "politica"} |
| **Resultado esperado** | Job completa en < 30s, documento almacenado en /empresa/politicas/, metadata completa, embeddings generados (vector_ids presentes) |
| **Criterio de Ã©xito** | Estado = "completado", ruta_repositorio != null, vector_ids.length > 0 |

#### CP-002: Ingesta con OCR de imagen escaneada

| Campo | Valor |
|-------|-------|
| **ID** | CP-002 |
| **Nombre** | Ingesta con OCR de imagen escaneada |
| **Precondiciones** | Sistema operativo, Tesseract disponible |
| **Pasos** | 1. POST /api/repository/ingest con imagen PNG de CSF escaneado<br>2. Verificar que se activa pipeline OCR<br>3. Validar extracciÃ³n de RFC del documento |
| **Datos de entrada** | csf_escaneado.png (1.2MB), forzar_ocr: true |
| **Resultado esperado** | Texto extraÃ­do contiene RFC vÃ¡lido, clasificado como "clientes/expediente", tiempo < 45s |
| **Criterio de Ã©xito** | entidades_extraidas.rfc contiene al menos 1 RFC vÃ¡lido |

#### CP-003: ClasificaciÃ³n automÃ¡tica con alta confianza

| Campo | Valor |
|-------|-------|
| **ID** | CP-003 |
| **Nombre** | ClasificaciÃ³n automÃ¡tica con alta confianza |
| **Precondiciones** | Documento procesado por A-ING |
| **Pasos** | 1. Documento de normativa SAT entra a cola_clasificacion<br>2. A-CLAS procesa y clasifica<br>3. Verificar clasificaciÃ³n y ruta asignada |
| **Datos de entrada** | CFF_articulo_5A.pdf, texto sobre razÃ³n de negocios |
| **Resultado esperado** | categoria_principal: "fiscal/normativa_sat", confidence_score > 0.85, requiere_revision: false |
| **Criterio de Ã©xito** | ClasificaciÃ³n correcta sin intervenciÃ³n humana |

#### CP-004: ClasificaciÃ³n con baja confianza â†’ RevisiÃ³n humana

| Campo | Valor |
|-------|-------|
| **ID** | CP-004 |
| **Nombre** | ClasificaciÃ³n con baja confianza deriva a revisiÃ³n humana |
| **Precondiciones** | Sistema operativo |
| **Pasos** | 1. Ingestar documento ambiguo (memo interno que menciona temas fiscales y operativos)<br>2. A-CLAS clasifica con confidence < 0.7<br>3. Verificar que entra a cola_revision_humana<br>4. Verificar notificaciÃ³n Slack |
| **Datos de entrada** | memo_ambiguo.docx |
| **Resultado esperado** | requiere_revision: true, registro en cola_revision_humana, notificaciÃ³n enviada |
| **Criterio de Ã©xito** | Documento NO se almacena en ruta final hasta validaciÃ³n humana |

#### CP-005: SincronizaciÃ³n a Pcloud de mÃºltiples agentes

| Campo | Valor |
|-------|-------|
| **ID** | CP-005 |
| **Nombre** | SincronizaciÃ³n a Pcloud de mÃºltiples agentes |
| **Precondiciones** | Documento clasificado como fiscal/normativa_sat |
| **Pasos** | 1. A-SYNC recibe evento con agentes_destino: [A3_Fiscal, A4_Legal]<br>2. Verificar copia en /pcloud/A3_Fiscal/kb/<br>3. Verificar copia en /pcloud/A4_Legal/kb/<br>4. Verificar metadata.ruta_pcloud actualizada |
| **Datos de entrada** | Documento clasificado con id doc_test_005 |
| **Resultado esperado** | Archivo existe en ambas rutas pcloud, metadata contiene ambas referencias |
| **Criterio de Ã©xito** | Ambos agentes pueden acceder al documento |

#### CP-006: Query RAG con resultados relevantes

| Campo | Valor |
|-------|-------|
| **ID** | CP-006 |
| **Nombre** | Query RAG retorna contexto relevante |
| **Precondiciones** | Al menos 10 documentos indexados incluyendo normativa SAT |
| **Pasos** | 1. POST /api/repository/query_rag con query sobre Art. 5-A CFF<br>2. Medir latencia<br>3. Verificar fuentes retornadas<br>4. Validar relevancia del contexto |
| **Datos de entrada** | query: "Â¿QuÃ© requisitos establece el artÃ­culo 5-A del CFF para la razÃ³n de negocios?" |
| **Resultado esperado** | Latencia < 2s, al menos 3 fuentes relevantes, contexto_aumentado menciona Art. 5-A |
| **Criterio de Ã©xito** | Fuente principal es documento de CFF, score_similaridad > 0.8 |

#### CP-007: Query RAG sin resultados (tema no indexado)

| Campo | Valor |
|-------|-------|
| **ID** | CP-007 |
| **Nombre** | Query RAG maneja correctamente tema no indexado |
| **Precondiciones** | Base de conocimiento sin documentos sobre criptomonedas |
| **Pasos** | 1. POST /api/repository/query_rag sobre tratamiento fiscal de criptomonedas<br>2. Verificar respuesta |
| **Datos de entrada** | query: "Â¿CuÃ¡l es el tratamiento fiscal de Bitcoin en MÃ©xico?" |
| **Resultado esperado** | Respuesta indica que no hay informaciÃ³n suficiente, fuentes vacÃ­as o con score < 0.5 |
| **Criterio de Ã©xito** | Sistema no inventa informaciÃ³n, indica claramente la ausencia de datos |

#### CP-008: Re-indexaciÃ³n forzada de documento modificado

| Campo | Valor |
|-------|-------|
| **ID** | CP-008 |
| **Nombre** | Re-indexaciÃ³n forzada actualiza embeddings |
| **Precondiciones** | Documento existente con embeddings generados |
| **Pasos** | 1. Modificar documento (nueva versiÃ³n)<br>2. POST /api/repository/reindex con documento_id<br>3. Verificar nuevos vector_ids<br>4. Query RAG debe retornar nueva versiÃ³n |
| **Datos de entrada** | documento_id: doc_test_008, opciones: {regenerar_embeddings: true} |
| **Resultado esperado** | vector_ids actualizados, versiÃ³n anterior en versiones_anteriores[], query retorna contenido actualizado |
| **Criterio de Ã©xito** | Embeddings antiguos eliminados, nuevos indexados |

### Scripts de Prueba CLI

```bash
#!/bin/bash
# test_repository_flow.sh

API_BASE="https://revisar-ia.replit.app/api/repository"
TOKEN="Bearer $REVISAR_TOKEN"

echo "=== CP-001: Ingesta de PDF ==="
RESPONSE=$(curl -s -X POST "$API_BASE/ingest" \
  -H "Authorization: $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "archivo": "'$(base64 -w0 test_files/politica_gastos.pdf)'",
    "nombre_archivo": "politica_gastos_test.pdf",
    "metadata_inicial": {
      "titulo": "PolÃ­tica de Gastos Test",
      "tipo_documento": "politica",
      "nivel_confidencialidad": "interno"
    }
  }')

JOB_ID=$(echo $RESPONSE | jq -r '.job_id')
DOC_ID=$(echo $RESPONSE | jq -r '.documento_id')
echo "Job ID: $JOB_ID"
echo "Documento ID: $DOC_ID"

# Esperar procesamiento
echo "Esperando procesamiento..."
for i in {1..10}; do
  sleep 3
  STATUS=$(curl -s "$API_BASE/jobs/$JOB_ID/status" -H "Authorization: $TOKEN")
  ESTADO=$(echo $STATUS | jq -r '.estado')
  echo "Estado: $ESTADO"
  if [ "$ESTADO" == "completado" ]; then
    echo "âœ… CP-001 PASSED: Documento procesado exitosamente"
    break
  fi
  if [ "$ESTADO" == "error" ]; then
    echo "âŒ CP-001 FAILED: Error en procesamiento"
    exit 1
  fi
done

echo ""
echo "=== CP-006: Query RAG ==="
RAG_RESPONSE=$(curl -s -X POST "$API_BASE/query_rag" \
  -H "Authorization: $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "query": "Â¿CuÃ¡les son los requisitos para deducir gastos de viaje?",
    "agente_solicitante": "A3_Fiscal",
    "parametros_busqueda": {
      "top_k": 5,
      "threshold_similaridad": 0.7
    }
  }')

LATENCIA=$(echo $RAG_RESPONSE | jq -r '.latencia_ms')
NUM_FUENTES=$(echo $RAG_RESPONSE | jq '.fuentes | length')

echo "Latencia: ${LATENCIA}ms"
echo "Fuentes encontradas: $NUM_FUENTES"

if [ "$LATENCIA" -lt 2000 ] && [ "$NUM_FUENTES" -gt 0 ]; then
  echo "âœ… CP-006 PASSED: Query RAG exitoso"
else
  echo "âŒ CP-006 FAILED: Latencia o fuentes fuera de SLA"
fi

echo ""
echo "=== CP-008: Re-indexaciÃ³n ==="
REINDEX_RESPONSE=$(curl -s -X POST "$API_BASE/reindex" \
  -H "Authorization: $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "documento_ids": ["'$DOC_ID'"],
    "opciones": {
      "regenerar_embeddings": true,
      "actualizar_resumen": true
    }
  }')

REINDEX_JOB=$(echo $REINDEX_RESPONSE | jq -r '.job_id')
echo "Re-index Job: $REINDEX_JOB"

if [ "$REINDEX_JOB" != "null" ]; then
  echo "âœ… CP-008 PASSED: Re-indexaciÃ³n iniciada"
else
  echo "âŒ CP-008 FAILED: Error al iniciar re-indexaciÃ³n"
fi
```

---

## MÃ‰TRICAS, SLOs Y ALERTAS

### MÃ©tricas de Pipeline

| MÃ©trica | DescripciÃ³n | SLO | Alerta CrÃ­tica |
|---------|-------------|-----|----------------|
| `ingesta_latency_p95` | Latencia P95 de ingesta | < 30s | > 60s por 5 min |
| `ingesta_success_rate` | Tasa de Ã©xito de ingesta | > 99% | < 95% por 15 min |
| `clasificacion_precision` | PrecisiÃ³n de clasificaciÃ³n automÃ¡tica | > 85% | < 75% (revisiÃ³n semanal) |
| `clasificacion_recall` | Recall de clasificaciÃ³n | > 80% | < 70% (revisiÃ³n semanal) |
| `clasificacion_f1` | F1-score de clasificaciÃ³n | > 82% | < 72% |
| `rag_latency_p95` | Latencia P95 de queries RAG | < 2s | > 4s por 5 min |
| `rag_recall_at_5` | Recall@5 en evaluaciÃ³n | > 0.8 | < 0.6 (revisiÃ³n mensual) |
| `rag_mrr` | Mean Reciprocal Rank | > 0.7 | < 0.5 |
| `sync_pcloud_latency` | Latencia de sync a pcloud | < 5s | > 15s por 5 min |
| `queue_depth_clasificacion` | Profundidad cola clasificaciÃ³n | < 100 | > 500 |
| `queue_depth_revision_humana` | Docs pendientes revisiÃ³n | < 50 | > 200 |
| `vector_db_latency_p95` | Latencia P95 bÃºsqueda vectorial | < 100ms | > 300ms |
| `storage_usage_percent` | Uso de almacenamiento | < 80% | > 90% |

### ConfiguraciÃ³n de Alertas

```yaml
# alertmanager/alerts.yaml

groups:
  - name: revisar_ia_repository
    rules:
      - alert: IngestaLatenciaAlta
        expr: histogram_quantile(0.95, ingesta_latency_seconds_bucket) > 60
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Latencia de ingesta muy alta"
          description: "P95 de ingesta > 60s por mÃ¡s de 5 minutos"
          
      - alert: RAGLatenciaAlta
        expr: histogram_quantile(0.95, rag_query_latency_seconds_bucket) > 4
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Latencia de RAG muy alta"
          description: "P95 de queries RAG > 4s por mÃ¡s de 5 minutos"
          
      - alert: ColaRevisionHumanaAlta
        expr: queue_depth_revision_humana > 200
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: "Cola de revisiÃ³n humana acumulada"
          description: "MÃ¡s de 200 documentos pendientes de revisiÃ³n"
          
      - alert: VectorDBNoDisponible
        expr: up{job="vector_db"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Vector DB no disponible"
          description: "Pinecone/Milvus no responde"
```

---

## ROADMAP DE IMPLEMENTACIÃ“N

### Sprint 1 (Semanas 1-2): Infraestructura Base

| Ã‰pica | Tarea | EstimaciÃ³n | Responsable | Entregable |
|-------|-------|------------|-------------|------------|
| Infra | Configurar Pinecone index | 4h | SRE | Index "revisar-ia-knowledge" creado |
| Infra | Configurar PostgreSQL para metadata | 4h | DBA | Schema de metadatos migrado |
| Infra | Setup storage S3/compatible | 2h | SRE | Buckets configurados con polÃ­ticas |
| Backend | Endpoint POST /ingest (bÃ¡sico) | 8h | Backend Sr. | Endpoint recibe archivos |
| Backend | Endpoint GET /browse | 6h | Backend Sr. | NavegaciÃ³n de repositorio |
| Backend | Modelo de datos y migraciones | 8h | Backend Sr. | Tablas creadas |
| Frontend | UI de carga drag-drop | 12h | Frontend Sr. | Componente funcional |
| Frontend | Vista explorador de archivos | 8h | Frontend Sr. | NavegaciÃ³n tipo carpetas |

**Entregable Sprint 1:** Usuario puede subir archivos y verlos en estructura de carpetas. Sin procesamiento automÃ¡tico aÃºn.

### Sprint 2 (Semanas 3-4): Pipeline de Ingesta

| Ã‰pica | Tarea | EstimaciÃ³n | Responsable | Entregable |
|-------|-------|------------|-------------|------------|
| Agente | Implementar A-ING extractor texto | 12h | ML Engineer | ExtracciÃ³n PDF/DOCX/XLSX |
| Agente | Integrar Tesseract OCR | 8h | ML Engineer | OCR funcional para imÃ¡genes |
| Agente | NormalizaciÃ³n y validaciÃ³n | 6h | ML Engineer | Texto UTF-8 normalizado |
| Backend | Sistema de colas (Bull/Redis) | 8h | Backend Sr. | Jobs asÃ­ncronos funcionando |
| Backend | Webhooks de status | 4h | Backend Sr. | Polling de estado de jobs |
| IntegraciÃ³n | Pruebas E2E ingesta | 8h | QA | CP-001 y CP-002 pasando |

**Entregable Sprint 2:** Documentos subidos se procesan automÃ¡ticamente, se extrae texto. Usuario ve estado del procesamiento.

### Sprint 3 (Semanas 5-6): ClasificaciÃ³n y RAG MVP

| Ã‰pica | Tarea | EstimaciÃ³n | Responsable | Entregable |
|-------|-------|------------|-------------|------------|
| Agente | Implementar A-CLAS con Claude | 16h | ML Engineer | ClasificaciÃ³n automÃ¡tica |
| Agente | TaxonomÃ­a fiscal y routing | 8h | Especialista Fiscal | Reglas de clasificaciÃ³n |
| Agente | Cola revisiÃ³n humana | 6h | Backend Sr. | UI de revisiÃ³n |
| RAG | Chunking y embeddings | 12h | ML Engineer | Documentos indexados |
| RAG | Implementar A-RAG bÃ¡sico | 12h | ML Engineer | Query endpoint funcional |
| RAG | Re-ranking con Cohere | 6h | ML Engineer | Mejora de relevancia |
| IntegraciÃ³n | Conectar agentes A1-A7 con RAG | 8h | Backend Sr. | Agentes usan contexto |
| Testing | Pruebas E2E completas | 12h | QA | CP-001 a CP-008 pasando |

**Entregable Sprint 3:** MVP completo. Documentos se clasifican automÃ¡ticamente, se indexan, y agentes fiscales pueden hacer queries RAG.

### Sprint 4 (Semanas 7-8): Pcloud y OptimizaciÃ³n

| Ã‰pica | Tarea | EstimaciÃ³n | Responsable | Entregable |
|-------|-------|------------|-------------|------------|
| Agente | Implementar A-SYNC pcloud | 10h | Backend Sr. | SincronizaciÃ³n por agente |
| Subagente | SUB-RES resumidor | 8h | ML Engineer | ResÃºmenes automÃ¡ticos |
| Subagente | SUB-COMP compliance | 6h | Backend Sr. | DetecciÃ³n PII |
| Performance | OptimizaciÃ³n latencia RAG | 8h | ML Engineer | P95 < 1.5s |
| Monitoring | Dashboards Grafana | 6h | SRE | MÃ©tricas visibles |
| Docs | DocumentaciÃ³n tÃ©cnica | 8h | Tech Writer | GuÃ­a de operaciÃ³n |

**Entregable Sprint 4:** Sistema completo con pcloud por agente, subagentes de soporte, y monitoreo.

---

## CHECKLIST OPERATIVO PARA LANZAMIENTO

### Seguridad

- [ ] Cifrado en reposo habilitado (AES-256) para storage
- [ ] Cifrado en trÃ¡nsito (TLS 1.3) para todas las comunicaciones
- [ ] MFA habilitado para acceso a panel de administraciÃ³n
- [ ] RBAC configurado con principio de mÃ­nimo privilegio
- [ ] Logging inmutable configurado (append-only)
- [ ] RotaciÃ³n de claves API configurada (90 dÃ­as)
- [ ] AuditorÃ­a de accesos habilitada
- [ ] Escaneo de vulnerabilidades ejecutado (sin crÃ­ticas)
- [ ] PolÃ­ticas de retenciÃ³n de logs configuradas (1 aÃ±o)
- [ ] Backup diario configurado y probado

### Infraestructura

- [ ] Vector DB (Pinecone) configurado y funcionando
- [ ] PostgreSQL replicado y con backups
- [ ] Redis para colas configurado
- [ ] Storage con redundancia
- [ ] CDN para assets estÃ¡ticos
- [ ] Rate limiting configurado
- [ ] Auto-scaling configurado para picos
- [ ] Health checks en todos los servicios

### AplicaciÃ³n

- [ ] Todos los endpoints API documentados
- [ ] ValidaciÃ³n de inputs en todos los endpoints
- [ ] Manejo de errores consistente
- [ ] Timeouts configurados apropiadamente
- [ ] Circuit breakers para dependencias externas
- [ ] Feature flags para rollout gradual

### Monitoreo

- [ ] MÃ©tricas de negocio en Grafana
- [ ] Alertas configuradas en PagerDuty/Slack
- [ ] Tracing distribuido (OpenTelemetry)
- [ ] Logs centralizados (ELK/CloudWatch)
- [ ] SLOs definidos y medidos
- [ ] Runbooks para incidentes comunes

### Testing

- [ ] Tests unitarios con cobertura > 80%
- [ ] Tests de integraciÃ³n pasando
- [ ] Tests E2E (CP-001 a CP-008) pasando
- [ ] Load testing ejecutado (1000 docs/hora)
- [ ] Chaos testing ejecutado
- [ ] Pen testing completado

### DocumentaciÃ³n

- [ ] GuÃ­a de usuario final
- [ ] DocumentaciÃ³n tÃ©cnica de API
- [ ] Runbooks operativos
- [ ] Diagrama de arquitectura actualizado
- [ ] Procedimientos de DR documentados

---

## ARCHIVOS DE EJEMPLO

### Ejemplo de Metadata Completa (JSON)

```json
{
  "id": "doc_prod_001",
  "titulo": "CÃ³digo Fiscal de la FederaciÃ³n 2024",
  "tipo_documento": "normativa",
  "subtipo": "legislacion_federal",
  "formato": "pdf",
  "origen": "upload_manual",
  "propietario_organico": "equipo_fiscal",
  "autor": "H. Congreso de la UniÃ³n",
  "tags": ["CFF", "2024", "legislacion", "SAT", "obligaciones_fiscales"],
  "nivel_confidencialidad": "publico",
  "fecha_creacion": "2024-01-01T00:00:00Z",
  "fecha_modificacion": "2024-01-01T00:00:00Z",
  "fecha_revision": "2025-01-01T00:00:00Z",
  "fecha_expiracion": null,
  "version": "1.0",
  "versiones_anteriores": [],
  "checksum_sha256": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
  "tamano_bytes": 2456789,
  "paginas": 342,
  "idioma": "es",
  "ruta_repositorio": "/fiscal/normativa_sat/NORM_CFF_20240101_v1.pdf",
  "ruta_pcloud": {
    "A3_Fiscal": "/pcloud/A3_Fiscal/kb/normativa/CFF_2024.pdf",
    "A4_Legal": "/pcloud/A4_Legal/kb/normativa/CFF_2024.pdf",
    "A7_Defense": "/pcloud/A7_Defense/kb/normativa/CFF_2024.pdf"
  },
  "vector_ids": ["vec_cff_001", "vec_cff_002", "vec_cff_003", "vec_cff_004"],
  "clasificacion": {
    "categoria_principal": "fiscal",
    "subcategoria": "normativa_sat",
    "categorias_secundarias": ["legal"],
    "confidence_score": 0.98,
    "clasificado_por": "A-CLAS",
    "fecha_clasificacion": "2024-01-02T10:30:00Z",
    "requiere_revision": false
  },
  "entidades_extraidas": {
    "montos": [],
    "fechas": ["2024-01-01"],
    "personas": [],
    "organizaciones": ["SAT", "SHCP", "H. Congreso"],
    "rfc": [],
    "articulos_mencionados": ["Art. 5-A", "Art. 69-B", "Art. 42"]
  },
  "resumen_automatico": "El CÃ³digo Fiscal de la FederaciÃ³n 2024 establece el marco normativo para las obligaciones fiscales en MÃ©xico, incluyendo procedimientos de auditorÃ­a, sanciones, y recursos legales disponibles para los contribuyentes.",
  "permisos": {
    "lectura": ["*"],
    "escritura": ["admin"],
    "eliminacion": ["admin"]
  },
  "compliance": {
    "revisado": true,
    "nivel_riesgo": "ninguno",
    "pii_detectado": false,
    "notas": null
  },
  "metricas_uso": {
    "consultas_rag": 156,
    "ultima_consulta": "2024-01-20T14:30:00Z",
    "agentes_que_consultaron": ["A3_Fiscal", "A4_Legal", "A7_Defense"]
  },
  "audit_trail": [
    {
      "accion": "creado",
      "timestamp": "2024-01-02T10:00:00Z",
      "usuario": "admin@revisar-ia.com",
      "ip": "10.0.1.50"
    },
    {
      "accion": "indexado",
      "timestamp": "2024-01-02T10:05:00Z",
      "usuario": "sistema",
      "detalles": "4 chunks indexados en Pinecone"
    }
  ]
}
```

### Payload de Prueba 1: Ingesta de PolÃ­tica Interna

```json
{
  "archivo": "JVBERi0xLjcKJeLjz9MKNSAwIG9...(base64 truncado)",
  "nombre_archivo": "politica_viajes_2024.pdf",
  "metadata_inicial": {
    "titulo": "PolÃ­tica de Viajes y ViÃ¡ticos 2024",
    "tipo_documento": "politica",
    "propietario_organico": "direccion_finanzas",
    "autor": "CFO",
    "nivel_confidencialidad": "interno",
    "tags": ["viajes", "viaticos", "gastos", "politica"]
  },
  "opciones": {
    "forzar_ocr": false,
    "generar_resumen": true,
    "notificar_agentes": ["A3_Fiscal", "A5_Finanzas"]
  }
}
```

### Payload de Prueba 2: Query RAG para DiagnÃ³stico

```json
{
  "query": "Â¿QuÃ© documentos requiere el SAT para demostrar la materialidad de una operaciÃ³n segÃºn el artÃ­culo 69-B del CFF?",
  "agente_solicitante": "A3_Fiscal",
  "contexto_proyecto": {
    "proyecto_id": "proj_diag_2024_001",
    "cliente_rfc": "ABC123456XYZ",
    "cliente_nombre": "Empresa ABC S.A. de C.V.",
    "fase_actual": "F3_analisis_fiscal",
    "proveedor_rfc": "XYZ987654ABC",
    "monto_operacion": 5000000,
    "tipo_intangible": "licencia_software"
  },
  "parametros_busqueda": {
    "top_k": 5,
    "threshold_similaridad": 0.75,
    "filtros": {
      "tipo_documento": ["normativa", "criterios_juridicos", "casos_precedentes"],
      "fecha_creacion_min": "2020-01-01"
    },
    "incluir_fuentes": true,
    "boost": {
      "casos_exitosos": 1.3
    }
  }
}
```

### Payload de Prueba 3: Re-indexaciÃ³n Masiva

```json
{
  "documento_ids": [
    "doc_norm_cff_2024",
    "doc_norm_lisr_2024",
    "doc_norm_liva_2024",
    "doc_rmf_2024"
  ],
  "opciones": {
    "regenerar_embeddings": true,
    "recalcular_clasificacion": false,
    "actualizar_resumen": true,
    "chunk_config_override": {
      "chunk_size": 1024,
      "chunk_overlap": 100,
      "preserve_structure": true
    }
  },
  "notificaciones": {
    "webhook_completado": "https://revisar-ia.com/webhooks/reindex-complete",
    "email": "admin@revisar-ia.com"
  }
}
```

---

## COSTOS ESTIMADOS (10K requests/mes)

| Servicio | OpciÃ³n | Costo/mes | Pros | Cons |
|----------|--------|-----------|------|------|
| **Embeddings** | OpenAI text-embedding-3-small | ~$10 | Alta calidad, fÃ¡cil integraciÃ³n | Dependencia externa |
| | Cohere embed-multilingual-v3 | ~$8 | Mejor espaÃ±ol, mÃ¡s econÃ³mico | Menor precisiÃ³n tÃ©cnica |
| | Self-hosted (sentence-transformers) | $0 (+ infra) | Sin costo por request | Requiere GPU, mantenimiento |
| **Vector DB** | Pinecone Starter | $70 | Managed, escalable | Costo fijo |
| | Milvus self-hosted | ~$150 (EC2) | Control total | Mantenimiento manual |
| | Qdrant Cloud | $25 | EconÃ³mico | Menor ecosistema |
| **Re-ranking** | Cohere Rerank | ~$5 | Mejora significativa relevancia | Latencia adicional |
| | Self-hosted (cross-encoder) | $0 (+ infra) | Sin costo | Menor calidad |
| **LLM (ClasificaciÃ³n)** | Claude 3 Haiku | ~$15 | Buena relaciÃ³n costo/calidad | - |
| | GPT-4o-mini | ~$12 | Muy econÃ³mico | - |
| **Storage** | S3 Standard | ~$5 (100GB) | Confiable | - |
| **Total estimado** | OpciÃ³n SaaS completa | ~$115/mes | - | - |
| | OpciÃ³n hÃ­brida | ~$80/mes | - | - |

---

## CONCLUSIÃ“N

Este documento especifica un sistema completo de repositorio de conocimiento para Revisar.IA que reemplaza la interfaz chat inoperativa por un modelo de almacenamiento jerÃ¡rquico tipo "disco duro". La arquitectura incluye cuatro agentes principales (Ingesta, ClasificaciÃ³n, Sync Pcloud, RAG) y tres subagentes de soporte, con un pipeline RAG completo que permite a los agentes fiscales A1-A7 acceder a conocimiento corporativo indexado.

El MVP puede entregarse en 6 semanas (3 sprints de 2 semanas), con capacidad de procesar documentos en menos de 30 segundos y responder queries RAG en menos de 2 segundos.

---

*Documento generado para implementaciÃ³n en Replit*
*VersiÃ³n: 1.0*
*Fecha: Enero 2024*