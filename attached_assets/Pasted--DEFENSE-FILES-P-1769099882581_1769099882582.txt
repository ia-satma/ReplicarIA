â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“ DEFENSE FILES - PARTE 5: VERIFICACIONES Y RESUMEN FINAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Esta parte consolida todo y proporciona pruebas completas.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
RESUMEN DE ARCHIVOS A CREAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

```
backend/
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ defense_files/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ defense_file_service.py     # Parte 2
â”‚   â”‚   â”œâ”€â”€ decorators.py               # Parte 3
â”‚   â”‚   â””â”€â”€ agent_helper.py             # Parte 3
â”‚   â”‚
â”‚   â””â”€â”€ pcloud/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ pcloud_service.py           # Parte 4
â”‚
â”œâ”€â”€ routes/
â”‚   â””â”€â”€ defense_file_routes.py          # Parte 4
â”‚
â””â”€â”€ utils/
    â””â”€â”€ extractors.py                   # Parte 3

frontend/src/components/DefenseFiles/
â”œâ”€â”€ DefenseFilesList.jsx                # Parte 4
â””â”€â”€ DefenseFileDetail.jsx               # Parte 4
```

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SCRIPT DE VERIFICACIÃ“N Y PRUEBAS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Crear: backend/tests/test_defense_files.py

```python
#!/usr/bin/env python3
"""
Tests completos para el sistema de Defense Files
Ejecutar: python backend/tests/test_defense_files.py
"""

import os
import sys
import json
import requests
from datetime import datetime

# Agregar path del proyecto
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

BASE_URL = os.environ.get('APP_URL', 'http://localhost:5000')


def test_crear_defense_file():
    """Test 1: Crear un Defense File"""
    print("\nğŸ§ª TEST 1: Crear Defense File...")
    
    # Primero necesitamos un cliente
    # Asumimos que existe uno con ID 1, o creamos uno
    
    response = requests.post(
        f'{BASE_URL}/api/defense-files',
        json={
            'cliente_id': 1,
            'nombre': 'Test AuditorÃ­a Q1 2025',
            'ejercicio': 2025,
            'tipo_proyecto': 'auditoria',
            'descripcion': 'Defense File de prueba'
        },
        timeout=30
    )
    
    if response.status_code in [200, 201]:
        data = response.json()
        if data.get('success') and data.get('defense_file'):
            df = data['defense_file']
            print(f"   âœ… PASS - Defense File creado: {df.get('codigo')}")
            return df.get('id')
        else:
            print(f"   âŒ FAIL - Respuesta inesperada: {data}")
            return None
    else:
        print(f"   âŒ FAIL - HTTP {response.status_code}: {response.text[:200]}")
        return None


def test_listar_defense_files():
    """Test 2: Listar Defense Files"""
    print("\nğŸ§ª TEST 2: Listar Defense Files...")
    
    response = requests.get(f'{BASE_URL}/api/defense-files', timeout=10)
    
    if response.status_code == 200:
        data = response.json()
        if data.get('success'):
            total = data.get('total', 0)
            print(f"   âœ… PASS - {total} Defense Files encontrados")
            return True
    
    print(f"   âŒ FAIL - HTTP {response.status_code}")
    return False


def test_obtener_defense_file(df_id):
    """Test 3: Obtener Defense File especÃ­fico"""
    print(f"\nğŸ§ª TEST 3: Obtener Defense File {df_id}...")
    
    response = requests.get(f'{BASE_URL}/api/defense-files/{df_id}', timeout=10)
    
    if response.status_code == 200:
        data = response.json()
        if data.get('success') and data.get('defense_file'):
            df = data['defense_file']
            print(f"   âœ… PASS - {df.get('codigo')}: {df.get('nombre')}")
            return True
    
    print(f"   âŒ FAIL - HTTP {response.status_code}")
    return False


def test_registrar_evento(df_id):
    """Test 4: Registrar evento en Defense File"""
    print(f"\nğŸ§ª TEST 4: Registrar evento...")
    
    # Usamos el servicio directamente ya que no hay endpoint pÃºblico
    # En producciÃ³n, los eventos se registran automÃ¡ticamente via los agentes
    
    try:
        from services.defense_files.defense_file_service import (
            defense_file_service, EventoDefenseFile
        )
        
        evento_id = defense_file_service.registrar_evento(
            defense_file_id=df_id,
            evento=EventoDefenseFile(
                tipo='conversacion_ia',
                agente_id='A1',
                titulo='ConversaciÃ³n de prueba con Facturar.IA',
                descripcion='Usuario preguntÃ³ sobre deducibilidad de gastos',
                datos={
                    'mensaje_usuario': 'Â¿Puedo deducir gastos de gasolina?',
                    'respuesta_ia': 'SÃ­, segÃºn el artÃ­culo 27 de la LISR...',
                    'test': True
                },
                usuario_email='test@example.com',
                tags=['test', 'facturar', 'deduccion']
            )
        )
        
        if evento_id:
            print(f"   âœ… PASS - Evento registrado con ID: {evento_id}")
            return True
        else:
            print(f"   âŒ FAIL - No se pudo registrar evento")
            return False
            
    except Exception as e:
        print(f"   âŒ FAIL - Error: {e}")
        return False


def test_obtener_timeline(df_id):
    """Test 5: Obtener timeline de eventos"""
    print(f"\nğŸ§ª TEST 5: Obtener timeline...")
    
    response = requests.get(
        f'{BASE_URL}/api/defense-files/{df_id}/timeline',
        timeout=10
    )
    
    if response.status_code == 200:
        data = response.json()
        if data.get('success'):
            eventos = data.get('eventos', [])
            print(f"   âœ… PASS - {len(eventos)} eventos en timeline")
            
            # Mostrar preview
            for evento in eventos[:3]:
                print(f"      â€¢ {evento.get('agente_nombre')}: {evento.get('titulo')[:40]}")
            
            return True
    
    print(f"   âŒ FAIL - HTTP {response.status_code}")
    return False


def test_registrar_tercero(df_id):
    """Test 6: Registrar verificaciÃ³n de tercero"""
    print(f"\nğŸ§ª TEST 6: Registrar tercero verificado...")
    
    try:
        from services.defense_files.defense_file_service import defense_file_service
        
        tercero_id = defense_file_service.registrar_tercero(
            defense_file_id=df_id,
            tipo='proveedor',
            rfc='XAXX010101000',
            razon_social='Proveedor de Prueba SA',
            verificacion_69b={'en_lista': False, 'estatus': None},
            verificacion_efos={'es_efos': False}
        )
        
        if tercero_id:
            print(f"   âœ… PASS - Tercero registrado: {tercero_id}")
            return True
            
    except Exception as e:
        print(f"   âŒ FAIL - Error: {e}")
    
    return False


def test_listar_terceros(df_id):
    """Test 7: Listar terceros"""
    print(f"\nğŸ§ª TEST 7: Listar terceros...")
    
    response = requests.get(
        f'{BASE_URL}/api/defense-files/{df_id}/terceros',
        timeout=10
    )
    
    if response.status_code == 200:
        data = response.json()
        if data.get('success'):
            terceros = data.get('terceros', [])
            alertas = data.get('con_alertas', 0)
            print(f"   âœ… PASS - {len(terceros)} terceros ({alertas} con alertas)")
            return True
    
    print(f"   âŒ FAIL - HTTP {response.status_code}")
    return False


def test_registrar_fundamento(df_id):
    """Test 8: Registrar fundamento legal"""
    print(f"\nğŸ§ª TEST 8: Registrar fundamento legal...")
    
    try:
        from services.defense_files.defense_file_service import defense_file_service
        
        fund_id = defense_file_service.registrar_fundamento(
            defense_file_id=df_id,
            tipo='ley',
            ordenamiento='LISR',
            articulo='27',
            titulo='Requisitos de las deducciones',
            texto_relevante='Las deducciones autorizadas deberÃ¡n reunir los requisitos...',
            contexto_uso='Citado para justificar deducibilidad de gastos'
        )
        
        if fund_id:
            print(f"   âœ… PASS - Fundamento registrado: {fund_id}")
            return True
            
    except Exception as e:
        print(f"   âŒ FAIL - Error: {e}")
    
    return False


def test_actualizar_estado(df_id):
    """Test 9: Actualizar estado"""
    print(f"\nğŸ§ª TEST 9: Actualizar estado...")
    
    response = requests.put(
        f'{BASE_URL}/api/defense-files/{df_id}/estado',
        json={'estado': 'revision', 'porcentaje': 50},
        timeout=10
    )
    
    if response.status_code == 200:
        data = response.json()
        if data.get('success'):
            print(f"   âœ… PASS - Estado actualizado a 'revision'")
            return True
    
    print(f"   âŒ FAIL - HTTP {response.status_code}")
    return False


def test_pcloud_status():
    """Test 10: Verificar configuraciÃ³n de pCloud"""
    print(f"\nğŸ§ª TEST 10: Verificar pCloud...")
    
    response = requests.get(f'{BASE_URL}/api/defense-files/pcloud-status', timeout=10)
    
    if response.status_code == 200:
        data = response.json()
        enabled = data.get('enabled', False)
        configured = data.get('configured', False)
        
        if enabled:
            print(f"   âœ… PASS - pCloud habilitado y configurado")
        elif configured:
            print(f"   âš ï¸ WARN - pCloud configurado pero no habilitado")
        else:
            print(f"   âš ï¸ WARN - pCloud no configurado (opcional)")
        
        return True
    
    print(f"   âŒ FAIL - HTTP {response.status_code}")
    return False


def main():
    """Ejecuta todos los tests"""
    
    print("=" * 60)
    print("ğŸ” TESTS DE DEFENSE FILES")
    print("=" * 60)
    
    resultados = []
    
    # Test 1: Crear Defense File
    df_id = test_crear_defense_file()
    resultados.append(('Crear Defense File', df_id is not None))
    
    if df_id:
        # Test 2: Listar
        resultados.append(('Listar Defense Files', test_listar_defense_files()))
        
        # Test 3: Obtener
        resultados.append(('Obtener Defense File', test_obtener_defense_file(df_id)))
        
        # Test 4: Registrar evento
        resultados.append(('Registrar Evento', test_registrar_evento(df_id)))
        
        # Test 5: Timeline
        resultados.append(('Obtener Timeline', test_obtener_timeline(df_id)))
        
        # Test 6: Registrar tercero
        resultados.append(('Registrar Tercero', test_registrar_tercero(df_id)))
        
        # Test 7: Listar terceros
        resultados.append(('Listar Terceros', test_listar_terceros(df_id)))
        
        # Test 8: Fundamento
        resultados.append(('Registrar Fundamento', test_registrar_fundamento(df_id)))
        
        # Test 9: Actualizar estado
        resultados.append(('Actualizar Estado', test_actualizar_estado(df_id)))
    
    # Test 10: pCloud
    resultados.append(('pCloud Status', test_pcloud_status()))
    
    # Resumen
    print("\n" + "=" * 60)
    print("ğŸ“Š RESUMEN")
    print("=" * 60)
    
    pasaron = sum(1 for _, ok in resultados if ok)
    total = len(resultados)
    
    for nombre, ok in resultados:
        print(f"   {'âœ…' if ok else 'âŒ'} {nombre}")
    
    print(f"\n   TOTAL: {pasaron}/{total} tests pasaron ({int(pasaron/total*100)}%)")
    
    if pasaron == total:
        print("\n   ğŸ‰ Â¡SISTEMA DE DEFENSE FILES FUNCIONAL!")
    elif pasaron >= total * 0.7:
        print("\n   âš ï¸ SISTEMA PARCIALMENTE FUNCIONAL")
    else:
        print("\n   ğŸ”´ SISTEMA CON PROBLEMAS - REVISAR")
    
    return pasaron == total


if __name__ == '__main__':
    # Configurar para importar mÃ³dulos del proyecto
    import sys
    sys.path.insert(0, 'backend')
    
    # Necesitamos contexto de Flask para usar la BD
    try:
        from app import app
        with app.app_context():
            success = main()
            sys.exit(0 if success else 1)
    except ImportError:
        # Sin Flask, solo tests de API
        main()
```

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PRUEBAS MANUALES CON CURL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

```bash
#!/bin/bash

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ğŸ§ª PRUEBAS DE DEFENSE FILES"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

BASE_URL="http://localhost:5000"

# 1. Crear Defense File
echo -e "\n=== TEST 1: Crear Defense File ==="
RESPONSE=$(curl -s -X POST "$BASE_URL/api/defense-files" \
  -H "Content-Type: application/json" \
  -d '{
    "cliente_id": 1,
    "nombre": "AuditorÃ­a Fiscal Test",
    "ejercicio": 2025,
    "tipo_proyecto": "auditoria"
  }')
echo $RESPONSE | jq .
DF_ID=$(echo $RESPONSE | jq -r '.defense_file.id')
echo "Defense File ID: $DF_ID"

# 2. Listar Defense Files
echo -e "\n=== TEST 2: Listar Defense Files ==="
curl -s "$BASE_URL/api/defense-files" | jq .

# 3. Obtener Defense File especÃ­fico
echo -e "\n=== TEST 3: Obtener Defense File $DF_ID ==="
curl -s "$BASE_URL/api/defense-files/$DF_ID" | jq .

# 4. Obtener Timeline
echo -e "\n=== TEST 4: Obtener Timeline ==="
curl -s "$BASE_URL/api/defense-files/$DF_ID/timeline" | jq .

# 5. Listar Terceros
echo -e "\n=== TEST 5: Listar Terceros ==="
curl -s "$BASE_URL/api/defense-files/$DF_ID/terceros" | jq .

# 6. Listar Fundamentos
echo -e "\n=== TEST 6: Listar Fundamentos ==="
curl -s "$BASE_URL/api/defense-files/$DF_ID/fundamentos" | jq .

# 7. Listar CÃ¡lculos
echo -e "\n=== TEST 7: Listar CÃ¡lculos ==="
curl -s "$BASE_URL/api/defense-files/$DF_ID/calculos" | jq .

# 8. Actualizar Estado
echo -e "\n=== TEST 8: Actualizar Estado ==="
curl -s -X PUT "$BASE_URL/api/defense-files/$DF_ID/estado" \
  -H "Content-Type: application/json" \
  -d '{"estado": "revision", "porcentaje": 50}' | jq .

# 9. Verificar pCloud
echo -e "\n=== TEST 9: pCloud Status ==="
curl -s "$BASE_URL/api/defense-files/pcloud-status" | jq .

# 10. Exportar
echo -e "\n=== TEST 10: Exportar JSON ==="
curl -s -X POST "$BASE_URL/api/defense-files/$DF_ID/exportar" \
  -H "Content-Type: application/json" \
  -d '{"formato": "json"}' | jq '.success, .data.defense_file.codigo'

echo -e "\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "âœ… PRUEBAS COMPLETADAS"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
```

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
CHECKLIST COMPLETO DE IMPLEMENTACIÃ“N
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## PARTE 1: Base de Datos
â–¡ Ejecutar SQL de tablas (defense_files, eventos, documentos, terceros, fundamentos, calculos)
â–¡ Verificar que las vistas se crearon (v_defense_file_resumen, v_defense_file_timeline)
â–¡ Verificar Ã­ndices

## PARTE 2: Servicio Core
â–¡ Crear backend/services/defense_files/__init__.py
â–¡ Crear backend/services/defense_files/defense_file_service.py
â–¡ Probar crear_defense_file() en shell Python

## PARTE 3: IntegraciÃ³n con Agentes
â–¡ Crear backend/services/defense_files/decorators.py
â–¡ Crear backend/services/defense_files/agent_helper.py
â–¡ Crear backend/utils/extractors.py
â–¡ Modificar facturar_routes.py para documentar
â–¡ Modificar biblioteca_routes.py para documentar
â–¡ Probar que las conversaciones se registran

## PARTE 4: API y Frontend
â–¡ Crear backend/services/pcloud/__init__.py
â–¡ Crear backend/services/pcloud/pcloud_service.py
â–¡ Crear backend/routes/defense_file_routes.py
â–¡ Registrar blueprint en main.py
â–¡ Crear frontend/src/components/DefenseFiles/DefenseFilesList.jsx
â–¡ Crear frontend/src/components/DefenseFiles/DefenseFileDetail.jsx
â–¡ Agregar rutas al router de React
â–¡ Configurar PCLOUD_ACCESS_TOKEN (opcional)

## PARTE 5: VerificaciÃ³n
â–¡ Ejecutar script de tests
â–¡ Verificar todos los endpoints con curl
â–¡ Verificar que el frontend muestra los Defense Files
â–¡ Verificar que los eventos se registran automÃ¡ticamente

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
INTEGRACIÃ“N EN EL FLUJO DE TRABAJO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Una vez implementado, el flujo es:

1. **Al crear un proyecto/entregable** â†’ Se crea automÃ¡ticamente un Defense File
   
2. **Cada interacciÃ³n con un agente** â†’ Se documenta automÃ¡ticamente:
   - Conversaciones con Facturar.IA â†’ Guardadas con CFDIs mencionados
   - Consultas a Bibliotecar.IA â†’ Guardadas con chunks/fuentes usadas
   - CÃ¡lculos de Calcular.IA â†’ Guardados con metodologÃ­a
   
3. **Verificaciones de terceros** â†’ Se documentan:
   - Validaciones de Lista 69-B
   - Verificaciones EFOS
   - Alertas generadas

4. **Fundamentos legales** â†’ Se extraen automÃ¡ticamente:
   - ArtÃ­culos citados en respuestas
   - Jurisprudencias aplicadas
   
5. **Al cerrar el proyecto** â†’ Se genera:
   - Hash de integridad de todo el expediente
   - Ãndice completo en pCloud
   - Defense File Final exportable

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EJEMPLO DE USO COMPLETO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

```python
from services.defense_files.defense_file_service import defense_file_service
from services.defense_files.agent_helper import facturar_doc, bibliotecar_doc

# 1. Crear Defense File al inicio del proyecto
df_id = defense_file_service.crear_defense_file(
    cliente_id=cliente.id,
    nombre="AuditorÃ­a Fiscal 2025",
    ejercicio=2025,
    tipo_proyecto="auditoria",
    responsable_id=usuario.id
)

# 2. En cada chat con Facturar.IA
facturar_doc.registrar_conversacion(
    defense_file_id=df_id,
    mensaje_usuario="Â¿Puedo deducir estos gastos?",
    respuesta_ia="SegÃºn el artÃ­culo 27...",
    usuario="cliente@empresa.com",
    cfdis_mencionados=["uuid-1", "uuid-2"],
    articulos_citados=[{"articulo": "27", "ley": "LISR"}]
)

# 3. Al analizar un CFDI
facturar_doc.registrar_cfdi_analizado(
    defense_file_id=df_id,
    uuid_cfdi="abc123-def456",
    rfc_emisor="XAXX010101000",
    rfc_receptor="CLIENTE010101ABC",
    total=50000.00,
    fecha_emision="2025-01-15",
    tipo_comprobante="Ingreso",
    resultado_analisis={...},
    alertas=[]
)

# 4. Al verificar un proveedor
facturar_doc.registrar_verificacion_tercero(
    defense_file_id=df_id,
    rfc="PROV010101AAA",
    razon_social="Proveedor SA",
    tipo_tercero="proveedor",
    verificacion_69b={"en_lista": False},
    verificacion_efos={"es_efos": False}
)

# 5. Al consultar Bibliotecar.IA
bibliotecar_doc.registrar_conversacion(
    defense_file_id=df_id,
    mensaje_usuario="Â¿QuÃ© dice el CFF sobre prescripciÃ³n?",
    respuesta_ia="SegÃºn el artÃ­culo 67 del CFF...",
    usuario="usuario@email.com",
    fuentes_consultadas=["CFF.pdf", "Jurisprudencia_2020.pdf"],
    contexto={"chunks_usados": 5}
)

# 6. Al cerrar el proyecto
defense_file_service.actualizar_estado(df_id, 'cerrado', 100)
# Esto calcula el hash de integridad automÃ¡ticamente
```

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
RESULTADO FINAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Con este sistema implementado:

âœ… CADA conversaciÃ³n queda documentada
âœ… CADA CFDI analizado queda registrado
âœ… CADA verificaciÃ³n de tercero queda guardada
âœ… CADA fundamento legal citado se extrae
âœ… CADA cÃ¡lculo fiscal se preserva
âœ… Timeline completo auditable
âœ… Hash de integridad para verificar que no se alterÃ³
âœ… SincronizaciÃ³n opcional con pCloud
âœ… ExportaciÃ³n para defense file final

Esto permite:
- Demostrar ante el SAT EXACTAMENTE quÃ© se hizo
- Evidenciar las fuentes legales consultadas
- Comprobar verificaciones de proveedores
- Reconstruir el proceso de anÃ¡lisis
- Defender las conclusiones con evidencia

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•